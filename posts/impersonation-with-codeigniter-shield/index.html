<!doctype html><html lang=en dir=auto data-theme=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Implementing User Impersonation in CodeIgniter Shield | michalsn</title><meta name=keywords content="codeigniter4,authentication,shield,security"><meta name=description content="Implement secure user impersonation in CodeIgniter 4 using the Shield authentication system and a modular architecture."><meta name=author content><link rel=canonical href=https://michalsn.dev/posts/impersonation-with-codeigniter-shield/><link crossorigin=anonymous href=/assets/css/stylesheet.343cc480b9ffc8f04ccbe5e968ad674880cab773ec19905e93033065c1e7a804.css integrity="sha256-NDzEgLn/yPBMy+XpaK1nSIDKt3PsGZBekwMwZcHnqAQ=" rel="preload stylesheet" as=style><link rel=icon href=https://michalsn.dev/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://michalsn.dev/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://michalsn.dev/favicon-32x32.png><link rel=apple-touch-icon href=https://michalsn.dev/apple-touch-icon.png><link rel=mask-icon href=https://michalsn.dev/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://michalsn.dev/posts/impersonation-with-codeigniter-shield/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51);color-scheme:dark}.list{background:var(--theme)}.toc{background:var(--entry)}}@media(prefers-color-scheme:light){.list::-webkit-scrollbar-thumb{border-color:var(--code-bg)}}</style></noscript><script>localStorage.getItem("pref-theme")==="dark"?document.querySelector("html").dataset.theme="dark":localStorage.getItem("pref-theme")==="light"?document.querySelector("html").dataset.theme="light":window.matchMedia("(prefers-color-scheme: dark)").matches?document.querySelector("html").dataset.theme="dark":document.querySelector("html").dataset.theme="light"</script><link rel=stylesheet href=/css/custom.css><script src=/js/custom.js></script><meta property="og:url" content="https://michalsn.dev/posts/impersonation-with-codeigniter-shield/"><meta property="og:site_name" content="michalsn"><meta property="og:title" content="Implementing User Impersonation in CodeIgniter Shield"><meta property="og:description" content="Implement secure user impersonation in CodeIgniter 4 using the Shield authentication system and a modular architecture."><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-07-02T20:10:32+01:00"><meta property="article:modified_time" content="2025-07-02T20:10:32+01:00"><meta property="article:tag" content="Codeigniter4"><meta property="article:tag" content="Authentication"><meta property="article:tag" content="Shield"><meta property="article:tag" content="Security"><meta property="og:image" content="https://michalsn.dev/posts/impersonation-with-codeigniter-shield/og.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://michalsn.dev/posts/impersonation-with-codeigniter-shield/og.png"><meta name=twitter:title content="Implementing User Impersonation in CodeIgniter Shield"><meta name=twitter:description content="Implement secure user impersonation in CodeIgniter 4 using the Shield authentication system and a modular architecture."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://michalsn.dev/posts/"},{"@type":"ListItem","position":2,"name":"Implementing User Impersonation in CodeIgniter Shield","item":"https://michalsn.dev/posts/impersonation-with-codeigniter-shield/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Implementing User Impersonation in CodeIgniter Shield","name":"Implementing User Impersonation in CodeIgniter Shield","description":"Implement secure user impersonation in CodeIgniter 4 using the Shield authentication system and a modular architecture.","keywords":["codeigniter4","authentication","shield","security"],"articleBody":"User impersonation is the ability for an authenticated user with appropriate privileges to assume the identity of another user temporarily. During impersonation, the original user’s session is preserved, allowing them to seamlessly return to their own account when the impersonation session ends.\nWhy Implement Impersonation? There are several compelling reasons to implement user impersonation in your web application:\nCustomer Support: Support representatives can experience exactly what a customer sees, making it easier to diagnose and resolve issues without requiring customers to share sensitive information or perform complex troubleshooting steps.\nTesting and Quality Assurance: Developers and QA teams can test features from the perspective of different user roles and permission levels without creating multiple test accounts or constantly switching credentials.\nDebugging User-Specific Issues: When a bug only affects certain users or user types, impersonation allows developers to reproduce the exact conditions and environment where the issue occurs.\nAdministrative Tasks: System administrators can perform actions on behalf of users who may be unavailable or unable to complete certain tasks themselves.\nPrerequisites: Installing and Setting Up Shield Before we implement impersonation, we need to install and configure Shield authentication library for CodeIgniter 4.\nInstalling Shield First, install Shield via Composer:\ncomposer require codeigniter4/shield Initial Shield Setup Run the Shield setup command to generate the necessary configuration files and database migrations:\nphp spark shield:setup This command creates several configuration files in your app/Config directory:\napp/Config/Auth.php app/Config/AuthGroups.php app/Config/AuthToken.php Moving Configuration to Module Structure To keep our impersonation functionality modular and organized, we’ll move these configuration files to our custom module structure.\nFirst, create the module directory structure:\nmkdir -p modules/Shield/Config Move the generated configuration files to our module:\nmv app/Config/Auth.php modules/Shield/Config/ mv app/Config/AuthGroups.php modules/Shield/Config/ mv app/Config/AuthToken.php modules/Shield/Config/ Update the namespace in each moved configuration file. Change the namespace from namespace Config; to namespace Modules\\Shield\\Config; in:\nmodules/Shield/Config/Auth.php modules/Shield/Config/AuthGroups.php modules/Shield/Config/AuthToken.php Cleaning Up Default Routes Remove the Shield route registration from your main routes file. Open app/Config/Routes.php and remove this line:\nservice('auth')-\u003eroutes($routes); We’ll handle route registration within our module structure instead.\nSetting Up Module Autoloading Add the module to your app/Config/Autoload.php file:\n// ... public $psr4 = [ APP_NAMESPACE =\u003e APPPATH, 'Modules\\Shield' =\u003e ROOTPATH . 'modules/Shield', ]; // ... This PSR-4 autoloading configuration allows us to organize our impersonation code in a clean, modular way that won’t interfere with the core Shield functionality.\nCreating the Impersonation Trait The core of our impersonation system is a trait that extends the session authenticator’s capabilities. Create modules/Shield/Traits/Impersonable.php:\n\u003c?php declare(strict_types=1); namespace Modules\\Shield\\Traits; use CodeIgniter\\Events\\Events; use CodeIgniter\\HTTP\\Response; use CodeIgniter\\Shield\\Exceptions\\LogicException; trait Impersonable { public function impersonateLogin(int $userId) { if (! $this-\u003eloggedIn() || $this-\u003eisPending() || $this-\u003eisAnonymous()) { throw new LogicException('User have to be logged in fully to impersonate.'); } $sessionUserInfo = $this-\u003egetSessionUserInfo(); if ($sessionUserInfo['originalId'] ?? null) { throw new LogicException('User is already impersonating someone.'); } $originalId = $sessionUserInfo['id'] ?? null; $this-\u003euser = $this-\u003eprovider-\u003efindById($userId); $this-\u003esetSessionUserKey('originalId', $originalId); $this-\u003esetSessionUserKey('id', $this-\u003euser-\u003eid); Events::trigger('impersonateLogin', $this-\u003euser); /** @var Response $response */ $response = service('response'); // When logged in, ensure cache control headers are in place $response-\u003enoCache(); } public function impersonateLogout() { if (! $this-\u003eloggedIn()) { throw new LogicException('User have to be logged in fully to impersonate.'); } $sessionUserInfo = $this-\u003egetSessionUserInfo(); if (! $userId = $sessionUserInfo['originalId'] ?? null) { throw new LogicException('User is not impersonating anyone.'); } $this-\u003euser = $this-\u003eprovider-\u003efindById($userId); $this-\u003esetSessionUserKey('id', $this-\u003euser-\u003eid); $this-\u003eremoveSessionUserKey('originalId'); Events::trigger('impersonateLogout', $this-\u003euser); /** @var Response $response */ $response = service('response'); // When logged in, ensure cache control headers are in place $response-\u003enoCache(); } public function isImpersonated(): bool { if ($this-\u003egetSessionUserKey('originalId')) { return true; } return false; } } This trait provides three essential methods:\nimpersonateLogin(): Initiates impersonation by storing the original user ID and switching to the target user. It includes safeguards to prevent impersonation chains and ensures only fully authenticated users can impersonate others.\nimpersonateLogout(): Ends the impersonation session and returns to the original user account.\nisImpersonated(): Checks whether the current session is in an impersonation state.\nExtending the Session Authenticator Next, we need to create a custom session authenticator that uses our impersonation trait. Create modules/Shield/Authentication/Authenticators/Session.php:\n\u003c?php declare(strict_types=1); namespace Modules\\Shield\\Authentication\\Authenticators; use CodeIgniter\\Shield\\Authentication\\AuthenticatorInterface; use CodeIgniter\\Shield\\Authentication\\Authenticators\\Session as ShieldSession; use Modules\\Shield\\Traits\\Impersonable; class Session extends ShieldSession implements AuthenticatorInterface { use Impersonable; } This extension maintains full compatibility with Shield’s existing session authentication while adding our impersonation capabilities.\nConfiguring the Custom Authenticator Now we need to update our modules/Shield/Config/Auth.php file (which we moved from the app directory earlier) to use our custom session authenticator. Open the file and update the use statement:\n\u003c?php declare(strict_types=1); namespace Modules\\Shield\\Config; // ... // use CodeIgniter\\Shield\\Authentication\\Authenticators\\Session; use Modules\\Shield\\Authentication\\Authenticators\\Session; // ... class Auth extends ShieldAuth { // ... } We have to replace the default use CodeIgniter\\Shield\\Authentication\\Authenticators\\Session; with our custom session authenticator instead.\nCreating the Impersonation Controller Now we’ll create a controller to handle impersonation requests. Create modules/Shield/Controllers/Impersonate.php:\n\u003c?php declare(strict_types=1); namespace Modules\\Shield\\Controllers; use App\\Controllers\\BaseController; use CodeIgniter\\Exceptions\\PageNotFoundException; class Impersonate extends BaseController { public function impersonateLogin(int $userId) { if (! auth()-\u003eloggedIn()) { throw PageNotFoundException::forPageNotFound(); } if (! auth()-\u003euser()-\u003ecan('admin.impersonate')) { throw PageNotFoundException::forPageNotFound(); } $authenticator = auth('session')-\u003egetAuthenticator(); $authenticator-\u003eimpersonateLogin($userId); return redirect()-\u003eto(config('Auth')-\u003eloginRedirect())-\u003ewithCookies(); } public function impersonateLogout() { if (! auth()-\u003eloggedIn()) { throw PageNotFoundException::forPageNotFound(); } $authenticator = auth('session')-\u003egetAuthenticator(); $authenticator-\u003eimpersonateLogout(); return redirect()-\u003eto(config('Auth')-\u003eloginRedirect())-\u003ewithCookies(); } } The controller provides clean endpoints for starting and ending impersonation sessions. Notice how we throw a PageNotFoundException for unauthenticated users rather than redirecting to a login page - this helps prevent information disclosure about the existence of impersonation functionality.\nSetting Up Routes Create modules/Shield/Config/Routes.php to register our impersonation routes:\n\u003c?php declare(strict_types=1); namespace Modules\\Shield\\Config; use CodeIgniter\\Router\\RouteCollection; /** * @var RouteCollection $routes */ service('auth')-\u003eroutes($routes); $routes-\u003eget('login-as/(:num)', '\\Modules\\Shield\\Controllers\\Impersonate::impersonateLogin/$1', ['as' =\u003e 'login-as']); $routes-\u003eget('logout-as', '\\Modules\\Shield\\Controllers\\Impersonate::impersonateLogout', ['as' =\u003e 'logout-as']); We’re also setting up service('auth')-\u003eroutes($routes) here, to maintain all the changes in one place.\nSetting Up Permissions As you may noticed we were checking certain permissions when we try to display a link or actually perform logging as another user. Now, it’s time to fill these permissions in the modules/Shield/Config/AuthGroups.php file:\n// ... public array $permissions = [ 'admin.impersonate' =\u003e 'Can login as a different user', // ... ]; // ... public array $matrix = [ 'superadmin' =\u003e [ 'admin.*', 'users.*', 'beta.*', ], 'admin' =\u003e [ 'admin.impersonate', // ... ], // ... ]; // ... Usage Examples Here’s how you can implement impersonation in your application views and controllers:\nIn Your Admin Panel View \u003c?php if (auth()-\u003euser()-\u003ecan('admin.impersonate')): ?\u003e \u003cdiv class=\"user-actions\"\u003e \u003c?php if (auth()-\u003eisImpersonated()): ?\u003e \u003ca href=\"\u003c?= route_to('logout-as') ?\u003e\" class=\"btn btn-warning\"\u003e \u003ci class=\"fas fa-sign-out-alt\"\u003e\u003c/i\u003e Stop Impersonating \u003c/a\u003e \u003c?php else: ?\u003e \u003ca href=\"\u003c?= route_to('login-as', $user-\u003eid) ?\u003e\" class=\"btn btn-primary\"\u003e \u003ci class=\"fas fa-sign-in-alt\"\u003e\u003c/i\u003e Login as \u003c?= esc($user-\u003eusername) ?\u003e \u003c/a\u003e \u003c?php endif; ?\u003e \u003c/div\u003e \u003c?php endif; ?\u003e In Your Base Controller You might want to add visual indicators when impersonation is active:\n\u003c?php namespace App\\Controllers; use CodeIgniter\\Controller; class BaseController extends Controller { // ... protected array $data = []; protected function initController() { parent::initController(); // Add impersonation status to view data if (auth()-\u003eloggedIn()) { $this-\u003edata['isImpersonated'] = auth()-\u003eisImpersonated(); } else { $this-\u003edata['isImpersonated'] = false; } } } In Your Layout Template Add a visual indicator for impersonation sessions:\n\u003c?php if ($isImpersonated ?? false): ?\u003e \u003cdiv class=\"alert alert-warning impersonation-banner\"\u003e \u003cstrong\u003e⚠️ Impersonation Active\u003c/strong\u003e You are currently viewing this application as another user. \u003ca href=\"\u003c?= route_to('logout-as') ?\u003e\" class=\"btn btn-sm btn-outline-dark ms-2\"\u003e Return to Your Account \u003c/a\u003e \u003c/div\u003e \u003c?php endif; ?\u003e Security Considerations When implementing user impersonation, security should be your top priority:\nPermission Checks: Always verify that the impersonating user has appropriate permissions before allowing impersonation. Consider creating a specific permission like admin.impersonate and checking it before showing impersonation links or processing impersonation requests.\nAudit Logging: Log all impersonation activities for security auditing and compliance purposes. You can hook into the impersonateLogin and impersonateLogout events we trigger in our trait.\nSession Security: Our implementation stores the original user ID in the session, which is secure as long as your session storage is properly configured and secured.\nVisual Indicators: Always provide clear visual feedback when impersonation is active so users understand the current context.\nEvent Handling Our implementation triggers events that you can use for logging or additional processing:\n\u003c?php // In your Events.php or a service Events::on('impersonateLogin', function ($user) { log_message('info', 'Impersonation started for user: ' . $user-\u003eid); }); Events::on('impersonateLogout', function ($user) { log_message('info', 'Impersonation ended, returned to user: ' . $user-\u003eid); }); Conclusion This implementation provides a secure, maintainable way to add user impersonation to your CodeIgniter 4 application using Shield authentication. The modular approach keeps your custom code organized and separate from the core framework, making it easier to maintain and update over time.\nRemember to always implement proper authorization checks in your application logic, maintain audit logs of impersonation activities, and provide clear visual feedback to users when impersonation is active. With these safeguards in place, user impersonation becomes a powerful tool for administration, support, and debugging.\n","wordCount":"1430","inLanguage":"en","datePublished":"2025-07-02T20:10:32+01:00","dateModified":"2025-07-02T20:10:32+01:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://michalsn.dev/posts/impersonation-with-codeigniter-shield/"},"publisher":{"@type":"Organization","name":"michalsn","logo":{"@type":"ImageObject","url":"https://michalsn.dev/favicon.ico"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://michalsn.dev/ accesskey=h title="michalsn (Alt + H)">michalsn</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://michalsn.dev/projects title=Projects><span>Projects</span></a></li><li><a href=https://michalsn.dev/archives title=Archive><span>Archive</span></a></li><li><a href=https://michalsn.dev/tags title=Tags><span>Tags</span></a></li><li><a href=https://michalsn.dev/search title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Implementing User Impersonation in CodeIgniter Shield</h1><div class=post-meta><span title='2025-07-02 20:10:32 +0100 +0100'>July 2, 2025</span>&nbsp;·&nbsp;<span>7 min</span></div></header><div class=post-content><p>User impersonation is the ability for an authenticated user with appropriate privileges to assume the identity of another user temporarily. During impersonation, the original user&rsquo;s session is preserved, allowing them to seamlessly return to their own account when the impersonation session ends.</p><h3 id=why-implement-impersonation>Why Implement Impersonation?<a hidden class=anchor aria-hidden=true href=#why-implement-impersonation>#</a></h3><p>There are several compelling reasons to implement user impersonation in your web application:</p><p><strong>Customer Support</strong>: Support representatives can experience exactly what a customer sees, making it easier to diagnose and resolve issues without requiring customers to share sensitive information or perform complex troubleshooting steps.</p><p><strong>Testing and Quality Assurance</strong>: Developers and QA teams can test features from the perspective of different user roles and permission levels without creating multiple test accounts or constantly switching credentials.</p><p><strong>Debugging User-Specific Issues</strong>: When a bug only affects certain users or user types, impersonation allows developers to reproduce the exact conditions and environment where the issue occurs.</p><p><strong>Administrative Tasks</strong>: System administrators can perform actions on behalf of users who may be unavailable or unable to complete certain tasks themselves.</p><h3 id=prerequisites-installing-and-setting-up-shield>Prerequisites: Installing and Setting Up Shield<a hidden class=anchor aria-hidden=true href=#prerequisites-installing-and-setting-up-shield>#</a></h3><p>Before we implement impersonation, we need to install and configure <a href=https://shield.codeigniter.com/>Shield</a> authentication library for CodeIgniter 4.</p><h4 id=installing-shield>Installing Shield<a hidden class=anchor aria-hidden=true href=#installing-shield>#</a></h4><p>First, install Shield via Composer:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>composer require codeigniter4/shield
</span></span></code></pre></div><h4 id=initial-shield-setup>Initial Shield Setup<a hidden class=anchor aria-hidden=true href=#initial-shield-setup>#</a></h4><p>Run the Shield setup command to generate the necessary configuration files and database migrations:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>php spark shield:setup
</span></span></code></pre></div><p>This command creates several configuration files in your <code>app/Config</code> directory:</p><ul><li><code>app/Config/Auth.php</code></li><li><code>app/Config/AuthGroups.php</code></li><li><code>app/Config/AuthToken.php</code></li></ul><h4 id=moving-configuration-to-module-structure>Moving Configuration to Module Structure<a hidden class=anchor aria-hidden=true href=#moving-configuration-to-module-structure>#</a></h4><p>To keep our impersonation functionality modular and organized, we&rsquo;ll move these configuration files to our custom module structure.</p><p>First, create the module directory structure:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir -p modules/Shield/Config
</span></span></code></pre></div><p>Move the generated configuration files to our module:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mv app/Config/Auth.php modules/Shield/Config/
</span></span><span style=display:flex><span>mv app/Config/AuthGroups.php modules/Shield/Config/
</span></span><span style=display:flex><span>mv app/Config/AuthToken.php modules/Shield/Config/
</span></span></code></pre></div><p>Update the namespace in each moved configuration file. Change the namespace from <code>namespace Config;</code> to <code>namespace Modules\Shield\Config;</code> in:</p><ul><li><code>modules/Shield/Config/Auth.php</code></li><li><code>modules/Shield/Config/AuthGroups.php</code></li><li><code>modules/Shield/Config/AuthToken.php</code></li></ul><h4 id=cleaning-up-default-routes>Cleaning Up Default Routes<a hidden class=anchor aria-hidden=true href=#cleaning-up-default-routes>#</a></h4><p>Remove the Shield route registration from your main routes file. Open <code>app/Config/Routes.php</code> and remove this line:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#a6e22e>service</span>(<span style=color:#e6db74>&#39;auth&#39;</span>)<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>routes</span>($routes);
</span></span></code></pre></div><p>We&rsquo;ll handle route registration within our module structure instead.</p><h4 id=setting-up-module-autoloading>Setting Up Module Autoloading<a hidden class=anchor aria-hidden=true href=#setting-up-module-autoloading>#</a></h4><p>Add the module to your <code>app/Config/Autoload.php</code> file:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> $psr4 <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>APP_NAMESPACE</span>    <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>APPPATH</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;Modules\Shield&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>ROOTPATH</span> <span style=color:#f92672>.</span> <span style=color:#e6db74>&#39;modules/Shield&#39;</span>,
</span></span><span style=display:flex><span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ...
</span></span></span></code></pre></div><p>This PSR-4 autoloading configuration allows us to organize our impersonation code in a clean, modular way that won&rsquo;t interfere with the core Shield functionality.</p><h3 id=creating-the-impersonation-trait>Creating the Impersonation Trait<a hidden class=anchor aria-hidden=true href=#creating-the-impersonation-trait>#</a></h3><p>The core of our impersonation system is a trait that extends the session authenticator&rsquo;s capabilities. Create <code>modules/Shield/Traits/Impersonable.php</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#f92672>&lt;?</span><span style=color:#a6e22e>php</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>declare</span>(<span style=color:#a6e22e>strict_types</span><span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>namespace</span> <span style=color:#a6e22e>Modules\Shield\Traits</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> <span style=color:#a6e22e>CodeIgniter\Events\Events</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> <span style=color:#a6e22e>CodeIgniter\HTTP\Response</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> <span style=color:#a6e22e>CodeIgniter\Shield\Exceptions\LogicException</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>trait</span> <span style=color:#a6e22e>Impersonable</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>impersonateLogin</span>(<span style=color:#a6e22e>int</span> $userId)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span> $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>loggedIn</span>() <span style=color:#f92672>||</span> $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>isPending</span>() <span style=color:#f92672>||</span> $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>isAnonymous</span>()) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>LogicException</span>(<span style=color:#e6db74>&#39;User have to be logged in fully to impersonate.&#39;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        $sessionUserInfo <span style=color:#f92672>=</span> $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>getSessionUserInfo</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> ($sessionUserInfo[<span style=color:#e6db74>&#39;originalId&#39;</span>] <span style=color:#f92672>??</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>LogicException</span>(<span style=color:#e6db74>&#39;User is already impersonating someone.&#39;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        $originalId <span style=color:#f92672>=</span> $sessionUserInfo[<span style=color:#e6db74>&#39;id&#39;</span>] <span style=color:#f92672>??</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>        $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>user</span> <span style=color:#f92672>=</span> $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>provider</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>findById</span>($userId);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>setSessionUserKey</span>(<span style=color:#e6db74>&#39;originalId&#39;</span>, $originalId);
</span></span><span style=display:flex><span>        $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>setSessionUserKey</span>(<span style=color:#e6db74>&#39;id&#39;</span>, $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>user</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>id</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Events</span><span style=color:#f92672>::</span><span style=color:#a6e22e>trigger</span>(<span style=color:#e6db74>&#39;impersonateLogin&#39;</span>, $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>user</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>/** @var Response $response */</span>
</span></span><span style=display:flex><span>        $response <span style=color:#f92672>=</span> <span style=color:#a6e22e>service</span>(<span style=color:#e6db74>&#39;response&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// When logged in, ensure cache control headers are in place
</span></span></span><span style=display:flex><span>        $response<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>noCache</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>impersonateLogout</span>()
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span> $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>loggedIn</span>()) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>LogicException</span>(<span style=color:#e6db74>&#39;User have to be logged in fully to impersonate.&#39;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        $sessionUserInfo <span style=color:#f92672>=</span> $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>getSessionUserInfo</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span> $userId <span style=color:#f92672>=</span> $sessionUserInfo[<span style=color:#e6db74>&#39;originalId&#39;</span>] <span style=color:#f92672>??</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>LogicException</span>(<span style=color:#e6db74>&#39;User is not impersonating anyone.&#39;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>user</span> <span style=color:#f92672>=</span> $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>provider</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>findById</span>($userId);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>setSessionUserKey</span>(<span style=color:#e6db74>&#39;id&#39;</span>, $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>user</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>id</span>);
</span></span><span style=display:flex><span>        $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>removeSessionUserKey</span>(<span style=color:#e6db74>&#39;originalId&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Events</span><span style=color:#f92672>::</span><span style=color:#a6e22e>trigger</span>(<span style=color:#e6db74>&#39;impersonateLogout&#39;</span>, $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>user</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>/** @var Response $response */</span>
</span></span><span style=display:flex><span>        $response <span style=color:#f92672>=</span> <span style=color:#a6e22e>service</span>(<span style=color:#e6db74>&#39;response&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// When logged in, ensure cache control headers are in place
</span></span></span><span style=display:flex><span>        $response<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>noCache</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>isImpersonated</span>()<span style=color:#f92672>:</span> <span style=color:#a6e22e>bool</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> ($this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>getSessionUserKey</span>(<span style=color:#e6db74>&#39;originalId&#39;</span>)) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This trait provides three essential methods:</p><p><strong><code>impersonateLogin()</code></strong>: Initiates impersonation by storing the original user ID and switching to the target user. It includes safeguards to prevent impersonation chains and ensures only fully authenticated users can impersonate others.</p><p><strong><code>impersonateLogout()</code></strong>: Ends the impersonation session and returns to the original user account.</p><p><strong><code>isImpersonated()</code></strong>: Checks whether the current session is in an impersonation state.</p><h3 id=extending-the-session-authenticator>Extending the Session Authenticator<a hidden class=anchor aria-hidden=true href=#extending-the-session-authenticator>#</a></h3><p>Next, we need to create a custom session authenticator that uses our impersonation trait. Create <code>modules/Shield/Authentication/Authenticators/Session.php</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#f92672>&lt;?</span><span style=color:#a6e22e>php</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>declare</span>(<span style=color:#a6e22e>strict_types</span><span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>namespace</span> <span style=color:#a6e22e>Modules\Shield\Authentication\Authenticators</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> <span style=color:#a6e22e>CodeIgniter\Shield\Authentication\AuthenticatorInterface</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> <span style=color:#a6e22e>CodeIgniter\Shield\Authentication\Authenticators\Session</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>ShieldSession</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> <span style=color:#a6e22e>Modules\Shield\Traits\Impersonable</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Session</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>ShieldSession</span> <span style=color:#66d9ef>implements</span> <span style=color:#a6e22e>AuthenticatorInterface</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>use</span> <span style=color:#a6e22e>Impersonable</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This extension maintains full compatibility with Shield&rsquo;s existing session authentication while adding our impersonation capabilities.</p><h3 id=configuring-the-custom-authenticator>Configuring the Custom Authenticator<a hidden class=anchor aria-hidden=true href=#configuring-the-custom-authenticator>#</a></h3><p>Now we need to update our <code>modules/Shield/Config/Auth.php</code> file (which we moved from the app directory earlier) to use our custom session authenticator. Open the file and update the <code>use</code> statement:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#f92672>&lt;?</span><span style=color:#a6e22e>php</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>declare</span>(<span style=color:#a6e22e>strict_types</span><span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>namespace</span> <span style=color:#a6e22e>Modules\Shield\Config</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e>// use CodeIgniter\Shield\Authentication\Authenticators\Session;
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> <span style=color:#a6e22e>Modules\Shield\Authentication\Authenticators\Session</span>;
</span></span><span style=display:flex><span><span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Auth</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>ShieldAuth</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We have to replace the default <code>use CodeIgniter\Shield\Authentication\Authenticators\Session;</code> with our custom session authenticator instead.</p><h3 id=creating-the-impersonation-controller>Creating the Impersonation Controller<a hidden class=anchor aria-hidden=true href=#creating-the-impersonation-controller>#</a></h3><p>Now we&rsquo;ll create a controller to handle impersonation requests. Create <code>modules/Shield/Controllers/Impersonate.php</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#f92672>&lt;?</span><span style=color:#a6e22e>php</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>declare</span>(<span style=color:#a6e22e>strict_types</span><span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>namespace</span> <span style=color:#a6e22e>Modules\Shield\Controllers</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> <span style=color:#a6e22e>App\Controllers\BaseController</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> <span style=color:#a6e22e>CodeIgniter\Exceptions\PageNotFoundException</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Impersonate</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>BaseController</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>impersonateLogin</span>(<span style=color:#a6e22e>int</span> $userId)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span> <span style=color:#a6e22e>auth</span>()<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>loggedIn</span>()) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#a6e22e>PageNotFoundException</span><span style=color:#f92672>::</span><span style=color:#a6e22e>forPageNotFound</span>();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span> <span style=color:#a6e22e>auth</span>()<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>user</span>()<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>can</span>(<span style=color:#e6db74>&#39;admin.impersonate&#39;</span>)) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#a6e22e>PageNotFoundException</span><span style=color:#f92672>::</span><span style=color:#a6e22e>forPageNotFound</span>();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        $authenticator <span style=color:#f92672>=</span> <span style=color:#a6e22e>auth</span>(<span style=color:#e6db74>&#39;session&#39;</span>)<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>getAuthenticator</span>();
</span></span><span style=display:flex><span>        $authenticator<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>impersonateLogin</span>($userId);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>redirect</span>()<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>to</span>(<span style=color:#a6e22e>config</span>(<span style=color:#e6db74>&#39;Auth&#39;</span>)<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>loginRedirect</span>())<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>withCookies</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>impersonateLogout</span>()
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span> <span style=color:#a6e22e>auth</span>()<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>loggedIn</span>()) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#a6e22e>PageNotFoundException</span><span style=color:#f92672>::</span><span style=color:#a6e22e>forPageNotFound</span>();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        $authenticator <span style=color:#f92672>=</span> <span style=color:#a6e22e>auth</span>(<span style=color:#e6db74>&#39;session&#39;</span>)<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>getAuthenticator</span>();
</span></span><span style=display:flex><span>        $authenticator<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>impersonateLogout</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>redirect</span>()<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>to</span>(<span style=color:#a6e22e>config</span>(<span style=color:#e6db74>&#39;Auth&#39;</span>)<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>loginRedirect</span>())<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>withCookies</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The controller provides clean endpoints for starting and ending impersonation sessions. Notice how we throw a <code>PageNotFoundException</code> for unauthenticated users rather than redirecting to a login page - this helps prevent information disclosure about the existence of impersonation functionality.</p><h3 id=setting-up-routes>Setting Up Routes<a hidden class=anchor aria-hidden=true href=#setting-up-routes>#</a></h3><p>Create <code>modules/Shield/Config/Routes.php</code> to register our impersonation routes:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#f92672>&lt;?</span><span style=color:#a6e22e>php</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>declare</span>(<span style=color:#a6e22e>strict_types</span><span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>namespace</span> <span style=color:#a6e22e>Modules\Shield\Config</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> <span style=color:#a6e22e>CodeIgniter\Router\RouteCollection</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e6db74>/**
</span></span></span><span style=display:flex><span><span style=color:#e6db74> * @var RouteCollection $routes
</span></span></span><span style=display:flex><span><span style=color:#e6db74> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>service</span>(<span style=color:#e6db74>&#39;auth&#39;</span>)<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>routes</span>($routes);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$routes<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#39;login-as/(:num)&#39;</span>, <span style=color:#e6db74>&#39;\Modules\Shield\Controllers\Impersonate::impersonateLogin/$1&#39;</span>, [<span style=color:#e6db74>&#39;as&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;login-as&#39;</span>]);
</span></span><span style=display:flex><span>$routes<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#39;logout-as&#39;</span>, <span style=color:#e6db74>&#39;\Modules\Shield\Controllers\Impersonate::impersonateLogout&#39;</span>, [<span style=color:#e6db74>&#39;as&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;logout-as&#39;</span>]);
</span></span></code></pre></div><p>We&rsquo;re also setting up <code>service('auth')->routes($routes)</code> here, to maintain all the changes in one place.</p><h3 id=setting-up-permissions>Setting Up Permissions<a hidden class=anchor aria-hidden=true href=#setting-up-permissions>#</a></h3><p>As you may noticed we were checking certain permissions when we try to display a link or actually perform logging as another user. Now, it&rsquo;s time to fill these permissions in the <code>modules/Shield/Config/AuthGroups.php</code> file:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>array</span> $permissions <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;admin.impersonate&#39;</span>   <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;Can login as a different user&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>array</span> $matrix <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;superadmin&#39;</span> <span style=color:#f92672>=&gt;</span> [
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;admin.*&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;users.*&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;beta.*&#39;</span>,
</span></span><span style=display:flex><span>    ],
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;admin&#39;</span> <span style=color:#f92672>=&gt;</span> [
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;admin.impersonate&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span>    ],
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ...
</span></span></span></code></pre></div><h3 id=usage-examples>Usage Examples<a hidden class=anchor aria-hidden=true href=#usage-examples>#</a></h3><p>Here&rsquo;s how you can implement impersonation in your application views and controllers:</p><h4 id=in-your-admin-panel-view>In Your Admin Panel View<a hidden class=anchor aria-hidden=true href=#in-your-admin-panel-view>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span><span style=color:#75715e>&lt;?php if (auth()-&gt;user()-&gt;can(&#39;admin.impersonate&#39;)): ?&gt;</span>
</span></span><span style=display:flex><span>    &lt;<span style=color:#f92672>div</span> <span style=color:#a6e22e>class</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;user-actions&#34;</span>&gt;
</span></span><span style=display:flex><span>        <span style=color:#75715e>&lt;?php if (auth()-&gt;isImpersonated()): ?&gt;</span>
</span></span><span style=display:flex><span>            &lt;<span style=color:#f92672>a</span> <span style=color:#a6e22e>href</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;&lt;?= route_to(&#39;logout-as&#39;) ?&gt;&#34;</span> <span style=color:#a6e22e>class</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;btn btn-warning&#34;</span>&gt;
</span></span><span style=display:flex><span>                &lt;<span style=color:#f92672>i</span> <span style=color:#a6e22e>class</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;fas fa-sign-out-alt&#34;</span>&gt;&lt;/<span style=color:#f92672>i</span>&gt; Stop Impersonating
</span></span><span style=display:flex><span>            &lt;/<span style=color:#f92672>a</span>&gt;
</span></span><span style=display:flex><span>        <span style=color:#75715e>&lt;?php else: ?&gt;</span>
</span></span><span style=display:flex><span>            &lt;<span style=color:#f92672>a</span> <span style=color:#a6e22e>href</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;&lt;?= route_to(&#39;login-as&#39;, $user-&gt;id) ?&gt;&#34;</span> <span style=color:#a6e22e>class</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;btn btn-primary&#34;</span>&gt;
</span></span><span style=display:flex><span>                &lt;<span style=color:#f92672>i</span> <span style=color:#a6e22e>class</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;fas fa-sign-in-alt&#34;</span>&gt;&lt;/<span style=color:#f92672>i</span>&gt; Login as <span style=color:#75715e>&lt;?= esc($user-&gt;username) ?&gt;</span>
</span></span><span style=display:flex><span>            &lt;/<span style=color:#f92672>a</span>&gt;
</span></span><span style=display:flex><span>        <span style=color:#75715e>&lt;?php endif; ?&gt;</span>
</span></span><span style=display:flex><span>    &lt;/<span style=color:#f92672>div</span>&gt;
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;?php endif; ?&gt;</span>
</span></span></code></pre></div><h4 id=in-your-base-controller>In Your Base Controller<a hidden class=anchor aria-hidden=true href=#in-your-base-controller>#</a></h4><p>You might want to add visual indicators when impersonation is active:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#f92672>&lt;?</span><span style=color:#a6e22e>php</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>namespace</span> <span style=color:#a6e22e>App\Controllers</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> <span style=color:#a6e22e>CodeIgniter\Controller</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>BaseController</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>Controller</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>array</span> $data <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>initController</span>()
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>parent</span><span style=color:#f92672>::</span><span style=color:#a6e22e>initController</span>();
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Add impersonation status to view data
</span></span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>auth</span>()<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>loggedIn</span>()) {
</span></span><span style=display:flex><span>            $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>data</span>[<span style=color:#e6db74>&#39;isImpersonated&#39;</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>auth</span>()<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>isImpersonated</span>();
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>data</span>[<span style=color:#e6db74>&#39;isImpersonated&#39;</span>] <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=in-your-layout-template>In Your Layout Template<a hidden class=anchor aria-hidden=true href=#in-your-layout-template>#</a></h4><p>Add a visual indicator for impersonation sessions:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span><span style=color:#75715e>&lt;?php if ($isImpersonated ?? false): ?&gt;</span>
</span></span><span style=display:flex><span>    &lt;<span style=color:#f92672>div</span> <span style=color:#a6e22e>class</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;alert alert-warning impersonation-banner&#34;</span>&gt;
</span></span><span style=display:flex><span>        &lt;<span style=color:#f92672>strong</span>&gt;⚠️ Impersonation Active&lt;/<span style=color:#f92672>strong</span>&gt;
</span></span><span style=display:flex><span>        You are currently viewing this application as another user.
</span></span><span style=display:flex><span>        &lt;<span style=color:#f92672>a</span> <span style=color:#a6e22e>href</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;&lt;?= route_to(&#39;logout-as&#39;) ?&gt;&#34;</span> <span style=color:#a6e22e>class</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;btn btn-sm btn-outline-dark ms-2&#34;</span>&gt;
</span></span><span style=display:flex><span>            Return to Your Account
</span></span><span style=display:flex><span>        &lt;/<span style=color:#f92672>a</span>&gt;
</span></span><span style=display:flex><span>    &lt;/<span style=color:#f92672>div</span>&gt;
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;?php endif; ?&gt;</span>
</span></span></code></pre></div><h3 id=security-considerations>Security Considerations<a hidden class=anchor aria-hidden=true href=#security-considerations>#</a></h3><p>When implementing user impersonation, security should be your top priority:</p><p><strong>Permission Checks</strong>: Always verify that the impersonating user has appropriate permissions before allowing impersonation. Consider creating a specific permission like <code>admin.impersonate</code> and checking it before showing impersonation links or processing impersonation requests.</p><p><strong>Audit Logging</strong>: Log all impersonation activities for security auditing and compliance purposes. You can hook into the <code>impersonateLogin</code> and <code>impersonateLogout</code> events we trigger in our trait.</p><p><strong>Session Security</strong>: Our implementation stores the original user ID in the session, which is secure as long as your session storage is properly configured and secured.</p><p><strong>Visual Indicators</strong>: Always provide clear visual feedback when impersonation is active so users understand the current context.</p><h3 id=event-handling>Event Handling<a hidden class=anchor aria-hidden=true href=#event-handling>#</a></h3><p>Our implementation triggers events that you can use for logging or additional processing:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#f92672>&lt;?</span><span style=color:#a6e22e>php</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// In your Events.php or a service
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>Events</span><span style=color:#f92672>::</span><span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#39;impersonateLogin&#39;</span>, <span style=color:#66d9ef>function</span> ($user) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>log_message</span>(<span style=color:#e6db74>&#39;info&#39;</span>, <span style=color:#e6db74>&#39;Impersonation started for user: &#39;</span> <span style=color:#f92672>.</span> $user<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>id</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Events</span><span style=color:#f92672>::</span><span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#39;impersonateLogout&#39;</span>, <span style=color:#66d9ef>function</span> ($user) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>log_message</span>(<span style=color:#e6db74>&#39;info&#39;</span>, <span style=color:#e6db74>&#39;Impersonation ended, returned to user: &#39;</span> <span style=color:#f92672>.</span> $user<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>id</span>);
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><h3 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h3><p>This implementation provides a secure, maintainable way to add user impersonation to your CodeIgniter 4 application using Shield authentication. The modular approach keeps your custom code organized and separate from the core framework, making it easier to maintain and update over time.</p><p>Remember to always implement proper authorization checks in your application logic, maintain audit logs of impersonation activities, and provide clear visual feedback to users when impersonation is active. With these safeguards in place, user impersonation becomes a powerful tool for administration, support, and debugging.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://michalsn.dev/tags/codeigniter4/>Codeigniter4</a></li><li><a href=https://michalsn.dev/tags/authentication/>Authentication</a></li><li><a href=https://michalsn.dev/tags/shield/>Shield</a></li><li><a href=https://michalsn.dev/tags/security/>Security</a></li></ul><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Implementing User Impersonation in CodeIgniter Shield on x" href="https://x.com/intent/tweet/?text=Implementing%20User%20Impersonation%20in%20CodeIgniter%20Shield&amp;url=https%3a%2f%2fmichalsn.dev%2fposts%2fimpersonation-with-codeigniter-shield%2f&amp;hashtags=codeigniter4%2cauthentication%2cshield%2csecurity"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Implementing User Impersonation in CodeIgniter Shield on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fmichalsn.dev%2fposts%2fimpersonation-with-codeigniter-shield%2f&amp;title=Implementing%20User%20Impersonation%20in%20CodeIgniter%20Shield&amp;summary=Implementing%20User%20Impersonation%20in%20CodeIgniter%20Shield&amp;source=https%3a%2f%2fmichalsn.dev%2fposts%2fimpersonation-with-codeigniter-shield%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Implementing User Impersonation in CodeIgniter Shield on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fmichalsn.dev%2fposts%2fimpersonation-with-codeigniter-shield%2f&title=Implementing%20User%20Impersonation%20in%20CodeIgniter%20Shield"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Implementing User Impersonation in CodeIgniter Shield on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fmichalsn.dev%2fposts%2fimpersonation-with-codeigniter-shield%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Implementing User Impersonation in CodeIgniter Shield on whatsapp" href="https://api.whatsapp.com/send?text=Implementing%20User%20Impersonation%20in%20CodeIgniter%20Shield%20-%20https%3a%2f%2fmichalsn.dev%2fposts%2fimpersonation-with-codeigniter-shield%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Implementing User Impersonation in CodeIgniter Shield on telegram" href="https://telegram.me/share/url?text=Implementing%20User%20Impersonation%20in%20CodeIgniter%20Shield&amp;url=https%3a%2f%2fmichalsn.dev%2fposts%2fimpersonation-with-codeigniter-shield%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentColor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Implementing User Impersonation in CodeIgniter Shield on ycombinator" href="https://news.ycombinator.com/submitlink?t=Implementing%20User%20Impersonation%20in%20CodeIgniter%20Shield&u=https%3a%2f%2fmichalsn.dev%2fposts%2fimpersonation-with-codeigniter-shield%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer><script src=https://utteranc.es/client.js repo=michalsn/michalsn.dev issue-term=pathname label=comments theme=preferred-color-scheme crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2026 <a href=https://michalsn.dev/>michalsn</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg></a><div id=cookie-notice role=dialog aria-live=polite aria-label="Cookie notice"><div class=inner><span>This website uses third-party cookies and scripts to improve its functionality.</span>
<a id=cookie-notice-accept class="btn btn-primary btn-sm">Approve</a>
<a id=cookie-notice-deny class="btn btn-primary btn-sm">Deny</a>
<a id=cookie-notice-info href=/privacy class="btn btn-primary btn-sm">More info</a></div></div><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{const e=document.querySelector("html");e.dataset.theme==="dark"?(e.dataset.theme="light",localStorage.setItem("pref-theme","light")):(e.dataset.theme="dark",localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>