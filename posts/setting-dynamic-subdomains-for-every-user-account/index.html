<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>Setting dynamic subdomains for every user account | michalsn</title>
<meta name=keywords content="php,codeigniter4,subdomain">
<meta name=description content="What if we want every user in our application to have his data served through his own subdomain? I will show you how to do it in CodeIgniter 4 framework.">
<meta name=author content>
<link rel=canonical href=https://michalsn.dev/posts/setting-dynamic-subdomains-for-every-user-account/>
<link crossorigin=anonymous href=/assets/css/stylesheet.min.b9ff4cc257e914dab489bd18086151800e18f91456a5174bf28489210227a659.css integrity="sha256-uf9MwlfpFNq0ib0YCGFRgA4Y+RRWpRdL8oSJIQInplk=" rel="preload stylesheet" as=style>
<script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://michalsn.dev/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://michalsn.dev/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://michalsn.dev/favicon-32x32.png>
<link rel=apple-touch-icon href=https://michalsn.dev/apple-touch-icon.png>
<link rel=mask-icon href=https://michalsn.dev/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<meta name=generator content="Hugo 0.89.4">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-74HSH0WCPE"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-74HSH0WCPE',{anonymize_ip:!1})}</script>
<meta property="og:title" content="Setting dynamic subdomains for every user account">
<meta property="og:description" content="What if we want every user in our application to have his data served through his own subdomain? I will show you how to do it in CodeIgniter 4 framework.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://michalsn.dev/posts/setting-dynamic-subdomains-for-every-user-account/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2021-10-18T11:42:57+02:00">
<meta property="article:modified_time" content="2021-10-18T11:42:57+02:00"><meta property="og:site_name" content="michalsn">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Setting dynamic subdomains for every user account">
<meta name=twitter:description content="What if we want every user in our application to have his data served through his own subdomain? I will show you how to do it in CodeIgniter 4 framework.">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://michalsn.dev/posts/"},{"@type":"ListItem","position":2,"name":"Setting dynamic subdomains for every user account","item":"https://michalsn.dev/posts/setting-dynamic-subdomains-for-every-user-account/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Setting dynamic subdomains for every user account","name":"Setting dynamic subdomains for every user account","description":"What if we want every user in our application to have his data served through his own subdomain? I will show you how to do it in CodeIgniter 4 framework.\n","keywords":["php","codeigniter4","subdomain"],"articleBody":"What if we want every user in our application to have his data served through his own subdomain? I will show you how to do it in CodeIgniter 4 framework.\nThe assumptions are as follows - we have 2 domains:\n primary domain on which users will be managed and subdomains, on which the application for each user will run  In short, this is one of the concepts that are often used by SaaS applications.\nThis can be achieved quite easily. However, when working with CodeIgniter 4 you have to remember that variables defined in .env file have priority over all other changes you try to make while the framework is running.\nWith this in mind - the first thing we will do is to drop the app.baseURL variable from the .env file so that we can dynamically change this value. This variable is not active by default but you may be used to use it.\nFirst things first - we have to edit the app/Config/App.php file and add two variables:\n /** * -------------------------------------------------------------------------- * Subdomain URL * -------------------------------------------------------------------------- * * Subdomain address for accounts in the system. * * @var string */ public $subdomainURL = ''; /** * -------------------------------------------------------------------------- * Account ID * -------------------------------------------------------------------------- * * Account ID (or empty string for main domain name). * Value '404' means that domain/subdomain is not registered in the system. * * @var string */ public $accountID = ''; We will now override the subdomainURL variable in the .env file and add our own variable for baseURL:\nbaseURL = 'application.test' // yes, this is correct - we don't want to use app.baseURL app.subdomainURL = '.application.test' If we use separate variables for the primary domain and subdomain address, our system will become more flexible as it will be able to use different domains for subdomains.\nThe next thing will be to create some form of subdomain creation for each user. I will not go into that here, but I will mention just one thing. It is important to validate subdomain names properly, so that they generate valid URLs.\nIf you keep the subdomain names in the database, then after each change you will have to update the cache in which you will keep informations about subdomains. Let’s make an example model method:\npublic function updateSubdomainCache() { $results = $this-builder()-select('account_id, subdomain')-get()-getResult(); $subdomain = config('App')-subdomainURL); $data = []; foreach ($results as $row) { $data[$row-subdomain . $subdomain] = $row-account_id; } cache()-save('subdomains', $data, 0); } Now that we have almost everything we need, we can move on to overriding baseURL address and make it work for subdomains. We are going to use Config/Registrar class which you can read more about here:\nnamespace App\\Config; class Registrar { public static function App() { if (! is_cli()) { if (! $subdomains = cache('subdomains')) { $subdomains = []; } $subdomains[env('baseURL')] = ''; if (isset($subdomains[$_SERVER['SERVER_NAME']])) { return [ 'baseURL' = sprintf('https://%s/', $_SERVER['SERVER_NAME']), 'accountID' = $subdomains[$_SERVER['SERVER_NAME']] ]; } } return [ 'baseURL' = sprintf('https://%s/', env('baseURL')), 'accountID' = '404' ]; } } Finally, we need to define routing. The primary domain and subdomains will be distinguished using the hostname resolution trick:\n// subdomains routes $routes-group('', [], function ($routes) { }); // main domain routes $routes-group('', ['hostname' = env('baseURL')], function ($routes) { }); This way we set the correct application address and additionally the account ID, which will allow us to form correct queries to the database right away.\n","wordCount":"563","inLanguage":"en","datePublished":"2021-10-18T11:42:57+02:00","dateModified":"2021-10-18T11:42:57+02:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://michalsn.dev/posts/setting-dynamic-subdomains-for-every-user-account/"},"publisher":{"@type":"Organization","name":"michalsn","logo":{"@type":"ImageObject","url":"https://michalsn.dev/favicon.ico"}}}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<noscript>
<style type=text/css>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://michalsn.dev/ accesskey=h title="michalsn (Alt + H)">michalsn</a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</span>
</div>
<ul id=menu>
<li>
<a href=https://michalsn.dev/archives title=Archive>
<span>Archive</span>
</a>
</li>
<li>
<a href=https://michalsn.dev/tags title=Tags>
<span>Tags</span>
</a>
</li>
<li>
<a href=https://michalsn.dev/search title="Search (Alt + /)" accesskey=/>
<span>Search</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<h1 class=post-title>
Setting dynamic subdomains for every user account
</h1>
<div class=post-meta>October 18, 2021&nbsp;·&nbsp;3 min
</div>
</header>
<div class=post-content><p>What if we want every user in our application to have his data served through his own subdomain? I will show you how to do it in CodeIgniter 4 framework.</p>
<p>The assumptions are as follows - we have 2 domains:</p>
<ul>
<li>primary domain on which users will be managed</li>
<li>and subdomains, on which the application for each user will run</li>
</ul>
<p>In short, this is one of the concepts that are often used by SaaS applications.</p>
<p>This can be achieved quite easily. However, when working with CodeIgniter 4 you have to remember that variables defined in <strong>.env</strong> file have priority over all other changes you try to make while the framework is running.</p>
<p>With this in mind - the first thing we will do is to drop the <strong>app.baseURL</strong> variable from the <strong>.env</strong> file so that we can dynamically change this value. This variable is not active by default but you may be used to use it.</p>
<p>First things first - we have to edit the <strong>app/Config/App.php</strong> file and add two variables:</p>
<pre tabindex=0><code>    /**
     * --------------------------------------------------------------------------
     * Subdomain URL
     * --------------------------------------------------------------------------
     *
     * Subdomain address for accounts in the system.
     *
     * @var string
     */
    public $subdomainURL = '';

    /**
     * --------------------------------------------------------------------------
     * Account ID
     * --------------------------------------------------------------------------
     *
     * Account ID (or empty string for main domain name).
     * Value '404' means that domain/subdomain is not registered in the system.
     *
     * @var string
     */
    public $accountID = '';
</code></pre><p>We will now override the <strong>subdomainURL</strong> variable in the <strong>.env</strong> file and add our own variable for <strong>baseURL</strong>:</p>
<pre tabindex=0><code>baseURL = 'application.test' // yes, this is correct - we don't want to use app.baseURL
app.subdomainURL = '.application.test'
</code></pre><p>If we use separate variables for the primary domain and subdomain address, our system will become more flexible as it will be able to use different domains for subdomains.</p>
<p>The next thing will be to create some form of subdomain creation for each user. I will not go into that here, but I will mention just one thing. It is important to validate subdomain names properly, so that they generate valid URLs.</p>
<p>If you keep the subdomain names in the database, then after each change you will have to update the cache in which you will keep informations about subdomains. Let&rsquo;s make an example model method:</p>
<pre tabindex=0><code>public function updateSubdomainCache()
{
    $results   = $this-&gt;builder()-&gt;select('account_id, subdomain')-&gt;get()-&gt;getResult();
    $subdomain = config('App')-&gt;subdomainURL);
    $data      = [];
    
    foreach ($results as $row) {
        $data[$row-&gt;subdomain . $subdomain] = $row-&gt;account_id;
    }

    cache()-&gt;save('subdomains', $data, 0);
}
</code></pre><p>Now that we have almost everything we need, we can move on to overriding <strong>baseURL</strong> address and make it work for subdomains. We are going to use <strong>Config/Registrar</strong> class which you can read more about <a href=https://codeigniter4.github.io/userguide/general/configuration.html?#registrars>here</a>:</p>
<pre tabindex=0><code>namespace App\Config;

class Registrar
{
    public static function App()
    {
        if (! is_cli()) {
            if (! $subdomains = cache('subdomains')) {
                $subdomains = [];
            }

            $subdomains[env('baseURL')] = '';

            if (isset($subdomains[$_SERVER['SERVER_NAME']])) {
                return [
                    'baseURL'   =&gt; sprintf('https://%s/', $_SERVER['SERVER_NAME']),
                    'accountID' =&gt; $subdomains[$_SERVER['SERVER_NAME']]
                ];
            }
        }

        return [
            'baseURL'   =&gt; sprintf('https://%s/', env('baseURL')),
            'accountID' =&gt; '404'
        ];
    }
}

</code></pre><p>Finally, we need to define routing. The primary domain and subdomains will be distinguished using the <strong>hostname</strong> resolution trick:</p>
<pre tabindex=0><code>// subdomains routes
$routes-&gt;group('', [], function ($routes) {
    
});

// main domain routes
$routes-&gt;group('', ['hostname' =&gt; env('baseURL')], function ($routes) {
    
});
</code></pre><p>This way we set the correct application address and additionally the account ID, which will allow us to form correct queries to the database right away.</p>
</div>
<footer class=post-footer>
<ul class=post-tags>
<li><a href=https://michalsn.dev/tags/php/>php</a></li>
<li><a href=https://michalsn.dev/tags/codeigniter4/>codeigniter4</a></li>
<li><a href=https://michalsn.dev/tags/subdomain/>subdomain</a></li>
</ul>
</footer>
</article>
</main>
<footer class=footer>
<span>&copy; 2021 <a href=https://michalsn.dev/>michalsn</a></span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)">
<button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</button>
</a>
<script>let menu=document.getElementById('menu');menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
<script>document.querySelectorAll('pre > code').forEach(b=>{const c=b.parentNode.parentNode,a=document.createElement('button');a.classList.add('copy-code'),a.innerText='copy';function d(){a.innerText='copied!',setTimeout(()=>{a.innerText='copy'},2e3)}a.addEventListener('click',e=>{if('clipboard'in navigator){navigator.clipboard.writeText(b.textContent),d();return}const a=document.createRange();a.selectNodeContents(b);const c=window.getSelection();c.removeAllRanges(),c.addRange(a);try{document.execCommand('copy'),d()}catch(a){}c.removeRange(a)}),c.classList.contains("highlight")?c.appendChild(a):c.parentNode.firstChild==c||(b.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?b.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(a):b.parentNode.appendChild(a))})</script>
</body>
</html>