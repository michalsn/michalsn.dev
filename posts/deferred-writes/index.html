<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Deferred Writes: Performance Optimization and Database Gotchas | michalsn</title><meta name=keywords content="codeigniter4,settings,database"><meta name=description content="A look behind the scenes of implementing deferred writes in the CodeIgniter 4 Settings package: how batching write operations improves performance, and the subtle database portability issue caused by NULL values in unique constraints."><meta name=author content><link rel=canonical href=https://michalsn.dev/posts/deferred-writes/><link crossorigin=anonymous href=/assets/css/stylesheet.8fe10233a706bc87f2e08b3cf97b8bd4c0a80f10675a143675d59212121037c0.css integrity="sha256-j+ECM6cGvIfy4Is8+XuL1MCoDxBnWhQ2ddWSEhIQN8A=" rel="preload stylesheet" as=style><link rel=icon href=https://michalsn.dev/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://michalsn.dev/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://michalsn.dev/favicon-32x32.png><link rel=apple-touch-icon href=https://michalsn.dev/apple-touch-icon.png><link rel=mask-icon href=https://michalsn.dev/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://michalsn.dev/posts/deferred-writes/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=/css/custom.css><script src=/js/custom.js></script><meta property="og:url" content="https://michalsn.dev/posts/deferred-writes/"><meta property="og:site_name" content="michalsn"><meta property="og:title" content="Deferred Writes: Performance Optimization and Database Gotchas"><meta property="og:description" content="A look behind the scenes of implementing deferred writes in the CodeIgniter 4 Settings package: how batching write operations improves performance, and the subtle database portability issue caused by NULL values in unique constraints."><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-11-30T10:34:02+01:00"><meta property="article:modified_time" content="2025-11-30T10:34:02+01:00"><meta property="article:tag" content="Codeigniter4"><meta property="article:tag" content="Settings"><meta property="article:tag" content="Database"><meta property="og:image" content="https://michalsn.dev/posts/deferred-writes/og.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://michalsn.dev/posts/deferred-writes/og.png"><meta name=twitter:title content="Deferred Writes: Performance Optimization and Database Gotchas"><meta name=twitter:description content="A look behind the scenes of implementing deferred writes in the CodeIgniter 4 Settings package: how batching write operations improves performance, and the subtle database portability issue caused by NULL values in unique constraints."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://michalsn.dev/posts/"},{"@type":"ListItem","position":2,"name":"Deferred Writes: Performance Optimization and Database Gotchas","item":"https://michalsn.dev/posts/deferred-writes/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Deferred Writes: Performance Optimization and Database Gotchas","name":"Deferred Writes: Performance Optimization and Database Gotchas","description":"A look behind the scenes of implementing deferred writes in the CodeIgniter 4 Settings package: how batching write operations improves performance, and the subtle database portability issue caused by NULL values in unique constraints.","keywords":["codeigniter4","settings","database"],"articleBody":"While contributing to the CodeIgniter 4 Settings package, I implemented one particularly interesting feature: deferred writes. This enhancement allows the framework to batch setting updates and commit them only once per request, significantly reducing unnecessary database and file operations. What seemed like a small optimization quickly turned into an interesting deep dive into database portability and edge-case behavior.\nThe Performance Problem Consider a typical request that updates multiple settings:\n$settings-\u003eset('App.siteName', 'My Awesome Site'); $settings-\u003eset('App.siteEmail', 'admin@example.com'); $settings-\u003eset('App.maintenance', false); $settings-\u003eset('Email.fromAddress', 'noreply@example.com'); With immediate writes (deferWrites = false), each set() call triggers:\nOne SELECT query to hydrate all settings for that context (cached after first call) One INSERT or UPDATE query to persist the change Result: 1 SELECT + 4 separate INSERT/UPDATE queries\nThis works, but it’s inefficient. We’re making individual database round-trips for changes that could be batched together.\nThe Solution: Deferred Writes The concept is simple: instead of writing immediately, queue the changes and flush them all at once at the end of the request:\n// In your config/Settings.php public $database = [ 'class' =\u003e DatabaseHandler::class, 'table' =\u003e 'settings', 'deferWrites' =\u003e true, // Enable deferred writes ]; Now the same code executes very differently:\n$settings-\u003eset('App.siteName', 'My Awesome Site'); // Queued $settings-\u003eset('App.siteEmail', 'admin@example.com'); // Queued $settings-\u003eset('App.maintenance', false); // Queued $settings-\u003eset('Email.fromAddress', 'noreply@example.com'); // Queued // ... end of request, post_system event triggers ... // Now: 1 SELECT + 1 batch INSERT + 1 batch UPDATE (for all changes) Result: 1 SELECT + 2 batch operations, regardless of how many properties you modify.\nThis works for both DatabaseHandler and FileHandler:\nDatabaseHandler: Uses insertBatch() and updateBatch() to minimize queries FileHandler: Groups changes by class+context and writes each file once The Implementation Challenge The core logic is straightforward—track pending changes in an array and persist them during the post_system event:\nprotected array $pendingProperties = []; public function set(string $class, string $property, $value, ?string $context) { if ($this-\u003edeferWrites) { $this-\u003emarkPending($class, $property, $value, $context); } else { $this-\u003epersist($class, $property, $value, $context); } $this-\u003esetStored($class, $property, $value, $context); } protected function markPending(string $class, string $property, $value, ?string $context) { $key = $class . '::' . $property . ($context === null ? '' : '::' . $context); $this-\u003ependingProperties[$key] = [ 'class' =\u003e $class, 'property' =\u003e $property, 'value' =\u003e $value, 'context' =\u003e $context, ]; } At the end of the request, CodeIgniter fires the post_system event, which triggers:\nEvents::on('post_system', [$this, 'persistPendingProperties']); So far, so good. But here’s where I hit a wall.\nThe Unique Index Problem My database table schema looked like this:\nCREATE TABLE settings ( id INT AUTO_INCREMENT PRIMARY KEY, class VARCHAR(255) NOT NULL, key VARCHAR(255) NOT NULL, value TEXT, type VARCHAR(31) DEFAULT 'string', context VARCHAR(255) DEFAULT NULL, created_at DATETIME NOT NULL, updated_at DATETIME NOT NULL ); To prevent duplicate settings, I needed a unique constraint on (class, key, context). My first instinct:\nCREATE UNIQUE INDEX idx_unique_setting ON settings (class, key, context); This worked perfectly in SQL Server. But when I tested on MySQL and PostgreSQL, I could insert multiple rows with the same class and key when context was NULL:\nINSERT INTO settings (class, key, context, ...) VALUES ('App\\Config', 'siteName', NULL, ...); INSERT INTO settings (class, key, context, ...) VALUES ('App\\Config', 'siteName', NULL, ...); -- Both succeed! Duplicates created. Why Does This Happen? TL;DR: Most databases treat NULL as “unknown”, and two unknowns are never equal—even to each other.\nHere’s the SQL standard behavior:\nMySQL/MariaDB: NULL values are not considered equal in unique indexes. Multiple NULLs are allowed. PostgreSQL: Same behavior: NULL != NULL for unique constraints. SQLite3: Same behavior. SQL Server (SQLSRV): Treats NULLs as equal by default in unique constraints (non-standard). So my unique index only worked in SQL Server. Everywhere else, it allowed unlimited duplicates when context was NULL.\nThe Fix: Application-Level Duplicate Prevention Since I couldn’t rely on database constraints for portability, I moved the duplicate prevention into the application layer. The persistPendingProperties() method in DatabaseHandler now:\nFetches existing records that match pending changes Builds a lookup map to identify which pending properties already exist Separates inserts from updates based on existence Executes batch operations for both inserts and updates Here’s the core logic (simplified):\npublic function persistPendingProperties() { // Separate deletes from upserts $deletes = []; $upserts = []; foreach ($this-\u003ependingProperties as $info) { if ($info['delete']) { $deletes[] = ['class' =\u003e $info['class'], 'key' =\u003e $info['property'], 'context' =\u003e $info['context']]; } else { $upserts[] = [ 'class' =\u003e $info['class'], 'key' =\u003e $info['property'], 'value' =\u003e $this-\u003eprepareValue($info['value']), 'type' =\u003e gettype($info['value']), 'context' =\u003e $info['context'], ]; } } $this-\u003edb-\u003etransStart(); if ($upserts !== []) { // Fetch existing records for our pending data $this-\u003ebuildOrWhereConditions($upserts, 'class', 'key', 'context'); $existing = $this-\u003ebuilder-\u003eget()-\u003egetResultArray(); // Build map: composite key =\u003e record ID $existingMap = []; foreach ($existing as $row) { $key = $row['class'] . '::' . $row['key'] . ($row['context'] ?? ''); $existingMap[$key] = $row['id']; } // Separate into inserts (new) and updates (existing) $inserts = []; $updates = []; foreach ($upserts as $row) { $key = $row['class'] . '::' . $row['key'] . ($row['context'] ?? ''); if (isset($existingMap[$key])) { // Already exists - update it $updates[] = [ 'id' =\u003e $existingMap[$key], 'value' =\u003e $row['value'], 'type' =\u003e $row['type'], ]; } else { // New record - insert it $inserts[] = $row; } } if ($inserts !== []) { $this-\u003ebuilder-\u003einsertBatch($inserts); } if ($updates !== []) { $this-\u003ebuilder-\u003eupdateBatch($updates, 'id'); } } // Handle deletes if ($deletes !== []) { $this-\u003ebuildOrWhereConditions($deletes, 'class', 'key', 'context'); $this-\u003ebuilder-\u003edelete(); } $this-\u003edb-\u003etransComplete(); $this-\u003ependingProperties = []; } This approach:\nWorks across all database engines (MySQL, PostgreSQL, SQLite, SQL Server) Prevents duplicates reliably through application logic Maintains batch efficiency with insertBatch() and updateBatch() Handles edge cases like forgetting and then re-setting a property FileHandler: A Different Take Interestingly, the FileHandler doesn’t face this problem at all. Since files are organized by class+context combination:\nwritable/settings/ ├── App_Config.php \u003c- App\\Config class, null context ├── Email_Config.php \u003c- Email\\Config class, null context └── a1b2c3d4e5f6/ \u003c- hash('xxh128', 'production') ├── App_Config.php └── Email_Config.php Each file is self-contained. When persisting changes, the handler:\nGroups pending properties by class+context For each group, acquire an exclusive file lock Reads current data, merges changes, writes back Releases the lock No database, no NULL behavior quirks. The filesystem naturally enforces uniqueness.\nLessons Learned 1. Database Portability is Hard What seems like basic functionality (unique constraints with nullable columns) has surprising edge cases. Always test across multiple database engines when building portable libraries.\n2. NULL is Special SQL’s three-valued logic (TRUE, FALSE, UNKNOWN) makes NULL values behave in ways that aren’t always intuitive. NULL != NULL is one of those SQL quirks that will eventually catch you off guard.\n3. Application Logic Can Compensate When database features aren’t portable, moving logic to the application layer can provide consistent behavior. The cost: slightly more complex code. The benefit: it works everywhere.\n4. Batch Operations Are Your Friend Even with the extra SELECT query to identify existing records, batching inserts and updates together is still dramatically faster than individual operations. The performance gains of deferred writes are real.\nPerformance Impact In realistic scenarios (10+ settings updated per request), deferred writes reduce database queries by 70-80%. The overhead of the duplicate-detection SELECT is negligible compared to the savings from batch operations.\nFor file-based storage, the impact is even more dramatic—one file write instead of 10.\nTradeoffs Deferred writes aren’t without costs:\nWrite operations won’t appear in CodeIgniter’s Debug Toolbar (the post_system event runs after toolbar data collection) Early termination loses pending writes (fatal errors, exit(), etc.) Failures are logged, not thrown (exceptions during post_system would disrupt shutdown) For most applications, these tradeoffs are worth it. If you need immediate persistence guarantees, stick with deferWrites = false.\nTry It Yourself Enable deferred writes in your app/Config/Settings.php:\npublic $database = [ 'class' =\u003e DatabaseHandler::class, 'table' =\u003e 'settings', 'deferWrites' =\u003e true, ]; // Or for FileHandler public $file = [ 'class' =\u003e FileHandler::class, 'path' =\u003e WRITEPATH . 'settings', 'deferWrites' =\u003e true, ]; In the end, deferred writes turned out to be a small feature with a big impact. They’re portable, fast, and already reducing unnecessary I/O for CI4 applications.\nHopefully, this breakdown helps anyone who wants to understand the internals or build on the idea further.\n","wordCount":"1341","inLanguage":"en","datePublished":"2025-11-30T10:34:02+01:00","dateModified":"2025-11-30T10:34:02+01:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://michalsn.dev/posts/deferred-writes/"},"publisher":{"@type":"Organization","name":"michalsn","logo":{"@type":"ImageObject","url":"https://michalsn.dev/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://michalsn.dev/ accesskey=h title="michalsn (Alt + H)">michalsn</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://michalsn.dev/projects title=Projects><span>Projects</span></a></li><li><a href=https://michalsn.dev/archives title=Archive><span>Archive</span></a></li><li><a href=https://michalsn.dev/tags title=Tags><span>Tags</span></a></li><li><a href=https://michalsn.dev/search title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Deferred Writes: Performance Optimization and Database Gotchas</h1><div class=post-meta><span title='2025-11-30 10:34:02 +0100 +0100'>November 30, 2025</span>&nbsp;·&nbsp;7 min</div></header><div class=post-content><p>While contributing to the <a href=https://github.com/codeigniter4/settings>CodeIgniter 4 Settings</a> package, I implemented one particularly interesting feature: <strong>deferred writes</strong>. This enhancement allows the framework to batch setting updates and commit them only once per request, significantly reducing unnecessary database and file operations. What seemed like a small optimization quickly turned into an interesting deep dive into database portability and edge-case behavior.</p><h3 id=the-performance-problem>The Performance Problem<a hidden class=anchor aria-hidden=true href=#the-performance-problem>#</a></h3><p>Consider a typical request that updates multiple settings:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span>$settings<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>set</span>(<span style=color:#e6db74>&#39;App.siteName&#39;</span>, <span style=color:#e6db74>&#39;My Awesome Site&#39;</span>);
</span></span><span style=display:flex><span>$settings<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>set</span>(<span style=color:#e6db74>&#39;App.siteEmail&#39;</span>, <span style=color:#e6db74>&#39;admin@example.com&#39;</span>);
</span></span><span style=display:flex><span>$settings<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>set</span>(<span style=color:#e6db74>&#39;App.maintenance&#39;</span>, <span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>$settings<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>set</span>(<span style=color:#e6db74>&#39;Email.fromAddress&#39;</span>, <span style=color:#e6db74>&#39;noreply@example.com&#39;</span>);
</span></span></code></pre></div><p>With immediate writes (<code>deferWrites = false</code>), each <code>set()</code> call triggers:</p><ol><li>One SELECT query to hydrate all settings for that context (cached after first call)</li><li>One INSERT or UPDATE query to persist the change</li></ol><p><strong>Result:</strong> 1 SELECT + 4 separate INSERT/UPDATE queries</p><p>This works, but it&rsquo;s inefficient. We&rsquo;re making individual database round-trips for changes that could be batched together.</p><h3 id=the-solution-deferred-writes>The Solution: Deferred Writes<a hidden class=anchor aria-hidden=true href=#the-solution-deferred-writes>#</a></h3><p>The concept is simple: instead of writing immediately, queue the changes and flush them all at once at the end of the request:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#75715e>// In your config/Settings.php
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>public</span> $database <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;class&#39;</span>       <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>DatabaseHandler</span><span style=color:#f92672>::</span><span style=color:#a6e22e>class</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;table&#39;</span>       <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;settings&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;deferWrites&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>true</span>,  <span style=color:#75715e>// Enable deferred writes
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>];
</span></span></code></pre></div><p>Now the same code executes very differently:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span>$settings<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>set</span>(<span style=color:#e6db74>&#39;App.siteName&#39;</span>, <span style=color:#e6db74>&#39;My Awesome Site&#39;</span>);      <span style=color:#75715e>// Queued
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>$settings<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>set</span>(<span style=color:#e6db74>&#39;App.siteEmail&#39;</span>, <span style=color:#e6db74>&#39;admin@example.com&#39;</span>);   <span style=color:#75715e>// Queued
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>$settings<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>set</span>(<span style=color:#e6db74>&#39;App.maintenance&#39;</span>, <span style=color:#66d9ef>false</span>);               <span style=color:#75715e>// Queued
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>$settings<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>set</span>(<span style=color:#e6db74>&#39;Email.fromAddress&#39;</span>, <span style=color:#e6db74>&#39;noreply@example.com&#39;</span>);  <span style=color:#75715e>// Queued
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ... end of request, post_system event triggers ...
</span></span></span><span style=display:flex><span><span style=color:#75715e>// Now: 1 SELECT + 1 batch INSERT + 1 batch UPDATE (for all changes)
</span></span></span></code></pre></div><p><strong>Result:</strong> 1 SELECT + 2 batch operations, regardless of how many properties you modify.</p><p>This works for both <code>DatabaseHandler</code> and <code>FileHandler</code>:</p><ul><li><strong>DatabaseHandler</strong>: Uses <code>insertBatch()</code> and <code>updateBatch()</code> to minimize queries</li><li><strong>FileHandler</strong>: Groups changes by class+context and writes each file once</li></ul><h3 id=the-implementation-challenge>The Implementation Challenge<a hidden class=anchor aria-hidden=true href=#the-implementation-challenge>#</a></h3><p>The core logic is straightforward—track pending changes in an array and persist them during the <code>post_system</code> event:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>array</span> $pendingProperties <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>set</span>(<span style=color:#a6e22e>string</span> $class, <span style=color:#a6e22e>string</span> $property, $value, <span style=color:#f92672>?</span><span style=color:#a6e22e>string</span> $context)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> ($this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>deferWrites</span>) {
</span></span><span style=display:flex><span>        $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>markPending</span>($class, $property, $value, $context);
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>persist</span>($class, $property, $value, $context);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>setStored</span>($class, $property, $value, $context);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>markPending</span>(<span style=color:#a6e22e>string</span> $class, <span style=color:#a6e22e>string</span> $property, $value, <span style=color:#f92672>?</span><span style=color:#a6e22e>string</span> $context)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    $key <span style=color:#f92672>=</span> $class <span style=color:#f92672>.</span> <span style=color:#e6db74>&#39;::&#39;</span> <span style=color:#f92672>.</span> $property <span style=color:#f92672>.</span> ($context <span style=color:#f92672>===</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>?</span> <span style=color:#e6db74>&#39;&#39;</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;::&#39;</span> <span style=color:#f92672>.</span> $context);
</span></span><span style=display:flex><span>    $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>pendingProperties</span>[$key] <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;class&#39;</span>    <span style=color:#f92672>=&gt;</span> $class,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;property&#39;</span> <span style=color:#f92672>=&gt;</span> $property,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;value&#39;</span>    <span style=color:#f92672>=&gt;</span> $value,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;context&#39;</span>  <span style=color:#f92672>=&gt;</span> $context,
</span></span><span style=display:flex><span>    ];
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>At the end of the request, CodeIgniter fires the <code>post_system</code> event, which triggers:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#a6e22e>Events</span><span style=color:#f92672>::</span><span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#39;post_system&#39;</span>, [$this, <span style=color:#e6db74>&#39;persistPendingProperties&#39;</span>]);
</span></span></code></pre></div><p>So far, so good. But here&rsquo;s where I hit a wall.</p><h3 id=the-unique-index-problem>The Unique Index Problem<a hidden class=anchor aria-hidden=true href=#the-unique-index-problem>#</a></h3><p>My database table schema looked like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> settings (
</span></span><span style=display:flex><span>    id INT AUTO_INCREMENT <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>class</span> VARCHAR(<span style=color:#ae81ff>255</span>) <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>key</span> VARCHAR(<span style=color:#ae81ff>255</span>) <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,
</span></span><span style=display:flex><span>    value TEXT,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>type</span> VARCHAR(<span style=color:#ae81ff>31</span>) <span style=color:#66d9ef>DEFAULT</span> <span style=color:#e6db74>&#39;string&#39;</span>,
</span></span><span style=display:flex><span>    context VARCHAR(<span style=color:#ae81ff>255</span>) <span style=color:#66d9ef>DEFAULT</span> <span style=color:#66d9ef>NULL</span>,
</span></span><span style=display:flex><span>    created_at DATETIME <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,
</span></span><span style=display:flex><span>    updated_at DATETIME <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>
</span></span><span style=display:flex><span>);
</span></span></code></pre></div><p>To prevent duplicate settings, I needed a unique constraint on <code>(class, key, context)</code>. My first instinct:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>UNIQUE</span> <span style=color:#66d9ef>INDEX</span> idx_unique_setting <span style=color:#66d9ef>ON</span> settings (<span style=color:#66d9ef>class</span>, <span style=color:#66d9ef>key</span>, context);
</span></span></code></pre></div><p>This worked perfectly in SQL Server. But when I tested on MySQL and PostgreSQL, I could insert multiple rows with the same <code>class</code> and <code>key</code> when <code>context</code> was NULL:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> settings (<span style=color:#66d9ef>class</span>, <span style=color:#66d9ef>key</span>, context, ...) <span style=color:#66d9ef>VALUES</span> (<span style=color:#e6db74>&#39;App\Config&#39;</span>, <span style=color:#e6db74>&#39;siteName&#39;</span>, <span style=color:#66d9ef>NULL</span>, ...);
</span></span><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> settings (<span style=color:#66d9ef>class</span>, <span style=color:#66d9ef>key</span>, context, ...) <span style=color:#66d9ef>VALUES</span> (<span style=color:#e6db74>&#39;App\Config&#39;</span>, <span style=color:#e6db74>&#39;siteName&#39;</span>, <span style=color:#66d9ef>NULL</span>, ...);
</span></span><span style=display:flex><span><span style=color:#75715e>-- Both succeed! Duplicates created.
</span></span></span></code></pre></div><h4 id=why-does-this-happen>Why Does This Happen?<a hidden class=anchor aria-hidden=true href=#why-does-this-happen>#</a></h4><p><strong>TL;DR:</strong> Most databases treat NULL as &ldquo;unknown&rdquo;, and two unknowns are never equal—even to each other.</p><p>Here&rsquo;s the SQL standard behavior:</p><ul><li><strong>MySQL/MariaDB</strong>: NULL values are not considered equal in unique indexes. Multiple NULLs are allowed.</li><li><strong>PostgreSQL</strong>: Same behavior: NULL != NULL for unique constraints.</li><li><strong>SQLite3</strong>: Same behavior.</li><li><strong>SQL Server (SQLSRV)</strong>: Treats NULLs as equal by default in unique constraints (non-standard).</li></ul><p>So my unique index only worked in SQL Server. Everywhere else, it allowed unlimited duplicates when <code>context</code> was NULL.</p><h4 id=the-fix-application-level-duplicate-prevention>The Fix: Application-Level Duplicate Prevention<a hidden class=anchor aria-hidden=true href=#the-fix-application-level-duplicate-prevention>#</a></h4><p>Since I couldn&rsquo;t rely on database constraints for portability, I moved the duplicate prevention into the application layer. The <code>persistPendingProperties()</code> method in <code>DatabaseHandler</code> now:</p><ol><li><strong>Fetches existing records</strong> that match pending changes</li><li><strong>Builds a lookup map</strong> to identify which pending properties already exist</li><li><strong>Separates inserts from updates</strong> based on existence</li><li><strong>Executes batch operations</strong> for both inserts and updates</li></ol><p>Here&rsquo;s the core logic (simplified):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>persistPendingProperties</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Separate deletes from upserts
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    $deletes <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span>    $upserts <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>foreach</span> ($this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>pendingProperties</span> <span style=color:#66d9ef>as</span> $info) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> ($info[<span style=color:#e6db74>&#39;delete&#39;</span>]) {
</span></span><span style=display:flex><span>            $deletes[] <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#39;class&#39;</span> <span style=color:#f92672>=&gt;</span> $info[<span style=color:#e6db74>&#39;class&#39;</span>], <span style=color:#e6db74>&#39;key&#39;</span> <span style=color:#f92672>=&gt;</span> $info[<span style=color:#e6db74>&#39;property&#39;</span>], <span style=color:#e6db74>&#39;context&#39;</span> <span style=color:#f92672>=&gt;</span> $info[<span style=color:#e6db74>&#39;context&#39;</span>]];
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            $upserts[] <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#39;class&#39;</span>   <span style=color:#f92672>=&gt;</span> $info[<span style=color:#e6db74>&#39;class&#39;</span>],
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#39;key&#39;</span>     <span style=color:#f92672>=&gt;</span> $info[<span style=color:#e6db74>&#39;property&#39;</span>],
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#39;value&#39;</span>   <span style=color:#f92672>=&gt;</span> $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>prepareValue</span>($info[<span style=color:#e6db74>&#39;value&#39;</span>]),
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#39;type&#39;</span>    <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>gettype</span>($info[<span style=color:#e6db74>&#39;value&#39;</span>]),
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#39;context&#39;</span> <span style=color:#f92672>=&gt;</span> $info[<span style=color:#e6db74>&#39;context&#39;</span>],
</span></span><span style=display:flex><span>            ];
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>db</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>transStart</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> ($upserts <span style=color:#f92672>!==</span> []) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Fetch existing records for our pending data
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>buildOrWhereConditions</span>($upserts, <span style=color:#e6db74>&#39;class&#39;</span>, <span style=color:#e6db74>&#39;key&#39;</span>, <span style=color:#e6db74>&#39;context&#39;</span>);
</span></span><span style=display:flex><span>        $existing <span style=color:#f92672>=</span> $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>builder</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>get</span>()<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>getResultArray</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Build map: composite key =&gt; record ID
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        $existingMap <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>foreach</span> ($existing <span style=color:#66d9ef>as</span> $row) {
</span></span><span style=display:flex><span>            $key <span style=color:#f92672>=</span> $row[<span style=color:#e6db74>&#39;class&#39;</span>] <span style=color:#f92672>.</span> <span style=color:#e6db74>&#39;::&#39;</span> <span style=color:#f92672>.</span> $row[<span style=color:#e6db74>&#39;key&#39;</span>] <span style=color:#f92672>.</span> ($row[<span style=color:#e6db74>&#39;context&#39;</span>] <span style=color:#f92672>??</span> <span style=color:#e6db74>&#39;&#39;</span>);
</span></span><span style=display:flex><span>            $existingMap[$key] <span style=color:#f92672>=</span> $row[<span style=color:#e6db74>&#39;id&#39;</span>];
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Separate into inserts (new) and updates (existing)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        $inserts <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span>        $updates <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>foreach</span> ($upserts <span style=color:#66d9ef>as</span> $row) {
</span></span><span style=display:flex><span>            $key <span style=color:#f92672>=</span> $row[<span style=color:#e6db74>&#39;class&#39;</span>] <span style=color:#f92672>.</span> <span style=color:#e6db74>&#39;::&#39;</span> <span style=color:#f92672>.</span> $row[<span style=color:#e6db74>&#39;key&#39;</span>] <span style=color:#f92672>.</span> ($row[<span style=color:#e6db74>&#39;context&#39;</span>] <span style=color:#f92672>??</span> <span style=color:#e6db74>&#39;&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>isset</span>($existingMap[$key])) {
</span></span><span style=display:flex><span>                <span style=color:#75715e>// Already exists - update it
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                $updates[] <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#39;id&#39;</span>    <span style=color:#f92672>=&gt;</span> $existingMap[$key],
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#39;value&#39;</span> <span style=color:#f92672>=&gt;</span> $row[<span style=color:#e6db74>&#39;value&#39;</span>],
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#39;type&#39;</span>  <span style=color:#f92672>=&gt;</span> $row[<span style=color:#e6db74>&#39;type&#39;</span>],
</span></span><span style=display:flex><span>                ];
</span></span><span style=display:flex><span>            } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>                <span style=color:#75715e>// New record - insert it
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                $inserts[] <span style=color:#f92672>=</span> $row;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> ($inserts <span style=color:#f92672>!==</span> []) {
</span></span><span style=display:flex><span>            $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>builder</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>insertBatch</span>($inserts);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> ($updates <span style=color:#f92672>!==</span> []) {
</span></span><span style=display:flex><span>            $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>builder</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>updateBatch</span>($updates, <span style=color:#e6db74>&#39;id&#39;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Handle deletes
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> ($deletes <span style=color:#f92672>!==</span> []) {
</span></span><span style=display:flex><span>        $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>buildOrWhereConditions</span>($deletes, <span style=color:#e6db74>&#39;class&#39;</span>, <span style=color:#e6db74>&#39;key&#39;</span>, <span style=color:#e6db74>&#39;context&#39;</span>);
</span></span><span style=display:flex><span>        $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>builder</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>delete</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>db</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>transComplete</span>();
</span></span><span style=display:flex><span>    $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>pendingProperties</span> <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This approach:</p><ul><li><strong>Works across all database engines</strong> (MySQL, PostgreSQL, SQLite, SQL Server)</li><li><strong>Prevents duplicates reliably</strong> through application logic</li><li><strong>Maintains batch efficiency</strong> with <code>insertBatch()</code> and <code>updateBatch()</code></li><li><strong>Handles edge cases</strong> like forgetting and then re-setting a property</li></ul><h3 id=filehandler-a-different-take>FileHandler: A Different Take<a hidden class=anchor aria-hidden=true href=#filehandler-a-different-take>#</a></h3><p>Interestingly, the <code>FileHandler</code> doesn&rsquo;t face this problem at all. Since files are organized by <code>class+context</code> combination:</p><pre tabindex=0><code>writable/settings/
  ├── App_Config.php                    &lt;- App\Config class, null context
  ├── Email_Config.php                  &lt;- Email\Config class, null context
  └── a1b2c3d4e5f6/                     &lt;- hash(&#39;xxh128&#39;, &#39;production&#39;)
      ├── App_Config.php
      └── Email_Config.php
</code></pre><p>Each file is self-contained. When persisting changes, the handler:</p><ol><li>Groups pending properties by <code>class+context</code></li><li>For each group, acquire an exclusive file lock</li><li>Reads current data, merges changes, writes back</li><li>Releases the lock</li></ol><p>No database, no NULL behavior quirks. The filesystem naturally enforces uniqueness.</p><h3 id=lessons-learned>Lessons Learned<a hidden class=anchor aria-hidden=true href=#lessons-learned>#</a></h3><h5 id=1-database-portability-is-hard>1. Database Portability is Hard<a hidden class=anchor aria-hidden=true href=#1-database-portability-is-hard>#</a></h5><p>What seems like basic functionality (unique constraints with nullable columns) has surprising edge cases. Always test across multiple database engines when building portable libraries.</p><h5 id=2-null-is-special>2. NULL is Special<a hidden class=anchor aria-hidden=true href=#2-null-is-special>#</a></h5><p>SQL&rsquo;s three-valued logic (TRUE, FALSE, UNKNOWN) makes NULL values behave in ways that aren&rsquo;t always intuitive. <code>NULL != NULL</code> is one of those SQL quirks that will eventually catch you off guard.</p><h5 id=3-application-logic-can-compensate>3. Application Logic Can Compensate<a hidden class=anchor aria-hidden=true href=#3-application-logic-can-compensate>#</a></h5><p>When database features aren&rsquo;t portable, moving logic to the application layer can provide consistent behavior. The cost: slightly more complex code. The benefit: it works everywhere.</p><h5 id=4-batch-operations-are-your-friend>4. Batch Operations Are Your Friend<a hidden class=anchor aria-hidden=true href=#4-batch-operations-are-your-friend>#</a></h5><p>Even with the extra SELECT query to identify existing records, batching inserts and updates together is still dramatically faster than individual operations. The performance gains of deferred writes are real.</p><h3 id=performance-impact>Performance Impact<a hidden class=anchor aria-hidden=true href=#performance-impact>#</a></h3><p>In realistic scenarios (10+ settings updated per request), deferred writes reduce database queries by 70-80%. The overhead of the duplicate-detection SELECT is negligible compared to the savings from batch operations.</p><p>For file-based storage, the impact is even more dramatic—one file write instead of 10.</p><h3 id=tradeoffs>Tradeoffs<a hidden class=anchor aria-hidden=true href=#tradeoffs>#</a></h3><p>Deferred writes aren&rsquo;t without costs:</p><ul><li><strong>Write operations won&rsquo;t appear in CodeIgniter&rsquo;s Debug Toolbar</strong> (the <code>post_system</code> event runs after toolbar data collection)</li><li><strong>Early termination loses pending writes</strong> (fatal errors, <code>exit()</code>, etc.)</li><li><strong>Failures are logged, not thrown</strong> (exceptions during <code>post_system</code> would disrupt shutdown)</li></ul><p>For most applications, these tradeoffs are worth it. If you need immediate persistence guarantees, stick with <code>deferWrites = false</code>.</p><h3 id=try-it-yourself>Try It Yourself<a hidden class=anchor aria-hidden=true href=#try-it-yourself>#</a></h3><p>Enable deferred writes in your <code>app/Config/Settings.php</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#66d9ef>public</span> $database <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;class&#39;</span>       <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>DatabaseHandler</span><span style=color:#f92672>::</span><span style=color:#a6e22e>class</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;table&#39;</span>       <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;settings&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;deferWrites&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Or for FileHandler
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>public</span> $file <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;class&#39;</span>       <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>FileHandler</span><span style=color:#f92672>::</span><span style=color:#a6e22e>class</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;path&#39;</span>        <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>WRITEPATH</span> <span style=color:#f92672>.</span> <span style=color:#e6db74>&#39;settings&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;deferWrites&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>];
</span></span></code></pre></div><p>In the end, deferred writes turned out to be a small feature with a big impact. They&rsquo;re portable, fast, and already reducing unnecessary I/O for CI4 applications.</p><p>Hopefully, this breakdown helps anyone who wants to understand the internals or build on the idea further.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://michalsn.dev/tags/codeigniter4/>Codeigniter4</a></li><li><a href=https://michalsn.dev/tags/settings/>Settings</a></li><li><a href=https://michalsn.dev/tags/database/>Database</a></li></ul><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Deferred Writes: Performance Optimization and Database Gotchas on x" href="https://x.com/intent/tweet/?text=Deferred%20Writes%3a%20Performance%20Optimization%20and%20Database%20Gotchas&amp;url=https%3a%2f%2fmichalsn.dev%2fposts%2fdeferred-writes%2f&amp;hashtags=codeigniter4%2csettings%2cdatabase"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Deferred Writes: Performance Optimization and Database Gotchas on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fmichalsn.dev%2fposts%2fdeferred-writes%2f&amp;title=Deferred%20Writes%3a%20Performance%20Optimization%20and%20Database%20Gotchas&amp;summary=Deferred%20Writes%3a%20Performance%20Optimization%20and%20Database%20Gotchas&amp;source=https%3a%2f%2fmichalsn.dev%2fposts%2fdeferred-writes%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Deferred Writes: Performance Optimization and Database Gotchas on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fmichalsn.dev%2fposts%2fdeferred-writes%2f&title=Deferred%20Writes%3a%20Performance%20Optimization%20and%20Database%20Gotchas"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Deferred Writes: Performance Optimization and Database Gotchas on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fmichalsn.dev%2fposts%2fdeferred-writes%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Deferred Writes: Performance Optimization and Database Gotchas on whatsapp" href="https://api.whatsapp.com/send?text=Deferred%20Writes%3a%20Performance%20Optimization%20and%20Database%20Gotchas%20-%20https%3a%2f%2fmichalsn.dev%2fposts%2fdeferred-writes%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Deferred Writes: Performance Optimization and Database Gotchas on telegram" href="https://telegram.me/share/url?text=Deferred%20Writes%3a%20Performance%20Optimization%20and%20Database%20Gotchas&amp;url=https%3a%2f%2fmichalsn.dev%2fposts%2fdeferred-writes%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentColor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Deferred Writes: Performance Optimization and Database Gotchas on ycombinator" href="https://news.ycombinator.com/submitlink?t=Deferred%20Writes%3a%20Performance%20Optimization%20and%20Database%20Gotchas&u=https%3a%2f%2fmichalsn.dev%2fposts%2fdeferred-writes%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer><script src=https://utteranc.es/client.js repo=michalsn/michalsn.dev issue-term=pathname label=comments theme=preferred-color-scheme crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2025 <a href=https://michalsn.dev/>michalsn</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg></a><div id=cookie-notice role=dialog aria-live=polite aria-label="Cookie notice"><div class=inner><span>This website uses third-party cookies and scripts to improve its functionality.</span>
<a id=cookie-notice-accept class="btn btn-primary btn-sm">Approve</a>
<a id=cookie-notice-deny class="btn btn-primary btn-sm">Deny</a>
<a id=cookie-notice-info href=/privacy class="btn btn-primary btn-sm">More info</a></div></div><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>