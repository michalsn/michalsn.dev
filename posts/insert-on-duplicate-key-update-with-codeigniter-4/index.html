<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>INSERT ON DUPLICATE KEY UPDATE with CodeIgniter 4 | michalsn</title>
<meta name=keywords content="mysql,mariadb,sql,codeigniter4">
<meta name=description content="I recently had to use a query with INSERT ON DUPLICATE KEY UPDATE, but CodeIgniter 4 does not have built-in support for this type of query because it is not available in all database drivers.">
<meta name=author content>
<link rel=canonical href=https://michalsn.dev/posts/insert-on-duplicate-key-update-with-codeigniter-4/>
<link crossorigin=anonymous href=/assets/css/stylesheet.min.b9ff4cc257e914dab489bd18086151800e18f91456a5174bf28489210227a659.css integrity="sha256-uf9MwlfpFNq0ib0YCGFRgA4Y+RRWpRdL8oSJIQInplk=" rel="preload stylesheet" as=style>
<script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://michalsn.dev/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://michalsn.dev/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://michalsn.dev/favicon-32x32.png>
<link rel=apple-touch-icon href=https://michalsn.dev/apple-touch-icon.png>
<link rel=mask-icon href=https://michalsn.dev/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<meta name=generator content="Hugo 0.88.1">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-74HSH0WCPE"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-74HSH0WCPE',{anonymize_ip:!1})}</script>
<meta property="og:title" content="INSERT ON DUPLICATE KEY UPDATE with CodeIgniter 4">
<meta property="og:description" content="I recently had to use a query with INSERT ON DUPLICATE KEY UPDATE, but CodeIgniter 4 does not have built-in support for this type of query because it is not available in all database drivers.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://michalsn.dev/posts/insert-on-duplicate-key-update-with-codeigniter-4/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2021-10-15T13:10:11+02:00">
<meta property="article:modified_time" content="2021-10-15T13:10:11+02:00"><meta property="og:site_name" content="michalsn">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="INSERT ON DUPLICATE KEY UPDATE with CodeIgniter 4">
<meta name=twitter:description content="I recently had to use a query with INSERT ON DUPLICATE KEY UPDATE, but CodeIgniter 4 does not have built-in support for this type of query because it is not available in all database drivers.">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://michalsn.dev/posts/"},{"@type":"ListItem","position":2,"name":"INSERT ON DUPLICATE KEY UPDATE with CodeIgniter 4","item":"https://michalsn.dev/posts/insert-on-duplicate-key-update-with-codeigniter-4/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"INSERT ON DUPLICATE KEY UPDATE with CodeIgniter 4","name":"INSERT ON DUPLICATE KEY UPDATE with CodeIgniter 4","description":"I recently had to use a query with INSERT ON DUPLICATE KEY UPDATE, but CodeIgniter 4 does not have built-in support for this type of query because it is not available in all database drivers.\n","keywords":["mysql","mariadb","sql","codeigniter4"],"articleBody":"I recently had to use a query with INSERT ON DUPLICATE KEY UPDATE, but CodeIgniter 4 does not have built-in support for this type of query because it is not available in all database drivers.\nTo start with a basic question - why not use a query with REPLACE? There are several reasons:\n If we are dealing with a table that has a field with AUTO INCREMENT, it is then incremented every time. If we have some foreign key relations with ON DELETE CASCADE option, then this it gonna be a mess, because we will automatically delete data from other tables The last reason is the slowness of queries with REPLACE. Each time we try to perform INSERT, if the data is already there, we perform DELETE operation and then another INSERT.  The INSERT ON DUPLICATE KEY UPDATE query comes to the rescue. It is a remedy for all the above problems.\nOkay, let’s see how we can add support for this type of query to CodeIgniter 4. We will create a Trait class:\nnamespace App\\Traits; trait ExtraModelMethods { /** * Insert on duplicate key update * * @param int|string $id Unique key * @param array|object $data Data * @param bool $escape Escape * * @return bool */ public function insertOnDuplicateUpdate($id, $data, bool $escape = null): bool { $data = $this-transformDataToArray($data, 'update'); $builder = $this-builder(); $update = $builder-set($data, '', $escape)-getCompiledUpdate(false); $insert = $builder-set($this-primaryKey, $id, $escape)-getCompiledInsert(); $update = preg_replace('/UPDATE[\\s\\S]+? SET /', '', $update); return $builder-db()-query(sprintf('%s ON DUPLICATE KEY UPDATE %s', $insert, $update)); } } To use the new method in our model we just need to import our Trait class:\nuse App\\Traits\\ExtraModelMethods; use CodeIgniter\\Model; class ExampleModel extends Model { use ExtraModelMethods; } ","wordCount":"281","inLanguage":"en","datePublished":"2021-10-15T13:10:11+02:00","dateModified":"2021-10-15T13:10:11+02:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://michalsn.dev/posts/insert-on-duplicate-key-update-with-codeigniter-4/"},"publisher":{"@type":"Organization","name":"michalsn","logo":{"@type":"ImageObject","url":"https://michalsn.dev/favicon.ico"}}}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<noscript>
<style type=text/css>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://michalsn.dev/ accesskey=h title="michalsn (Alt + H)">michalsn</a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</span>
</div>
<ul id=menu>
<li>
<a href=https://michalsn.dev/archives title=Archive>
<span>Archive</span>
</a>
</li>
<li>
<a href=https://michalsn.dev/tags title=Tags>
<span>Tags</span>
</a>
</li>
<li>
<a href=https://michalsn.dev/search title="Search (Alt + /)" accesskey=/>
<span>Search</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<h1 class=post-title>
INSERT ON DUPLICATE KEY UPDATE with CodeIgniter 4
</h1>
<div class=post-meta>October 15, 2021&nbsp;·&nbsp;2 min
</div>
</header>
<div class=post-content><p>I recently had to use a query with <strong>INSERT ON DUPLICATE KEY UPDATE</strong>, but CodeIgniter 4 does not have built-in support for this type of query because it is not available in all database drivers.</p>
<p>To start with a basic question - why not use a query with <strong>REPLACE</strong>? There are several reasons:</p>
<ul>
<li>If we are dealing with a table that has a field with <strong>AUTO INCREMENT</strong>, it is then incremented every time.</li>
<li>If we have some foreign key relations with <strong>ON DELETE CASCADE</strong> option, then this it gonna be a mess, because we will automatically delete data from other tables</li>
<li>The last reason is the slowness of queries with <strong>REPLACE</strong>. Each time we try to perform <strong>INSERT</strong>, if the data is already there, we perform <strong>DELETE</strong> operation and then another <strong>INSERT</strong>.</li>
</ul>
<p>The <strong>INSERT ON DUPLICATE KEY UPDATE</strong> query comes to the rescue. It is a remedy for all the above problems.</p>
<p>Okay, let&rsquo;s see how we can add support for this type of query to CodeIgniter 4. We will create a <strong>Trait</strong> class:</p>
<pre tabindex=0><code>namespace App\Traits;

trait ExtraModelMethods
{
    /**
     * Insert on duplicate key update
     *
     * @param int|string   $id     Unique key
     * @param array|object $data   Data
     * @param bool         $escape Escape
     *
     * @return bool
     */
    public function insertOnDuplicateUpdate($id, $data, bool $escape = null): bool
    {
        $data = $this-&gt;transformDataToArray($data, 'update');

        $builder = $this-&gt;builder();
        $update  = $builder-&gt;set($data, '', $escape)-&gt;getCompiledUpdate(false);
        $insert  = $builder-&gt;set($this-&gt;primaryKey, $id, $escape)-&gt;getCompiledInsert();

        $update = preg_replace('/UPDATE[\s\S]+? SET /', '', $update);
        return $builder-&gt;db()-&gt;query(sprintf('%s ON DUPLICATE KEY UPDATE %s', $insert, $update));
    }
}
</code></pre><p>To use the new method in our model we just need to import our <strong>Trait</strong> class:</p>
<pre tabindex=0><code>use App\Traits\ExtraModelMethods;
use CodeIgniter\Model;

class ExampleModel extends Model
{
    use ExtraModelMethods;
}

</code></pre>
</div>
<footer class=post-footer>
<ul class=post-tags>
<li><a href=https://michalsn.dev/tags/mysql/>mysql</a></li>
<li><a href=https://michalsn.dev/tags/mariadb/>mariadb</a></li>
<li><a href=https://michalsn.dev/tags/sql/>sql</a></li>
<li><a href=https://michalsn.dev/tags/codeigniter4/>codeigniter4</a></li>
</ul>
</footer>
</article>
</main>
<footer class=footer>
<span>&copy; 2021 <a href=https://michalsn.dev/>michalsn</a></span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)">
<button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</button>
</a>
<script>let menu=document.getElementById('menu');menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
<script>document.querySelectorAll('pre > code').forEach(b=>{const c=b.parentNode.parentNode,a=document.createElement('button');a.classList.add('copy-code'),a.innerText='copy';function d(){a.innerText='copied!',setTimeout(()=>{a.innerText='copy'},2e3)}a.addEventListener('click',e=>{if('clipboard'in navigator){navigator.clipboard.writeText(b.textContent),d();return}const a=document.createRange();a.selectNodeContents(b);const c=window.getSelection();c.removeAllRanges(),c.addRange(a);try{document.execCommand('copy'),d()}catch(a){}c.removeRange(a)}),c.classList.contains("highlight")?c.appendChild(a):c.parentNode.firstChild==c||(b.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?b.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(a):b.parentNode.appendChild(a))})</script>
</body>
</html>