[{"content":"If you\u0026rsquo;ve ever used CodeIgniter 4\u0026rsquo;s model events with pagination and noticed that your total count doesn\u0026rsquo;t match your filtered results, you\u0026rsquo;re not alone. There\u0026rsquo;s a subtle but significant issue in how the framework handles model events during pagination that can lead to confusing and incorrect behavior.\nThe Problem CodeIgniter 4\u0026rsquo;s model events, particularly beforeFind, are powerful tools for automatically applying filters, scopes, or modifications to your database queries. However, when using pagination, these events create an inconsistency problem.\nConsider this common scenario: you have a model with a beforeFind event that filters records based on user permissions or status. When you call paginate(), the framework performs two separate operations:\nCount Query: countAllResults() is called to determine the total number of records Data Query: findAll() is called to retrieve the actual paginated results The critical issue is that model events are only triggered for the second operation. The countAllResults() method executes independently, without any of your beforeFind event modifications applied. This means your total count includes records that won\u0026rsquo;t appear in your results, leading to incorrect pagination metadata.\nFor example, if you have 100 total records but your beforeFind event filters them down to 30 active records, the pagination will show \u0026ldquo;100 total records\u0026rdquo; while only displaying the 30 filtered ones. This creates confusion for users and can break pagination controls.\nThe Solution To fix this, we have to ensure that model events are triggered before the count operation, maintaining consistency between the total count and the actual results. Here\u0026rsquo;s our enhanced pagination method:\npublic function paginate(?int $perPage = null, string $group = \u0026#39;default\u0026#39;, ?int $page = null, int $segment = 0) { // Since multiple models may use the Pager, the Pager must be shared. $pager = service(\u0026#39;pager\u0026#39;); if ($segment !== 0) { $pager-\u0026gt;setSegment($segment, $group); } $page = $page \u0026gt;= 1 ? $page : $pager-\u0026gt;getCurrentPage($group); // Get the tempPager to estimate required variables, use dummy count of 1 $tempPager = $pager-\u0026gt;store($group, $page, $perPage, 1, $segment); $perPage = $tempPager-\u0026gt;getPerPage($group); $offset = ($page - 1) * $perPage; if ($this-\u0026gt;tempAllowCallbacks) { // Call the before event and check for a return $eventData = $this-\u0026gt;trigger(\u0026#39;beforeFind\u0026#39;, [ \u0026#39;method\u0026#39; =\u0026gt; \u0026#39;findAll\u0026#39;, \u0026#39;limit\u0026#39; =\u0026gt; $perPage, \u0026#39;offset\u0026#39; =\u0026gt; $offset, \u0026#39;singleton\u0026#39; =\u0026gt; false, ]); if (isset($eventData[\u0026#39;returnData\u0026#39;]) \u0026amp;\u0026amp; $eventData[\u0026#39;returnData\u0026#39;] === true) { return $eventData[\u0026#39;data\u0026#39;]; } } // Store it in the Pager library, so it can be paginated in the views. $this-\u0026gt;pager = $pager-\u0026gt;store($group, $page, $perPage, $this-\u0026gt;countAllResults(false), $segment); $perPage = $this-\u0026gt;pager-\u0026gt;getPerPage($group); $offset = ($pager-\u0026gt;getCurrentPage($group) - 1) * $perPage; // Backup since it will be reset in the findAll method $tempAllowCallbacks = $this-\u0026gt;tempAllowCallbacks; $data = $this-\u0026gt;allowCallbacks(false)-\u0026gt;findAll($perPage, $offset); if ($tempAllowCallbacks) { $eventData = $this-\u0026gt;trigger(\u0026#39;afterFind\u0026#39;, [ \u0026#39;data\u0026#39; =\u0026gt; $data, \u0026#39;limit\u0026#39; =\u0026gt; $perPage, \u0026#39;offset\u0026#39; =\u0026gt; $offset, \u0026#39;method\u0026#39; =\u0026gt; \u0026#39;findAll\u0026#39;, \u0026#39;singleton\u0026#39; =\u0026gt; false, ]); return $eventData[\u0026#39;data\u0026#39;]; } return $data; } How It Works The solution addresses the core issue by triggering beforeFind events before calling countAllResults(). Here\u0026rsquo;s the key insight: we use a temporary pager instance with a dummy total count of 1 to determine the actual perPage and offset values that will be used. This allows us to trigger the beforeFind event with accurate pagination parameters.\nOnce the events are triggered and any query modifications are applied, we call countAllResults() to get the correct count that reflects the filtered data. Then we disable callbacks temporarily and call findAll() to avoid duplicate event execution, manually triggering afterFind events if needed.\nImplementation as a Trait To make this solution easily reusable across your models, you can implement it as a trait:\n\u0026lt;?php namespace App\\Models\\Traits; trait EventAwarePagination { public function paginate(?int $perPage = null, string $group = \u0026#39;default\u0026#39;, ?int $page = null, int $segment = 0) { // ... the enhanced pagination method above } } Then use it in your models:\n\u0026lt;?php namespace App\\Models; use CodeIgniter\\Model; use App\\Models\\Traits\\EventAwarePagination; class UserModel extends Model { use EventAwarePagination; protected $table = \u0026#39;users\u0026#39;; protected $beforeFind = [\u0026#39;filterActiveUsers\u0026#39;]; protected function filterActiveUsers(array $data) { $this-\u0026gt;where(\u0026#39;status\u0026#39;, \u0026#39;active\u0026#39;); return $data; } } Backward Compatibility Models without events will behave exactly as before, while models with events will now work \u0026ldquo;correctly\u0026rdquo;. The fix only affects the execution order and ensures events are properly applied to both count and data queries.\nConclusion This solution is elegant, maintains backward compatibility, and can be easily applied to existing codebases through a simple trait implementation.\nIf you\u0026rsquo;re using model events with pagination in CodeIgniter 4, implementing this fix will ensure your users see consistent and accurate pagination data, improving both the reliability and user experience of your application.\n","permalink":"https://michalsn.dev/posts/event-aware-pagination-in-codeigniter4-models/","summary":"Discover why your CodeIgniter 4 pagination shows incorrect total counts when using model events, and implement a simple fix that ensures consistent filtering across both count and result queries.","title":"Event-Aware Pagination in CodeIgniter 4 Models"},{"content":"User impersonation is the ability for an authenticated user with appropriate privileges to assume the identity of another user temporarily. During impersonation, the original user\u0026rsquo;s session is preserved, allowing them to seamlessly return to their own account when the impersonation session ends.\nWhy Implement Impersonation? There are several compelling reasons to implement user impersonation in your web application:\nCustomer Support: Support representatives can experience exactly what a customer sees, making it easier to diagnose and resolve issues without requiring customers to share sensitive information or perform complex troubleshooting steps.\nTesting and Quality Assurance: Developers and QA teams can test features from the perspective of different user roles and permission levels without creating multiple test accounts or constantly switching credentials.\nDebugging User-Specific Issues: When a bug only affects certain users or user types, impersonation allows developers to reproduce the exact conditions and environment where the issue occurs.\nAdministrative Tasks: System administrators can perform actions on behalf of users who may be unavailable or unable to complete certain tasks themselves.\nPrerequisites: Installing and Setting Up Shield Before we implement impersonation, we need to install and configure Shield authentication library for CodeIgniter 4.\nInstalling Shield First, install Shield via Composer:\ncomposer require codeigniter4/shield Initial Shield Setup Run the Shield setup command to generate the necessary configuration files and database migrations:\nphp spark shield:setup This command creates several configuration files in your app/Config directory:\napp/Config/Auth.php app/Config/AuthGroups.php app/Config/AuthToken.php Moving Configuration to Module Structure To keep our impersonation functionality modular and organized, we\u0026rsquo;ll move these configuration files to our custom module structure.\nFirst, create the module directory structure:\nmkdir -p modules/Shield/Config Move the generated configuration files to our module:\nmv app/Config/Auth.php modules/Shield/Config/ mv app/Config/AuthGroups.php modules/Shield/Config/ mv app/Config/AuthToken.php modules/Shield/Config/ Update the namespace in each moved configuration file. Change the namespace from namespace Config; to namespace Modules\\Shield\\Config; in:\nmodules/Shield/Config/Auth.php modules/Shield/Config/AuthGroups.php modules/Shield/Config/AuthToken.php Cleaning Up Default Routes Remove the Shield route registration from your main routes file. Open app/Config/Routes.php and remove this line:\nservice(\u0026#39;auth\u0026#39;)-\u0026gt;routes($routes); We\u0026rsquo;ll handle route registration within our module structure instead.\nSetting Up Module Autoloading Add the module to your app/Config/Autoload.php file:\n// ... public $psr4 = [ APP_NAMESPACE =\u0026gt; APPPATH, \u0026#39;Modules\\Shield\u0026#39; =\u0026gt; ROOTPATH . \u0026#39;modules/Shield\u0026#39;, ]; // ... This PSR-4 autoloading configuration allows us to organize our impersonation code in a clean, modular way that won\u0026rsquo;t interfere with the core Shield functionality.\nCreating the Impersonation Trait The core of our impersonation system is a trait that extends the session authenticator\u0026rsquo;s capabilities. Create modules/Shield/Traits/Impersonable.php:\n\u0026lt;?php declare(strict_types=1); namespace Modules\\Shield\\Traits; use CodeIgniter\\Events\\Events; use CodeIgniter\\HTTP\\Response; use CodeIgniter\\Shield\\Exceptions\\LogicException; trait Impersonable { public function impersonateLogin(int $userId) { if (! $this-\u0026gt;loggedIn() || $this-\u0026gt;isPending() || $this-\u0026gt;isAnonymous()) { throw new LogicException(\u0026#39;User have to be logged in fully to impersonate.\u0026#39;); } $sessionUserInfo = $this-\u0026gt;getSessionUserInfo(); if ($sessionUserInfo[\u0026#39;originalId\u0026#39;] ?? null) { throw new LogicException(\u0026#39;User is already impersonating someone.\u0026#39;); } $originalId = $sessionUserInfo[\u0026#39;id\u0026#39;] ?? null; $this-\u0026gt;user = $this-\u0026gt;provider-\u0026gt;findById($userId); $this-\u0026gt;setSessionUserKey(\u0026#39;originalId\u0026#39;, $originalId); $this-\u0026gt;setSessionUserKey(\u0026#39;id\u0026#39;, $this-\u0026gt;user-\u0026gt;id); Events::trigger(\u0026#39;impersonateLogin\u0026#39;, $this-\u0026gt;user); /** @var Response $response */ $response = service(\u0026#39;response\u0026#39;); // When logged in, ensure cache control headers are in place $response-\u0026gt;noCache(); } public function impersonateLogout() { if (! $this-\u0026gt;loggedIn()) { throw new LogicException(\u0026#39;User have to be logged in fully to impersonate.\u0026#39;); } $sessionUserInfo = $this-\u0026gt;getSessionUserInfo(); if (! $userId = $sessionUserInfo[\u0026#39;originalId\u0026#39;] ?? null) { throw new LogicException(\u0026#39;User is not impersonating anyone.\u0026#39;); } $this-\u0026gt;user = $this-\u0026gt;provider-\u0026gt;findById($userId); $this-\u0026gt;setSessionUserKey(\u0026#39;id\u0026#39;, $this-\u0026gt;user-\u0026gt;id); $this-\u0026gt;removeSessionUserKey(\u0026#39;originalId\u0026#39;); Events::trigger(\u0026#39;impersonateLogout\u0026#39;, $this-\u0026gt;user); /** @var Response $response */ $response = service(\u0026#39;response\u0026#39;); // When logged in, ensure cache control headers are in place $response-\u0026gt;noCache(); } public function isImpersonated(): bool { if ($this-\u0026gt;getSessionUserKey(\u0026#39;originalId\u0026#39;)) { return true; } return false; } } This trait provides three essential methods:\nimpersonateLogin(): Initiates impersonation by storing the original user ID and switching to the target user. It includes safeguards to prevent impersonation chains and ensures only fully authenticated users can impersonate others.\nimpersonateLogout(): Ends the impersonation session and returns to the original user account.\nisImpersonated(): Checks whether the current session is in an impersonation state.\nExtending the Session Authenticator Next, we need to create a custom session authenticator that uses our impersonation trait. Create modules/Shield/Authentication/Authenticators/Session.php:\n\u0026lt;?php declare(strict_types=1); namespace Modules\\Shield\\Authentication\\Authenticators; use CodeIgniter\\Shield\\Authentication\\AuthenticatorInterface; use CodeIgniter\\Shield\\Authentication\\Authenticators\\Session as ShieldSession; use Modules\\Shield\\Traits\\Impersonable; class Session extends ShieldSession implements AuthenticatorInterface { use Impersonable; } This extension maintains full compatibility with Shield\u0026rsquo;s existing session authentication while adding our impersonation capabilities.\nConfiguring the Custom Authenticator Now we need to update our modules/Shield/Config/Auth.php file (which we moved from the app directory earlier) to use our custom session authenticator. Open the file and update the use statement:\n\u0026lt;?php declare(strict_types=1); namespace Modules\\Shield\\Config; // ... // use CodeIgniter\\Shield\\Authentication\\Authenticators\\Session; use Modules\\Shield\\Authentication\\Authenticators\\Session; // ... class Auth extends ShieldAuth { // ... } We have to replace the default use CodeIgniter\\Shield\\Authentication\\Authenticators\\Session; with our custom session authenticator instead.\nCreating the Impersonation Controller Now we\u0026rsquo;ll create a controller to handle impersonation requests. Create modules/Shield/Controllers/Impersonate.php:\n\u0026lt;?php declare(strict_types=1); namespace Modules\\Shield\\Controllers; use App\\Controllers\\BaseController; use CodeIgniter\\Exceptions\\PageNotFoundException; class Impersonate extends BaseController { public function impersonateLogin(int $userId) { if (! auth()-\u0026gt;loggedIn()) { throw PageNotFoundException::forPageNotFound(); } if (! auth()-\u0026gt;user()-\u0026gt;can(\u0026#39;admin.impersonate\u0026#39;)) { throw PageNotFoundException::forPageNotFound(); } $authenticator = auth(\u0026#39;session\u0026#39;)-\u0026gt;getAuthenticator(); $authenticator-\u0026gt;impersonateLogin($userId); return redirect()-\u0026gt;to(config(\u0026#39;Auth\u0026#39;)-\u0026gt;loginRedirect())-\u0026gt;withCookies(); } public function impersonateLogout() { if (! auth()-\u0026gt;loggedIn()) { throw PageNotFoundException::forPageNotFound(); } $authenticator = auth(\u0026#39;session\u0026#39;)-\u0026gt;getAuthenticator(); $authenticator-\u0026gt;impersonateLogout(); return redirect()-\u0026gt;to(config(\u0026#39;Auth\u0026#39;)-\u0026gt;loginRedirect())-\u0026gt;withCookies(); } } The controller provides clean endpoints for starting and ending impersonation sessions. Notice how we throw a PageNotFoundException for unauthenticated users rather than redirecting to a login page - this helps prevent information disclosure about the existence of impersonation functionality.\nSetting Up Routes Create modules/Shield/Config/Routes.php to register our impersonation routes:\n\u0026lt;?php declare(strict_types=1); namespace Modules\\Shield\\Config; use CodeIgniter\\Router\\RouteCollection; /** * @var RouteCollection $routes */ service(\u0026#39;auth\u0026#39;)-\u0026gt;routes($routes); $routes-\u0026gt;get(\u0026#39;login-as/(:num)\u0026#39;, \u0026#39;\\Modules\\Shield\\Controllers\\Impersonate::impersonateLogin/$1\u0026#39;, [\u0026#39;as\u0026#39; =\u0026gt; \u0026#39;login-as\u0026#39;]); $routes-\u0026gt;get(\u0026#39;logout-as\u0026#39;, \u0026#39;\\Modules\\Shield\\Controllers\\Impersonate::impersonateLogout\u0026#39;, [\u0026#39;as\u0026#39; =\u0026gt; \u0026#39;logout-as\u0026#39;]); We\u0026rsquo;re also setting up service('auth')-\u0026gt;routes($routes) here, to maintain all the changes in one place.\nSetting Up Permissions As you may noticed we were checking certain permissions when we try to display a link or actually perform logging as another user. Now, it\u0026rsquo;s time to fill these permissions in the modules/Shield/Config/AuthGroups.php file:\n// ... public array $permissions = [ \u0026#39;admin.impersonate\u0026#39; =\u0026gt; \u0026#39;Can login as a different user\u0026#39;, // ... ]; // ... public array $matrix = [ \u0026#39;superadmin\u0026#39; =\u0026gt; [ \u0026#39;admin.*\u0026#39;, \u0026#39;users.*\u0026#39;, \u0026#39;beta.*\u0026#39;, ], \u0026#39;admin\u0026#39; =\u0026gt; [ \u0026#39;admin.impersonate\u0026#39;, // ... ], // ... ]; // ... Usage Examples Here\u0026rsquo;s how you can implement impersonation in your application views and controllers:\nIn Your Admin Panel View \u0026lt;?php if (auth()-\u0026gt;user()-\u0026gt;can(\u0026#39;admin.impersonate\u0026#39;)): ?\u0026gt; \u0026lt;div class=\u0026#34;user-actions\u0026#34;\u0026gt; \u0026lt;?php if (auth()-\u0026gt;isImpersonated()): ?\u0026gt; \u0026lt;a href=\u0026#34;\u0026lt;?= route_to(\u0026#39;logout-as\u0026#39;) ?\u0026gt;\u0026#34; class=\u0026#34;btn btn-warning\u0026#34;\u0026gt; \u0026lt;i class=\u0026#34;fas fa-sign-out-alt\u0026#34;\u0026gt;\u0026lt;/i\u0026gt; Stop Impersonating \u0026lt;/a\u0026gt; \u0026lt;?php else: ?\u0026gt; \u0026lt;a href=\u0026#34;\u0026lt;?= route_to(\u0026#39;login-as\u0026#39;, $user-\u0026gt;id) ?\u0026gt;\u0026#34; class=\u0026#34;btn btn-primary\u0026#34;\u0026gt; \u0026lt;i class=\u0026#34;fas fa-sign-in-alt\u0026#34;\u0026gt;\u0026lt;/i\u0026gt; Login as \u0026lt;?= esc($user-\u0026gt;username) ?\u0026gt; \u0026lt;/a\u0026gt; \u0026lt;?php endif; ?\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;?php endif; ?\u0026gt; In Your Base Controller You might want to add visual indicators when impersonation is active:\n\u0026lt;?php namespace App\\Controllers; use CodeIgniter\\Controller; class BaseController extends Controller { // ... protected array $data = []; protected function initController() { parent::initController(); // Add impersonation status to view data if (auth()-\u0026gt;loggedIn()) { $this-\u0026gt;data[\u0026#39;isImpersonated\u0026#39;] = auth()-\u0026gt;isImpersonated(); } else { $this-\u0026gt;data[\u0026#39;isImpersonated\u0026#39;] = false; } } } In Your Layout Template Add a visual indicator for impersonation sessions:\n\u0026lt;?php if ($isImpersonated ?? false): ?\u0026gt; \u0026lt;div class=\u0026#34;alert alert-warning impersonation-banner\u0026#34;\u0026gt; \u0026lt;strong\u0026gt;⚠️ Impersonation Active\u0026lt;/strong\u0026gt; You are currently viewing this application as another user. \u0026lt;a href=\u0026#34;\u0026lt;?= route_to(\u0026#39;logout-as\u0026#39;) ?\u0026gt;\u0026#34; class=\u0026#34;btn btn-sm btn-outline-dark ms-2\u0026#34;\u0026gt; Return to Your Account \u0026lt;/a\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;?php endif; ?\u0026gt; Security Considerations When implementing user impersonation, security should be your top priority:\nPermission Checks: Always verify that the impersonating user has appropriate permissions before allowing impersonation. Consider creating a specific permission like admin.impersonate and checking it before showing impersonation links or processing impersonation requests.\nAudit Logging: Log all impersonation activities for security auditing and compliance purposes. You can hook into the impersonateLogin and impersonateLogout events we trigger in our trait.\nSession Security: Our implementation stores the original user ID in the session, which is secure as long as your session storage is properly configured and secured.\nVisual Indicators: Always provide clear visual feedback when impersonation is active so users understand the current context.\nEvent Handling Our implementation triggers events that you can use for logging or additional processing:\n\u0026lt;?php // In your Events.php or a service Events::on(\u0026#39;impersonateLogin\u0026#39;, function ($user) { log_message(\u0026#39;info\u0026#39;, \u0026#39;Impersonation started for user: \u0026#39; . $user-\u0026gt;id); }); Events::on(\u0026#39;impersonateLogout\u0026#39;, function ($user) { log_message(\u0026#39;info\u0026#39;, \u0026#39;Impersonation ended, returned to user: \u0026#39; . $user-\u0026gt;id); }); Conclusion This implementation provides a secure, maintainable way to add user impersonation to your CodeIgniter 4 application using Shield authentication. The modular approach keeps your custom code organized and separate from the core framework, making it easier to maintain and update over time.\nRemember to always implement proper authorization checks in your application logic, maintain audit logs of impersonation activities, and provide clear visual feedback to users when impersonation is active. With these safeguards in place, user impersonation becomes a powerful tool for administration, support, and debugging.\n","permalink":"https://michalsn.dev/posts/impersonation-with-codeigniter-shield/","summary":"Implement secure user impersonation in CodeIgniter 4 using the Shield authentication system and a modular architecture.","title":"Implementing User Impersonation in CodeIgniter Shield"},{"content":"When working with AI applications, orchestrating multiple steps and AI agents can quickly become complex. NeuronAI Workflow system provides an elegant solution for chaining together different operations, from data processing to AI agent interactions. In this post, we\u0026rsquo;ll build a weather-based clothing recommendation system that demonstrates the power of combining Workflows with Agents and Tools.\nWhat We\u0026rsquo;re Building Our application will take a user\u0026rsquo;s location input and provide personalized clothing recommendations based on current weather conditions. The workflow consists of three distinct steps:\nLocation Processing: Extract coordinates from user input using an AI agent with geocoding tools Weather Data Retrieval: Fetch current weather information using external APIs Recommendation Generation: Analyze weather data and provide clothing suggestions Project Overview The application follows NeuronAI\u0026rsquo;s workflow pattern, where each step is represented as a Node, and the flow between nodes is defined by Edges. This approach ensures clean separation of concerns and makes the application easily maintainable and extensible.\nSetting Up the Workflow Structure Let\u0026rsquo;s start by examining our main workflow class:\n\u0026lt;?php namespace Weather; use NeuronAI\\Workflow\\Edge; use NeuronAI\\Workflow\\Workflow; use Weather\\Nodes\\FirstNode; use Weather\\Nodes\\SecondNode; use Weather\\Nodes\\ThirdNode; class WeatherWorkflow extends Workflow { public function nodes(): array { return [ new FirstNode(), new SecondNode(), new ThirdNode(), ]; } public function edges(): array { return [ new Edge(FirstNode::class, SecondNode::class), new Edge(SecondNode::class, ThirdNode::class), ]; } protected function start(): string { return FirstNode::class; } protected function end(): array { return [ ThirdNode::class, ]; } } This workflow definition creates a linear flow: FirstNode → SecondNode → ThirdNode. Each edge represents a transition between nodes, and the workflow state is passed along the chain, accumulating data at each step.\nStep 1: Location Processing with AI Agents and Tools Our first node uses an AI agent to extract geographical coordinates from natural language input. This showcases NeuronAI\u0026rsquo;s ability to combine structured output with tool usage.\nThe Place Agent \u0026lt;?php namespace Weather\\Agents; use NeuronAI\\Agent; use NeuronAI\\Providers\\AIProviderInterface; use NeuronAI\\Providers\\Ollama\\Ollama; use Weather\\Dto\\Coordinates; use Weather\\Tools\\SearchPlaceTool; class PlaceAgent extends Agent { public function provider(): AIProviderInterface { return new Ollama( url: \u0026#39;http://localhost:11434/api/\u0026#39;, model: \u0026#39;qwen3:1.7b\u0026#39;, ); } protected function tools(): array { return [ SearchPlaceTool::make(), ]; } protected function getOutputClass(): string { return Coordinates::class; } } The PlaceAgent demonstrates several key NeuronAI concepts:\nProvider Configuration: We\u0026rsquo;re using Ollama with the lightweight qwen3:1.7b model for fast local inference Tool Integration: The agent has access to a custom SearchPlaceTool that can search for geographical data Structured Output: The agent returns data in the Coordinates DTO format The Place Search Tool \u0026lt;?php namespace Weather\\Tools; use GuzzleHttp\\Client; use NeuronAI\\Tools\\PropertyType; use NeuronAI\\Tools\\Tool; use NeuronAI\\Tools\\ToolProperty; class SearchPlaceTool extends Tool { protected Client $client; public function __construct() { parent::__construct( \u0026#39;place_coordinates\u0026#39;, \u0026#39;Get the coordinates of the place (lat ,lon) which will be used later in the weather api\u0026#39;, ); } protected function properties(): array { return [ new ToolProperty( name: \u0026#39;city\u0026#39;, type: PropertyType::STRING, description: \u0026#39;The city name\u0026#39;, required: true, ), new ToolProperty( name: \u0026#39;country\u0026#39;, type: PropertyType::STRING, description: \u0026#39;The country name\u0026#39;, required: false, ) ]; } public function __invoke(string $city, $country) { $params = [ \u0026#39;city\u0026#39; =\u0026gt; $city, ]; if (! empty($country)) { $params[\u0026#39;country\u0026#39;] = $country; } $response = $this-\u0026gt;getClient()-\u0026gt;get(\u0026#39;/search?format=json\u0026amp;\u0026#39; . http_build_query($params)); if ($response-\u0026gt;getStatusCode() !== 200) { return \u0026#39;Error :(\u0026#39;; } return $response-\u0026gt;getBody()-\u0026gt;getContents(); } protected function getClient(): Client { if (isset($this-\u0026gt;client)) { return $this-\u0026gt;client; } return $this-\u0026gt;client = new Client([ \u0026#39;base_uri\u0026#39; =\u0026gt; \u0026#39;https://nominatim.openstreetmap.org\u0026#39;, ]); } } This tool uses the OpenStreetMap service for geocoding. When the AI agent determines it needs geographical coordinates, it can call this tool with the extracted city and country information.\nCoordinates DTO \u0026lt;?php namespace Weather\\Dto; use NeuronAI\\StructuredOutput\\SchemaProperty; class Coordinates { #[SchemaProperty(description: \u0026#39;The latitude of the place, the value can be negative.\u0026#39;, required: true)] public string $lat; #[SchemaProperty(description: \u0026#39;The longitude of the place, the value can be negative.\u0026#39;, required: true)] public string $lon; } The DTO uses NeuronAI\u0026rsquo;s structured output attributes to ensure the AI agent returns properly formatted coordinate data.\nFirst Node Implementation \u0026lt;?php namespace Weather\\Nodes; use NeuronAI\\Chat\\Messages\\UserMessage; use NeuronAI\\Workflow\\Node; use NeuronAI\\Workflow\\WorkflowState; use Weather\\Agents\\PlaceAgent; use Weather\\Dto\\Coordinates; class FirstNode extends Node { public function run(WorkflowState $state): WorkflowState { $coordinates = PlaceAgent::make()-\u0026gt;structured( new UserMessage($state-\u0026gt;get(\u0026#39;user_input\u0026#39;)), Coordinates::class ); $state-\u0026gt;set(\u0026#39;lat\u0026#39;, $coordinates-\u0026gt;lat); $state-\u0026gt;set(\u0026#39;lon\u0026#39;, $coordinates-\u0026gt;lon); return $state; } } The FirstNode takes the user input from the workflow state, processes it through the PlaceAgent, and stores the resulting coordinates back into the state for the next node to use.\nStep 2: Weather Data Retrieval The second node handles external API integration to fetch weather data:\n\u0026lt;?php namespace Weather\\Nodes; use GuzzleHttp\\Client; use NeuronAI\\Workflow\\Node; use NeuronAI\\Workflow\\WorkflowState; class SecondNode extends Node { public function run(WorkflowState $state): WorkflowState { $client = new Client([ \u0026#39;base_uri\u0026#39; =\u0026gt; \u0026#39;https://api.open-meteo.com\u0026#39;, ]); $params = [ \u0026#39;latitude\u0026#39; =\u0026gt; $state-\u0026gt;get(\u0026#39;lat\u0026#39;), \u0026#39;longitude\u0026#39; =\u0026gt; $state-\u0026gt;get(\u0026#39;lon\u0026#39;), ]; $response = $client-\u0026gt;get(\u0026#39;/v1/forecast?hourly=temperature_2m,rain,uv_index,wind_speed_10m\u0026amp;forecast_days=1\u0026amp;forecast_hours=1\u0026amp;past_hours=1\u0026amp;\u0026#39; . http_build_query($params)); $state-\u0026gt;set( \u0026#39;weather_info\u0026#39;, $response-\u0026gt;getBody()-\u0026gt;getContents() ); return $state; } } This node demonstrates how traditional API calls can seamlessly integrate into NeuronAI workflows. We\u0026rsquo;re using the Open-Meteo API to fetch comprehensive weather data, including:\nMaximum and minimum temperatures Wind speed UV index Rainfall predictions The raw JSON response is stored in the workflow state for processing by the next node.\nStep 3: AI-Powered Clothing Recommendations The final node uses another AI agent to analyze the weather data and provide clothing recommendations:\nWeather Agent \u0026lt;?php namespace Weather\\Agents; use NeuronAI\\Agent; use NeuronAI\\Providers\\AIProviderInterface; use NeuronAI\\Providers\\Ollama\\Ollama; use NeuronAI\\SystemPrompt; class WeatherAgent extends Agent { public function provider(): AIProviderInterface { return new Ollama( url: \u0026#39;http://localhost:11434/api/\u0026#39;, model: \u0026#39;qwen3:1.7b\u0026#39;, ); } public function instructions(): string { return new SystemPrompt( background: [ \u0026#39;You are a fashion and weather expert specializing in recommending appropriate daily outfits based on weather conditions.\u0026#39;, ], steps: [ \u0026#39;Carefully analyze the provided JSON input, noting the unit system (e.g., Celsius or Fahrenheit, km/h or mph).\u0026#39;, \u0026#39;Focus on today\\\u0026#39;s forecasted data: maximum temperature, wind speed, total rainfall, and UV index.\u0026#39;, \u0026#39;Use these weather factors to determine the most suitable outfit that balances comfort, protection, and style.\u0026#39;, ], output: [ \u0026#39;Provide a concise outfit recommendation for today.\u0026#39;, \u0026#39;Mention key clothing items (e.g., light jacket, umbrella, sunglasses) based on the weather conditions.\u0026#39;, \u0026#39;Optionally include a one-line reasoning for your recommendation (e.g., \u0026#34;A light jacket is recommended due to high winds.\u0026#34;).\u0026#39; ] ); } } The WeatherAgent showcases NeuronAI\u0026rsquo;s SystemPrompt builder, which structures the AI\u0026rsquo;s instructions for consistent, high-quality responses. The prompt is carefully crafted to:\nEstablish the agent\u0026rsquo;s expertise domain Provide clear analytical steps Define the expected output format Third Node Implementation \u0026lt;?php namespace Weather\\Nodes; use NeuronAI\\Chat\\Messages\\UserMessage; use NeuronAI\\Workflow\\Node; use NeuronAI\\Workflow\\WorkflowState; use Weather\\Agents\\WeatherAgent; class ThirdNode extends Node { public function run(WorkflowState $state): WorkflowState { $response = WeatherAgent::make()-\u0026gt;chat( new UserMessage($state-\u0026gt;get(\u0026#39;weather_info\u0026#39;)) ); $state-\u0026gt;set(\u0026#39;recommendation\u0026#39;, $response-\u0026gt;getContent()); return $state; } } The ThirdNode feeds the weather JSON data to the WeatherAgent and stores the generated clothing recommendation in the workflow state.\nPutting It All Together The main application entry point demonstrates how simple it is to execute our workflow:\n\u0026lt;?php require __DIR__ . \u0026#39;/vendor/autoload.php\u0026#39;; use NeuronAI\\Workflow\\WorkflowState; use Weather\\WeatherWorkflow; $state = new WorkflowState(); $state-\u0026gt;set(\u0026#39;user_input\u0026#39;, \u0026#39;I live in Poznan, Poland.\u0026#39;); $workflow = new WeatherWorkflow(); $state = $workflow-\u0026gt;run($state); echo $state-\u0026gt;get(\u0026#39;recommendation\u0026#39;); The workflow execution is straightforward:\nCreate a WorkflowState and set the initial user input Instantiate the WeatherWorkflow Execute the workflow with run() Retrieve the final recommendation from the state Key Benefits of This Approach Modularity and Reusability Each node has a single responsibility, making the system easy to maintain and extend. Need to add weather alerts? Simply add a new node. Want to support multiple recommendation styles? Create different agent variations.\nState Management The WorkflowState acts as a shared data store throughout the workflow execution, ensuring all nodes have access to the data they need while maintaining clear data flow.\nError Handling and Debugging Each node can be tested independently, and the workflow state provides visibility into data transformations at each step.\nFlexible AI Integration Different nodes can use different AI providers or models based on their specific requirements. The location extraction might use a small, fast model, while clothing recommendations could benefit from a larger, more sophisticated model.\nExtending the System This basic workflow provides a foundation for more sophisticated features:\nFeedback Loop: Implement user feedback to provide clothing predictions for different locations Personalization: Extend the system to consider user preferences and wardrobe Multi-day Planning: Modify the workflow to provide week-long outfit suggestions Integration: Connect with calendar systems to suggest outfits for specific events Conclusion NeuronAI\u0026rsquo;s Workflow system provides a clean, maintainable way to orchestrate complex AI applications. By combining Agents, Tools, and traditional API integrations within a structured workflow, we can build sophisticated applications that remain easy to understand and extend.\nThe weather clothing recommendation system demonstrates how natural language processing, external API integration, and AI-powered analysis can work together seamlessly. Every component handles its own task, making the whole system easier to understand and use.\nAlthough the Workflow system is still in beta and evolving, it already offers a solid foundation for building modular AI applications. You can explore the full source code for this example on GitHub.\n","permalink":"https://michalsn.dev/posts/getting-started-with-neuronai-workflows/","summary":"Learn how to get started with NeuronAI Workflows by combining simple AI agents, tools, and APIs to automate basic tasks.","title":"Getting Started with NeuronAI Workflows"},{"content":"As your CodeIgniter 4 applications grow in complexity, you might find that the traditional MVC pattern needs an additional layer to handle sophisticated business logic. This is where the MVCM (Model-View-Controller-Manager) pattern becomes valuable.\nWhat are Managers? Managers are classes that sit between your Controllers and Models, handling complex business operations that don\u0026rsquo;t naturally fit into either component. Think of them as coordinators that orchestrate multiple operations to complete a business task.\nConsider a simple example: when a user registers on your website, you might need to:\nValidate the user data Create the user record Create a user profile Send a welcome email While you could put all this logic in your Controller, it would make the controller bloated and hard to test. Managers provide a clean place for this coordination logic.\nWhen to Use Managers Managers are particularly useful when you need to:\nCoordinate multiple models: Operations that involve several database tables or models Handle complex business workflows: Multi-step processes with business rules and validations Integrate external services: Calling APIs, sending emails, or processing payments Manage transactions: Ensuring data consistency across multiple operations Reuse business logic: Logic that needs to be called from controllers, CLI commands, or background jobs A Simple Manager Example Here\u0026rsquo;s how you might structure a UserManager:\n\u0026lt;?php namespace App\\Managers; use App\\Libraries\\Mailer; use App\\Models\\ProfileModel; use App\\Models\\UserModel; use CodeIgniter\\Database\\Exceptions\\DatabaseException; use InvalidArgumentException; class UserManager { protected UserModel $userModel; protected ProfileModel $profileModel; protected Mailer $mailer; public function __construct( ?UserModel $userModel = null, ?ProfileModel $profileModel = null, ?Mailer $mailer = null, ) { $this-\u0026gt;userModel = $userModel ?? model(UserModel::class); $this-\u0026gt;profileModel = $profileModel ?? model(ProfileModel::class); $this-\u0026gt;mailer = $mailer ?? new Mailer(); } public function registerUser($userData, $profileData) { // Business validation (rules that might change based on business logic) $this-\u0026gt;validateBusinessRules($userData); $db = db_connect(); $db-\u0026gt;transException(true)-\u0026gt;transStart(); try { // Create user record $user = $this-\u0026gt;userModel-\u0026gt;createUser($userData); // Create associated profile $profile = $this-\u0026gt;profileModel-\u0026gt;createProfile($user[\u0026#39;id\u0026#39;], $profileData); // Send welcome email using a custom library $this-\u0026gt;mailer-\u0026gt;sendWelcome($user[\u0026#39;email\u0026#39;], $user[\u0026#39;name\u0026#39;]); $db-\u0026gt;transComplete(); return $user; } catch (DatabaseException $e) { $db-\u0026gt;transRollback(); throw $e; } } protected function validateBusinessRules($userData) { // Check if email already exists if ($this-\u0026gt;userModel-\u0026gt;where(\u0026#39;email\u0026#39;, $userData[\u0026#39;email\u0026#39;])-\u0026gt;first()) { throw new InvalidArgumentException(\u0026#39;Email already registered\u0026#39;); } // Check username against prohibited words $prohibitedWords = [\u0026#39;admin\u0026#39;, \u0026#39;root\u0026#39;, \u0026#39;system\u0026#39;]; foreach ($prohibitedWords as $word) { if (str_contains($userData[\u0026#39;name\u0026#39;], $word)) { throw new InvalidArgumentException(\u0026#39;Username contains prohibited words\u0026#39;); } } } } Your Controller then becomes much cleaner:\n\u0026lt;?php namespace App\\Controllers; use App\\Managers\\UserManager; use Exception; class Users extends BaseController { protected UserManager $userManager; public function __construct() { $this-\u0026gt;userManager = new UserManager(); // $this-\u0026gt;userManager = manager(UserManager::class); } public function register() { // HTTP-layer validation (required fields, format, etc.) $rules = [ \u0026#39;user.email\u0026#39; =\u0026gt; \u0026#39;required|valid_email\u0026#39;, \u0026#39;user.password\u0026#39; =\u0026gt; \u0026#39;required|min_length[8]\u0026#39;, \u0026#39;user.name\u0026#39; =\u0026gt; \u0026#39;required|min_length[2]\u0026#39;, \u0026#39;profile.age\u0026#39; =\u0026gt; \u0026#39;permit_empty|integer|greater_than[12]\u0026#39;, ]; if (! $this-\u0026gt;validateData($this-\u0026gt;request-\u0026gt;getPost(), $rules)) { return $this-\u0026gt;response-\u0026gt;setStatusCode(400)-\u0026gt;setJSON([ \u0026#39;status\u0026#39; =\u0026gt; false, \u0026#39;errors\u0026#39; =\u0026gt; $this-\u0026gt;validator-\u0026gt;getErrors(), ]); } $post = $this-\u0026gt;validator-\u0026gt;getValidated(); try { $user = $this-\u0026gt;userManager-\u0026gt;registerUser($post[\u0026#39;user\u0026#39;], $post[\u0026#39;profile\u0026#39;]); return $this-\u0026gt;response-\u0026gt;setJSON([ \u0026#39;status\u0026#39; =\u0026gt; true, \u0026#39;message\u0026#39; =\u0026gt; \u0026#39;Registration successful\u0026#39;, \u0026#39;user\u0026#39; =\u0026gt; $user, ]); } catch (Exception $e) { return $this-\u0026gt;response-\u0026gt;setStatusCode(400)-\u0026gt;setJSON([ \u0026#39;status\u0026#39; =\u0026gt; false, \u0026#39;errors\u0026#39; =\u0026gt; [$e-\u0026gt;getMessage()], ]); } } } Validation in MVCM Validation placement in MVCM is flexible and depends on your application\u0026rsquo;s needs. You have several options:\nAll validation in the Controller - Simple approach for straightforward applications All validation in the Manager - Keeps all business logic centralized Split validation - Separates HTTP concerns from business rules The example above demonstrates the split validation approach, where validation is divided between two layers:\nController Validation handles HTTP concerns:\nRequired fields and basic format checking Data type validation (integer, email, etc.) Request structure validation Manager Validation handles business rules:\nDatabase-dependent checks (uniqueness, relationships) Domain-specific business logic Complex validation requiring multiple data sources This separation ensures controllers fail fast on malformed requests, while business validation remains reusable across different entry points (web controllers, API endpoints, CLI commands).\nExample: A controller validates that an email field is present and properly formatted, while the manager validates that the email isn\u0026rsquo;t already registered in the system.\nChoose the approach that best fits your application\u0026rsquo;s complexity and team preferences.\nOrganizing Managers Like Models and Controllers, Managers should be organized logically:\nStore them in app/Managers Use descriptive names like UserManager, OrderManager, PaymentManager Group related functionality together Keep each Manager focused on a specific domain area Loading Managers Just like CodeIgniter provides the config(), model(), etc. helper functions for loading config files and models, you can create a similar manager() helper for loading managers. Add this function to your app/Common.php file:\n\u0026lt;?php use CodeIgniter\\Config\\Factories; if (! function_exists(\u0026#39;manager\u0026#39;)) { /** * A simple way of getting manager instances from Factories */ function manager(string $name, bool $getShared = true): mixed { return Factories::managers($name, [\u0026#39;getShared\u0026#39; =\u0026gt; $getShared]); } } This allows you to load managers using the same clean syntax as models:\n\u0026lt;?php use App\\Managers\\UserManager; // Instead of this: $this-\u0026gt;userManager = new UserManager(); // You can use this: $this-\u0026gt;userManager = manager(UserManager::class); The manager() helper leverages CodeIgniter\u0026rsquo;s Factories system, providing automatic dependency injection and instance sharing, just like the built-in model() helper.\nBenefits of Using Managers Cleaner Controllers: Controllers focus on HTTP concerns rather than business logic\nReusable Logic: Manager methods can be called from multiple places in your application\nEasier Testing: Business logic can be unit tested independently of HTTP requests\nBetter Organization: Complex workflows have a dedicated, logical place to live\nMaintainability: Changes to business processes are centralized in one location\nKeep in Mind Managers are not always necessary. For simple CRUD operations, the traditional MVC pattern works perfectly. Add Managers when your business logic becomes complex enough to warrant the additional layer.\nThe goal is always cleaner, more maintainable code - not adding complexity for its own sake.\n","permalink":"https://michalsn.dev/posts/beyond-mvc-managers-in-codeigniter/","summary":"Learn how to extend the traditional MVC pattern with Managers in CodeIgniter 4 to handle complex business logic and create more maintainable applications.","title":"Beyond MVC: Adding Managers to Your CodeIgniter 4 Applications"},{"content":"When building applications that serve multiple clients or domains from a single codebase, developers often face the challenge of managing different configurations for each client. This becomes particularly complex when each client requires separate database credentials, API keys, or other environment-specific settings.\nIn this post, we\u0026rsquo;ll explore how to extend CodeIgniter 4 environment configuration system to support multiple .env files, enabling you to maintain separate configurations for each client while keeping your codebase clean and maintainable.\nThe Multi-Tenant Challenge Before diving into the solution, let\u0026rsquo;s understand the problem we\u0026rsquo;re trying to solve. In multi-tenant applications, you typically have two main architectural approaches:\nSingle Database Approach In this approach, all clients share the same database, with data separation handled through tenant identifiers in your database schema. This is simpler to manage and maintain:\nPros: Easy migrations, simpler backup/restore procedures, straightforward analytics across all clients Cons: Data isolation concerns, potential performance bottlenecks, limited customization per client Separate Database Per Client Here, each client gets their own dedicated database instance:\nPros: Complete data isolation, better security, ability to customize schema per client, easier compliance with data regulations Cons: Complex migrations, difficult cross-client analytics, increased maintenance overhead When you choose the separate database approach, you need different database credentials for each client, which is where our .env file challenge begins.\nCodeIgniter 4\u0026rsquo;s Default .env Limitation Out of the box, CodeIgniter 4 supports only a single .env file located in your project root. This file contains environment variables that override your configuration files, making it perfect for storing sensitive information like database credentials, API keys, and other environment-specific settings.\nHowever, when you need different configurations for different clients accessing the same application instance, you need a way to load different .env files based on the current client context.\nThe Solution: Custom Boot Class The solution involves creating a custom Boot class that extends CodeIgniter\u0026rsquo;s base Boot class and overriding the loadDotEnv() method. This approach is clean, maintainable, and doesn\u0026rsquo;t require core framework modifications.\nStep 1: Create the Custom Boot Class First, create a new file app/AppBoot.php:\n\u0026lt;?php declare(strict_types=1); namespace App; use CodeIgniter\\Boot; use CodeIgniter\\Config\\DotEnv; use Config\\Paths; use RuntimeException; /** * Bootstrap for the application * * @codeCoverageIgnore */ class AppBoot extends Boot { /** * Load environment settings from .env files into $_SERVER and $_ENV */ protected static function loadDotEnv(Paths $paths): void { require_once $paths-\u0026gt;systemDirectory . \u0026#39;/Config/DotEnv.php\u0026#39;; $clientName = static::determineClientName(); $envFileName = \u0026#39;.env.\u0026#39; . $clientName; if (file_exists($paths-\u0026gt;appDirectory . \u0026#39;/../\u0026#39; . $envFileName)) { (new DotEnv($paths-\u0026gt;appDirectory . \u0026#39;/../\u0026#39;, $envFileName))-\u0026gt;load(); } else { // Fallback to default .env file (new DotEnv($paths-\u0026gt;appDirectory . \u0026#39;/../\u0026#39;, \u0026#39;.env\u0026#39;))-\u0026gt;load(); } } private static function determineClientName(): string { $host = $_SERVER[\u0026#39;HTTP_HOST\u0026#39;] ?? \u0026#39;\u0026#39;; $host = preg_replace(\u0026#39;/^www\\./\u0026#39;, \u0026#39;\u0026#39;, strtolower($host)); // Hardcoded trusted domains and subdomains $allowedDomains = [ \u0026#39;acmeclient.com\u0026#39; =\u0026gt; \u0026#39;acme\u0026#39;, \u0026#39;client1.myapp.com\u0026#39; =\u0026gt; \u0026#39;client1\u0026#39;, \u0026#39;client2.myapp.com\u0026#39; =\u0026gt; \u0026#39;client2\u0026#39;, ]; if (isset($allowedDomains[$host])) { return $allowedDomains[$host]; } throw new RuntimeException(\u0026#34;Unauthorized domain: {$host}\u0026#34;); } } Step 2: Modify the Bootstrap Process Next, update your public/index.php file to use your custom Boot class:\n\u0026lt;?php use App\\AppBoot; use Config\\Paths; // ... $paths = new Paths(); // LOAD THE FRAMEWORK BOOTSTRAP FILE require $paths-\u0026gt;systemDirectory . \u0026#39;/Boot.php\u0026#39;; // Load our custom bootstrap file require $paths-\u0026gt;appDirectory . \u0026#39;/AppBoot.php\u0026#39;; exit(AppBoot::bootWeb($paths)); Step 3: Create Client-Specific .env Files Now create separate .env files for each client in your project root:\n# .env.client1 database.default.hostname = client1-db.example.com database.default.database = client1_production database.default.username = client1_user database.default.password = super_secure_password_1 app.baseURL = https://client1.myapp.com/ app.indexPage = \u0026#39;\u0026#39; # .env.client2 database.default.hostname = client2-db.example.com database.default.database = client2_production database.default.username = client2_user database.default.password = super_secure_password_2 app.baseURL = https://client2.myapp.com/ app.indexPage = \u0026#39;\u0026#39; Security Considerations File Permissions Ensure your .env files have appropriate permissions:\nchmod 600 .env.* Version Control Add all .env files to your .gitignore:\n.env .env.* !.env.example Best Practices Consistent naming: Use a consistent naming convention for your .env files (e.g., .env.clientname) Documentation: Maintain a README or documentation explaining how to add new clients and their configurations Validation: Implement validation to ensure required environment variables are present for each client Security: Always validate the client name to prevent unauthorized access to other clients\u0026rsquo; configurations through domain spoofing Summary Managing multiple .env files in CodeIgniter 4 for multi-client applications doesn\u0026rsquo;t have to be complicated. By extending the framework\u0026rsquo;s Boot class and implementing smart client detection logic, you can maintain clean separation of concerns while keeping your codebase maintainable.\nRemember that the client detection logic (determineClientName() method) is where you\u0026rsquo;ll implement your specific business rules. You should adapt them to fit your application\u0026rsquo;s unique requirements.\nThis approach provides the flexibility needed for complex multi-tenant applications while preserving the simplicity that makes CodeIgniter 4 so appealing. The separate database approach, while more complex, offers benefits that may be crucial for your specific use case.\n","permalink":"https://michalsn.dev/posts/managing-multiple-env-files-in-codeigniter-4/","summary":"Extend CodeIgniter 4 to support multiple .env files for multi-client applications using a custom Boot class that automatically loads client-specific configurations based on domain detection.","title":"Managing Multiple .env Files for Multi-Client Applications in CodeIgniter 4"},{"content":"When you\u0026rsquo;re scheduling tasks in CodeIgniter 4, it\u0026rsquo;s not uncommon to run into issues where the same task gets triggered before the previous one finishes. This can cause anything from duplicate processing to race conditions and even server slowdowns.\nTo help with that, CodeIgniter Tasks provides a built-in method called singleInstance().\nWhat Is singleInstance()? The singleInstance() method ensures that a task only runs once at a time. If the task is already running, CodeIgniter will skip the next execution to avoid overlapping.\nHere’s how to use it:\n$schedule-\u0026gt;command(\u0026#39;app:my-task\u0026#39;) -\u0026gt;everyFiveMinutes() -\u0026gt;singleInstance(); In this example, if app:my-task is still running when it’s scheduled again in 5 minutes, the new run will be skipped.\nSet a Custom Lock Duration By default, the lock created by singleInstance() lasts as long as the task is running. But what if something goes wrong and the task doesn’t finish cleanly? Or maybe you want to be extra safe and avoid lockouts?\nYou can pass a number of seconds to control how long the lock should last:\n$schedule-\u0026gt;command(\u0026#39;data:sync\u0026#39;) -\u0026gt;everyMinute() -\u0026gt;singleInstance(MINUTE * 10); // Lock lasts 10 minutes Even if the task crashes, the lock will expire after 10 minutes, allowing future runs to proceed.\nWhen Should You Use It? Use singleInstance() when:\nYour task is long-running The task modifies files, databases, or external systems Overlapping executions could cause problems For example:\n$schedule-\u0026gt;command(\u0026#39;emails:send\u0026#39;) -\u0026gt;everyMinute() -\u0026gt;singleInstance(MINUTE * 15); // 15-minute lock to prevent duplicates Schedule Queues as Tasks A recent addition to CodeIgniter Tasks is the ability to schedule queue jobs directly, making it easier to defer work to a background process. Instead of executing heavy logic during the task itself, you can simply dispatch a job:\n$schedule-\u0026gt;queue(\u0026#39;queue\u0026#39;, \u0026#39;job-name\u0026#39;, [\u0026#39;data\u0026#39; =\u0026gt; \u0026#39;array\u0026#39;]) -\u0026gt;everyMinute() -\u0026gt;singleInstance(); This means you can leverage your queue system (like Redis or database-backed queues) for smoother performance and better scalability-while still enjoying the scheduling flexibility of the task scheduler.\nYou can even apply singleInstance() to make sure the job isn’t dispatched more than once while it’s still being processed.\nSummary Using singleInstance() is a simple way to make sure your scheduled tasks don’t step on each other. Whether you’re processing orders, sending emails, or syncing data, it adds a layer of safety - and with optional lock durations, you stay in control even when something goes wrong.\n","permalink":"https://michalsn.dev/posts/scheduling-unique-tasks-with-codeigniter/","summary":"\u003cp\u003eWhen you\u0026rsquo;re scheduling tasks in CodeIgniter 4, it\u0026rsquo;s not uncommon to run into issues where the same task gets triggered before the previous one finishes. This can cause anything from duplicate processing to race conditions and even server slowdowns.\u003c/p\u003e\n\u003cp\u003eTo help with that, \u003ca href=\"https://github.com/codeigniter4/tasks\"\u003eCodeIgniter Tasks\u003c/a\u003e provides a built-in method called \u003ccode\u003esingleInstance()\u003c/code\u003e.\u003c/p\u003e","title":"Scheduling Unique Tasks with CodeIgniter"},{"content":"Job queues help handle background tasks like sending emails, generating reports, or resizing images - keeping your application fast and responsive. But what if you need tasks to run in a specific order? That’s where chained jobs shine.\nWhat Are Chained Jobs? Chained jobs in CodeIgniter Queue allow you to define a sequence of jobs that will be executed one after another, but only if the previous job completes successfully.\nThis is perfect when tasks are dependent on each other - for example:\nGenerate a report Send the report by email With CodeIgniter Queue, chaining these jobs looks like this:\nservice(\u0026#39;queue\u0026#39;)-\u0026gt;chain(function($chain) { $chain -\u0026gt;push(\u0026#39;reports\u0026#39;, \u0026#39;generate-report\u0026#39;, [\u0026#39;userId\u0026#39; =\u0026gt; 123]) -\u0026gt;push(\u0026#39;emails\u0026#39;, \u0026#39;email\u0026#39;, [ \u0026#39;message\u0026#39; =\u0026gt; \u0026#39;Email message goes here\u0026#39;, \u0026#39;userId\u0026#39; =\u0026gt; 123, ]); }); How It Works The first job (generate-report) is added to the queue. When it completes successfully, the second job (email) is automatically dispatched. If any job in the chain fails, the rest are not executed, ensuring consistency. Best Practices Keep jobs focused and independent where possible. Implement retries using tries or error handling to make chains more resilient. Monitor logs to understand where a chain might stop due to failure. Summary Chained jobs let you build dependable multistep workflows - without blocking the user experience. Whether it’s generating reports, sending notifications, or processing files, CodeIgniter Queue makes it clean and efficient.\n","permalink":"https://michalsn.dev/posts/chained-queue-jobs-in-codeigniter/","summary":"\u003cp\u003eJob queues help handle background tasks like sending emails, generating reports, or resizing images - keeping your application fast and responsive. But what if you need tasks to run in a specific order? That’s where chained jobs shine.\u003c/p\u003e","title":"Chained Jobs with CodeIgniter Queue"},{"content":"I\u0026rsquo;ve recently developed a simple yet educational browser-based game called Edu Snake Game. Built with vanilla JavaScript and the Canvas API, this game adds a learning element to the classic Snake gameplay.\nIn Edu Snake Game, players guide a snake to collect the correct letters that complete a word displayed on the screen. For example, in Polish language learning, a player might need to choose between \u0026ldquo;ó\u0026rdquo; or \u0026ldquo;u\u0026rdquo; in words like \u0026ldquo;królik\u0026rdquo;. The game includes multiple word lists that focus on commonly confused spelling patterns.\nOne of the key features of this project is how easy it is to add your own custom word lists. This makes it ideal for extending the game to teach spelling exceptions, vocabulary, or even letter recognition in different languages. Whether you\u0026rsquo;re helping kids learn to spell or building support for less common language rules, the game can be easily adapted to your needs.\nFeel free to try it out: github.com/michalsn/edu-snake-game\n","permalink":"https://michalsn.dev/posts/edu-snake-game-in-vanilla-javascript/","summary":"\u003cp\u003eI\u0026rsquo;ve recently developed a simple yet educational browser-based game called \u003ca href=\"https://github.com/michalsn/edu-snake-game\"\u003eEdu Snake Game\u003c/a\u003e. Built with vanilla JavaScript and the Canvas API, this game adds a learning element to the classic Snake gameplay.\u003c/p\u003e","title":"Edu Snake Game in Vanilla Javascript"},{"content":"Are you building a multi-language application with CodeIgniter 4? Managing translations for your models can be a daunting task, but CodeIgniter Translatable makes it easy and efficient.\nThis lightweight library integrates seamlessly with CodeIgniter 4\u0026rsquo;s model system, allowing you to handle translations directly within your models. This library simplifies the process while maintaining the flexibility you need.\nKey Features Simple Setup: Use generator to prepare basic structure for migrations and models. Dynamic Locale Support: Automatically load translations based on the current locale. Custom Query Support: Retrieve translations efficiently with built-in methods. Integration with CodeIgniter Entities: Works smoothly with CodeIgniter\u0026rsquo;s entity system. Configuration Getting started with CodeIgniter Translatable is easy. Here\u0026rsquo;s a quick overview of how to use it:\nInstall the library: composer require michalsn/codeigniter-translatable Generate skeleton php spark translatable:generate articles Define fields for translation class ArticleTranslationModel extends Model { protected $table = \u0026#39;article_translations\u0026#39;; protected $primaryKey = \u0026#39;id\u0026#39;; protected $returnType = \u0026#39;object\u0026#39;; protected $allowedFields = [\u0026#39;article_id\u0026#39;, \u0026#39;locale\u0026#39;, \u0026#39;title\u0026#39;, \u0026#39;content\u0026#39;]; // ... } Initialize library in the main model class ArticleModel extends Model { use HasTranslations; protected $table = \u0026#39;articles\u0026#39;; protected $primaryKey = \u0026#39;id\u0026#39;; protected $returnType = Article::class; protected $allowedFields = [\u0026#39;author\u0026#39;]; protected $useTimestamps = true; // ... protected function initialize(): void { $this-\u0026gt;initTranslations(ArticleTranslationModel::class); } // ... } Basic usage This library relies on settings from Config\\App::supportedLocales. So please remember to set valid locales there.\nThe data is always gathered based on current locale service('request')-\u0026gt;getLocale();, so we can simply use entity\u0026rsquo;s translate() method, to access current translation.\n$article = model(ArticleModel::class)-\u0026gt;find(1); // will print author echo $article-\u0026gt;author; // will print \u0026#34;en\u0026#34; title echo $article-\u0026gt;translate()-\u0026gt;title; We can also get all translations:\n$article = model(ArticleModel::class)-\u0026gt;withAllTranslations()-\u0026gt;find(1); // will print author echo $article-\u0026gt;author; // will print \u0026#34;en\u0026#34; title echo $article-\u0026gt;translate()-\u0026gt;title; // will print \u0026#34;en\u0026#34; title echo $article-\u0026gt;translate(\u0026#39;en\u0026#39;)-\u0026gt;title; // will print \u0026#34;pl\u0026#34; title echo $article-\u0026gt;translate(\u0026#39;pl\u0026#39;)-\u0026gt;title; For more advanced usage, such as fallback translations or saving translations, check out the documentation.\nSummary This library is designed to save you time and effort when managing multi-language content. By abstracting the complexities of translation management, it allows you to focus on building features for your application rather than reinventing the wheel.\nIf you encounter issues or have feature suggestions, head over to the GitHub repository.\n","permalink":"https://michalsn.dev/posts/effortless-multi-language-content-translation/","summary":"\u003cp\u003eAre you building a multi-language application with CodeIgniter 4? Managing translations for your models can be a daunting task, but \u003cstrong\u003eCodeIgniter Translatable\u003c/strong\u003e makes it easy and efficient.\u003c/p\u003e\n\u003cp\u003eThis lightweight library integrates seamlessly with CodeIgniter 4\u0026rsquo;s model system, allowing you to handle translations directly within your models. This library simplifies the process while maintaining the flexibility you need.\u003c/p\u003e\n\u003ch2 id=\"key-features\"\u003eKey Features\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eSimple Setup:\u003c/strong\u003e Use generator to prepare basic structure for migrations and models.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eDynamic Locale Support:\u003c/strong\u003e Automatically load translations based on the current locale.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eCustom Query Support:\u003c/strong\u003e Retrieve translations efficiently with built-in methods.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eIntegration with CodeIgniter Entities:\u003c/strong\u003e Works smoothly with CodeIgniter\u0026rsquo;s entity system.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"configuration\"\u003eConfiguration\u003c/h2\u003e\n\u003cp\u003eGetting started with \u003cstrong\u003eCodeIgniter Translatable\u003c/strong\u003e is easy. Here\u0026rsquo;s a quick overview of how to use it:\u003c/p\u003e","title":"Effortless multi-language content translation in your models"},{"content":"Integrating OCI8 with a PHP environment can be challenging, but recent updates have simplified the process significantly. Follow this guide to get everything set up seamlessly.\nAdding OCI8 support to PHP Oracle has streamlined the process for adding OCI8 support to PHP. Clear, user-friendly instructions are available in this Gist. Follow the steps outlined to prepare your PHP environment for OCI8.\nSetting up Oracle XE in Docker Once your PHP environment is ready, you can move on to Docker setup. We\u0026rsquo;ll use the Oracle XE image available on Docker Hub: gvenzl/oracle-xe.\nInstalling Colima First, ensure you have Colima installed. Installation is straightforward using Homebrew:\nbrew install colima After installing Colima, start it with the following command:\ncolima start --arch x86_64 --memory 4 Configuring Docker Context Next, switch the Docker context to Colima:\ndocker context use colima Running the Oracle XE Docker Image Finally, run the Oracle XE container using the command below:\ndocker run -d --name oracle-xe -p 1521:1521 \\ -e ORACLE_RANDOM_PASSWORD=true \\ -e APP_USER=ORACLE \\ -e APP_USER_PASSWORD=ORACLE \\ gvenzl/oracle-xe Conclusion That’s it! With OCI8 support in PHP and Oracle XE running in Docker, your environment is ready.\n","permalink":"https://michalsn.dev/posts/setting-up-oci8-and-oracle-xe-with-docker/","summary":"\u003cp\u003eIntegrating OCI8 with a PHP environment can be challenging, but recent updates have simplified the process significantly. Follow this guide to get everything set up seamlessly.\u003c/p\u003e\n\u003ch2 id=\"adding-oci8-support-to-php\"\u003eAdding OCI8 support to PHP\u003c/h2\u003e\n\u003cp\u003eOracle has streamlined the process for adding OCI8 support to PHP. Clear, user-friendly instructions are available in \u003ca href=\"https://gist.github.com/syahzul/d61d8ccea7c5959a84ed52d14159d8a9\"\u003ethis Gist\u003c/a\u003e. Follow the steps outlined to prepare your PHP environment for OCI8.\u003c/p\u003e\n\u003ch2 id=\"setting-up-oracle-xe-in-docker\"\u003eSetting up Oracle XE in Docker\u003c/h2\u003e\n\u003cp\u003eOnce your PHP environment is ready, you can move on to Docker setup. We\u0026rsquo;ll use the Oracle XE image available on Docker Hub: \u003ca href=\"https://hub.docker.com/r/gvenzl/oracle-xe\"\u003egvenzl/oracle-xe\u003c/a\u003e.\u003c/p\u003e","title":"Setting up OCI8 and Oracle XE with Docker on macOS"},{"content":"Efficiently managing database queries is crucial for application performance. To simplify it, I made a nice CodeIgniter 4 library that provides two techniques for loading related data: eager loading and lazy loading.\ncomposer require michalsn/codeigniter-nested-model These approaches allow developers to fetch related models in an efficient and intuitive way. Here\u0026rsquo;s a comprehensive guide to understanding and using these techniques.\nEager Loading Eager loading fetches related data in advance, minimizing the number of database queries. To implement eager loading, you must define the relations between your models.\nDefining Relations In the following example, we have a UserModel with a one-to-one relation to ProfileModel. The HasRelations trait is used to define these relations.\nclass UserModel extends Model { use HasRelations; public function initialize() { $this-\u0026gt;initRelations(); } public function profile(): Relation { return $this-\u0026gt;hasOne(ProfileModel::class); } } Fetching Data To eagerly load data, use the with() method and specify the relation:\n$users = model(UserModel::class)-\u0026gt;with(\u0026#39;profile\u0026#39;)-\u0026gt;findAll(); This code performs two queries: one to fetch all users and another to fetch all profiles associated with these users.\nWriting with Relations Eager loading also supports saving related models. For simple relations like hasOne or hasMany, you can save the entire object with its relations:\n$userModel = model(UserModel::class); $user = $userModel-\u0026gt;with(\u0026#39;profile\u0026#39;)-\u0026gt;find(1); $user-\u0026gt;profile-\u0026gt;favorite_pet = \u0026#39;Cat\u0026#39;; $userModel-\u0026gt;with(\u0026#39;profile\u0026#39;)-\u0026gt;save($user); Using Transactions When saving objects with relations, it\u0026rsquo;s recommended to use the useTransactions() method. This ensures that all changes are rolled back if something goes wrong:\n$userModel-\u0026gt;with(\u0026#39;profile\u0026#39;)-\u0026gt;useTransactions()-\u0026gt;save($user); Lazy Loading Lazy loading fetches related data only when it is accessed. This requires your model to use an Entity as the $returnType.\nDefining Relations for Lazy Loading The setup for lazy loading is similar to eager loading but requires an Entity class. The UserModel must use the HasRelations trait, and the $returnType must be set to an entity class:\nclass UserModel extends Model { use HasRelations; protected $returnType = User::class; public function initialize() { $this-\u0026gt;initRelations(); } public function profile(): Relation { return $this-\u0026gt;hasOne(ProfileModel::class); } } Creating the Entity The entity class must use the HasLazyRelations trait:\nclass User extends Entity { use HasLazyRelations; } Fetching Data With lazy loading, data is retrieved on demand when you access the relation property:\n$users = model(UserModel::class)-\u0026gt;findAll(); foreach ($users as $user) { d($user-\u0026gt;profile); } This approach performs an n+1 query pattern: one query to fetch all users and one additional query for each related profile.\nChoosing Between Eager and Lazy Loading Eager Loading: Best when you know in advance which relations you\u0026rsquo;ll need. Reduces the number of queries by preloading data. Lazy Loading: Useful when you don\u0026rsquo;t know which relations will be accessed. However, it can lead to multiple queries and potential performance issues. Both techniques offer flexibility and help optimize database interactions in CodeIgniter 4. By understanding their strengths and appropriate use cases, you can build more efficient and maintainable applications.\nFor more information, see the project documentation: https://michalsn.github.io/codeigniter-nested-model/\n","permalink":"https://michalsn.dev/posts/codeigniter-model-relations/","summary":"\u003cp\u003eEfficiently managing database queries is crucial for application performance. To simplify it, I made a nice CodeIgniter 4 library that provides two techniques for loading related data: \u003cstrong\u003eeager loading\u003c/strong\u003e and \u003cstrong\u003elazy loading\u003c/strong\u003e.\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003ecomposer require michalsn/codeigniter-nested-model\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThese approaches allow developers to fetch related models in an efficient and intuitive way. Here\u0026rsquo;s a comprehensive guide to understanding and using these techniques.\u003c/p\u003e\n\u003ch2 id=\"eager-loading\"\u003eEager Loading\u003c/h2\u003e\n\u003cp\u003eEager loading fetches related data in advance, minimizing the number of database queries. To implement eager loading, you must define the relations between your models.\u003c/p\u003e","title":"Eager and Lazy Loading in CodeIgniter 4"},{"content":"If you’ve ever wanted to capture info about your users, you might be interested in this little experiment.\nWith features like automatic page view tracking that logs details about your visitors’ browsers, devices, and more, plus the ability to log custom events like clicks, it’s perfect for anyone who enjoys tinkering with web analytics.\nThe PageViewEvents JavaScript class provides a streamlined way to capture and send data about page views and user interactions on your site.\nProject page: https://github.com/michalsn/page-view-events\nKey Features The primary goal of the PageViewEvents class is to capture detailed page view data and user events and send them to specified endpoints for logging or analytics. It provides:\nPage View Tracking: Automatically captures page details such as the visitor\u0026rsquo;s operating system, browser, language, screen resolution, and current URL. Event Tracking: Allows logging of custom user interactions, such as clicks or other specified events, with details about the clicked element and its position within the DOM. Configurable Data Transmission: Choose between sending data via sendBeacon (a background-safe transmission for low-impact tracking) or fetch (for added flexibility). Additionally, you can specify whether data should be sent in JSON format or as plain text. Configuration Options The class provides a few configurable properties to suit various use cases:\nsendMethod: Defines how data is transmitted. Acceptable values are: beacon: Uses navigator.sendBeacon for non-blocking, reliable background data transmission. Recommended for scenarios where low-impact logging is preferred. fetch: Uses the Fetch API for standard HTTP transmission, with keepalive set to true. sendJson: If set to true, data is sent in JSON format with Content-Type: application/json. Otherwise, data is sent as plain text (Content-Type: text/plain), which avoids preflight CORS requests. Getting Started To set up PageViewEvents, simply include it in your project and configure any desired options. Here’s how to integrate and use it:\nLoad the Script Add the JavaScript file to your HTML:\n\u0026lt;script src=\u0026#34;PageViewEvents.js\u0026#34;\u0026gt;\u0026lt;/script\u0026gt; Configuration Define an optional configuration object, specifying the tracking ID (tid), custom URL, and additional settings if needed:\nconst pveConfig = { // Options for sending data sendOptions: { sendMethod: \u0026#34;fetch\u0026#34;, sendJson: true, sendUrl: \u0026#34;https://example.com/log\u0026#34;, }, // Options for initialization initOptions: { tid: \u0026#34;example-site\u0026#34;, lu: false, luid: \u0026#34;abc\u0026#34;, cid: \u0026#34;123\u0026#34;, ip: \u0026#34;127.0.0.1\u0026#34; } }; Initialize and Capture Events Once the script and configuration are in place, initialization of PageViewEvents class is made automatically. By default, all \u0026ldquo;full page load\u0026rdquo; and \u0026ldquo;on click\u0026rdquo; events are logged. But if you want, you can specify any additional events, or log the view page manually.\nExample Use Cases Full page load This is done automatically, but you can also call it manually, if you load the page via AJAX call.\n// Log a page view event pve.view(); This will log a page view event, capturing various details about the visitor’s environment and the page.\nLogging a Custom Event Custom events can be triggered to log user interactions. By default, all on click events are logged automatically.\n// Log a custom event for a button hover const myButton = document.querySelector(\u0026#39;#myButton\u0026#39;); myButton.addEventListener(\u0026#39;mouseover\u0026#39;, (e) =\u0026gt; { pve.event(e.target, \u0026#39;Mouse over Button\u0026#39;); }); In this example, the event logs that the user’s mouse is over a specific button, providing data on the element and additional context.\nExample data This data will be sent to the desired endpoint:\n{ \u0026#34;visitorId\u0026#34;:\u0026#34;c0f8e388...\u0026#34;, \u0026#34;platform\u0026#34;:\u0026#34;MacIntel\u0026#34;, \u0026#34;language\u0026#34;:\u0026#34;pl-PL\u0026#34;, \u0026#34;userAgent\u0026#34;:\u0026#34;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7)...\u0026#34;, \u0026#34;currentUrl\u0026#34;:\u0026#34;http://localhost:8080/\u0026#34;, \u0026#34;referrerUrl\u0026#34;:\u0026#34;\u0026#34;, \u0026#34;timezone\u0026#34;:\u0026#34;Europe/Warsaw\u0026#34;, \u0026#34;screenResolution\u0026#34;:\u0026#34;2560x1080\u0026#34;, \u0026#34;screenSize\u0026#34;:\u0026#34;2560x977\u0026#34;, \u0026#34;windowSize\u0026#34;:\u0026#34;1560x353\u0026#34;, \u0026#34;utcDate\u0026#34;:\u0026#34;2022-10-10 10:20:00\u0026#34;, \u0026#34;eventType\u0026#34;:\u0026#34;on click\u0026#34;, \u0026#34;xPath\u0026#34;:\u0026#34;/html[1]\u0026#34;, \u0026#34;tid\u0026#34;:\u0026#34;example-site\u0026#34;, \u0026#34;lu\u0026#34;:false, \u0026#34;luid\u0026#34;:\u0026#34;\u0026#34;, \u0026#34;cid\u0026#34;:\u0026#34;123\u0026#34;, \u0026#34;visitorIp\u0026#34;:\u0026#34;127.0.0.1\u0026#34; } Summary With the PageViewEvents class, you can efficiently capture and send valuable data on page views and user interactions. The flexibility of using either sendBeacon or fetch, along with the option to send data in JSON or plain text, makes it adaptable to various tracking and analytics setups.\n","permalink":"https://michalsn.dev/posts/user-tracking-with-javascript/","summary":"\u003cp\u003eIf you’ve ever wanted to capture info about your users, you might be interested in this little experiment.\u003c/p\u003e\n\u003cp\u003eWith features like automatic page view tracking that logs details about your visitors’ browsers, devices, and more, plus the ability to log custom events like clicks, it’s perfect for anyone who enjoys tinkering with web analytics.\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003ePageViewEvents\u003c/code\u003e JavaScript class provides a streamlined way to capture and send data about page views and user interactions on your site.\u003c/p\u003e","title":"User tracking with JavaScript"},{"content":"In a traditional CodeIgniter 4 application, setting up alerts is quite simple. We can simply write a few lines of code or use a dedicated library like codeigniter4-alerts.\nThings get complicated, however, when we use htmx and want the alerts to interact with the way it works. Here a library dedicated to work with htmx can come to the rescue.\nInstallation Installation via composer is very simple:\ncomposer require michalsn/codeigniter-htmx-alerts Next, we can add a container in which alerts will be displayed in our view (or main layout).\n\u0026lt;?= alerts()-\u0026gt;container(); ?\u0026gt; Usually it will be just before the closing \u0026lt;/body\u0026gt; tag.\nConfig By default, the view files are build to work with Tabler theme. But you can simply change the view files and adjust them to the look you want.\nTo do so, you have to publish the config file.\nphp spark alerts:publish After this, you can search for the $views property array in app/Config/Alerts.php file.\nUsage Setting an alert is simple as this:\nalerts()-\u0026gt;set(\u0026#39;success\u0026#39;, \u0026#39;Success message goes here.\u0026#39;); You don\u0026rsquo;t have to worry if you\u0026rsquo;re dealing with htmx request or the traditional one. Alerts will be displayed automatically on the page.\n","permalink":"https://michalsn.dev/posts/codeigniter-htmx-alerts/","summary":"\u003cp\u003eIn a traditional CodeIgniter 4 application, setting up alerts is quite simple. We can simply write a few lines of code or use a dedicated library like \u003ca href=\"https://github.com/tattersoftware/codeigniter4-alerts\"\u003ecodeigniter4-alerts\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eThings get complicated, however, when we use \u003ca href=\"https://htmx.org/\"\u003ehtmx\u003c/a\u003e and want the alerts to interact with the way it works. Here a \u003ca href=\"https://github.com/michalsn/codeigniter-htmx-alerts\"\u003elibrary\u003c/a\u003e dedicated to work with htmx can come to the rescue.\u003c/p\u003e\n\u003ch2 id=\"installation\"\u003eInstallation\u003c/h2\u003e\n\u003cp\u003eInstallation via composer is very simple:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003ecomposer require michalsn/codeigniter-htmx-alerts\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eNext, we can add a container in which alerts will be displayed in our view (or main layout).\u003c/p\u003e","title":"Alerts for htmx and CodeIgniter 4"},{"content":"While LLMs, such as the popular GPT family models, are incredibly advanced, they do have their limitations. Primarily, they rely on a static set of knowledge learned during their training phase, which means they might lack specific knowledge on certain topics.\nOne of the key concepts in working with textual data is embeddings. These are representations of text in a dense vector space, where similar items are mapped to nearby points. This technique effectively captures the semantic meaning of words, phrases, and even larger text structures like sentences and paragraphs.\nThis is where Retrieval Augmented Generation (RAG) makes a significant difference. RAG combines information retrieval techniques with text generation, enabling AI to create content based on information it finds in a custom database or text collection. This means more accurate and contextually relevant outputs, tailored to the specific needs of users.\nLet\u0026rsquo;s create sample code, using Ollama, embedding and PHP:\ncomposer require codewithkyrian/chromadb-php modelflow-ai/ollama First we have to seed our data:\n\u0026lt;?php declare(strict_types=1); use Codewithkyrian\\ChromaDB\\ChromaDB; use ModelflowAi\\Ollama\\Ollama; require_once __DIR__ . \u0026#39;/vendor/autoload.php\u0026#39;; $chromaDB = ChromaDB::client(); $client = Ollama::client(); $documents = [ \u0026#34;Llamas are members of the camelid family meaning they\u0026#39;re pretty closely related to vicuñas and camels\u0026#34;, \u0026#34;Llamas were first domesticated and used as pack animals 4,000 to 5,000 years ago in the Peruvian highlands\u0026#34;, \u0026#34;Llamas can grow as much as 6 feet tall though the average llama between 5 feet 6 inches and 5 feet 9 inches tall\u0026#34;, \u0026#34;Llamas weigh between 280 and 450 pounds and can carry 25 to 30 percent of their body weight\u0026#34;, \u0026#34;Llamas are vegetarians and have very efficient digestive systems\u0026#34;, \u0026#34;Llamas live to be about 20 years old, though some only live for 15 years and others live to be 30 years old\u0026#34;, ]; $collection = $chromaDB-\u0026gt;createCollection(\u0026#39;test-collection\u0026#39;); foreach ($documents as $id =\u0026gt; $doc) { $response = $client-\u0026gt;embeddings()-\u0026gt;create([ \u0026#39;model\u0026#39; =\u0026gt; \u0026#39;mxbai-embed-large\u0026#39;, \u0026#39;prompt\u0026#39; =\u0026gt; $doc, ]); $collection-\u0026gt;add( ids: [$id], embeddings: [$response-\u0026gt;embedding], documents: [$doc], ); } Now we can use the data as a context for our prompts:\n\u0026lt;?php declare(strict_types=1); use Codewithkyrian\\ChromaDB\\ChromaDB; use ModelflowAi\\Ollama\\Ollama; require_once __DIR__ . \u0026#39;/vendor/autoload.php\u0026#39;; $chromaDB = ChromaDB::client(); $client = Ollama::client(); $collection = $chromaDB-\u0026gt;getCollection(\u0026#39;test-collection\u0026#39;); $prompt = \u0026#39;What animals are llamas related to?\u0026#39;; $response = $client-\u0026gt;embeddings()-\u0026gt;create([ \u0026#39;model\u0026#39; =\u0026gt; \u0026#39;mxbai-embed-large\u0026#39;, \u0026#39;prompt\u0026#39; =\u0026gt; $prompt, ]); $queryResponse = $collection-\u0026gt;query( queryEmbeddings: [$response-\u0026gt;embedding], nResults: 1, include: [\u0026#39;documents\u0026#39;], ); $data = $queryResponse-\u0026gt;documents[0][0]; $completionResponse = $client-\u0026gt;completion()-\u0026gt;create([ \u0026#39;model\u0026#39; =\u0026gt; \u0026#39;llama2\u0026#39;, \u0026#39;prompt\u0026#39; =\u0026gt; \u0026#34;Using this data: $data. Respond to this prompt: $prompt\u0026#34;, ]); echo \u0026#39;Prompt: \u0026#39; . $prompt; echo \u0026#39;\u0026lt;br\u0026gt;\u0026lt;br\u0026gt;\u0026#39;; echo \u0026#39;Data: \u0026#39; . $data; echo \u0026#39;\u0026lt;br\u0026gt;\u0026lt;br\u0026gt;\u0026#39;; echo \u0026#39;Response:\u0026#39;; echo \u0026#39;\u0026lt;br\u0026gt;\u0026lt;br\u0026gt;\u0026#39;; echo $completionResponse-\u0026gt;response; ","permalink":"https://michalsn.dev/posts/working-with-php-ollama-and-embeddings/","summary":"\u003cp\u003eWhile LLMs, such as the popular GPT family models, are incredibly advanced, they do have their limitations. Primarily, they rely on a static set of knowledge learned during their training phase, which means they might lack specific knowledge on certain topics.\u003c/p\u003e\n\u003cp\u003eOne of the key concepts in working with textual data is embeddings. These are representations of text in a dense vector space, where similar items are mapped to nearby points. This technique effectively captures the semantic meaning of words, phrases, and even larger text structures like sentences and paragraphs.\u003c/p\u003e","title":"Working with PHP, Ollama and embeddings"},{"content":"Markdown Pages project allows you to map Markdown files to collections and easily list or read data from them.\nIn addition to the Markdown parser, we also have the ability to parse YAML sections, where you can put a lot of useful information.\nHow to start:\ncomposer michalsn/codeigniter-markdown-pages Basic usage:\n$markdownPages = service(\u0026#39;markdownpages\u0026#39;, ROOTPATH . \u0026#39;pages\u0026#39;); // Get the first directory $dir = $markdownPages-\u0026gt;dirs()-\u0026gt;first(); echo $dir-\u0026gt;getName() // prints: Quick Start echo $dir-\u0026gt;getSlug() // prints: quick-start foreach($dir-\u0026gt;getFiles()-\u0026gt;items() as $file) { echo $file-\u0026gt;getName(); // prints: Installation echo $file-\u0026gt;getSlug(); // prints: installation echo $file-\u0026gt;getPath(); // prints: quick-start/installation echo $content-\u0026gt;parse()-\u0026gt;getContent(); // prints: parsed markdown from file echo $content-\u0026gt;parse()-\u0026gt;getMeta(); // prints: parsed YAML as key -\u0026gt; value } This project use Collection class pretty much everywhere so please get familiar with it to use this package comfortably.\nThe full documentation is available here.\n","permalink":"https://michalsn.dev/posts/codeigniter-markdown-pages/","summary":"\u003cp\u003eMarkdown Pages project allows you to map Markdown files to collections and easily list or read data from them.\u003c/p\u003e\n\u003cp\u003eIn addition to the Markdown parser, we also have the ability to parse YAML sections, where you can put a lot of useful information.\u003c/p\u003e\n\u003cp\u003eHow to start:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003ecomposer michalsn/codeigniter-markdown-pages\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eBasic usage:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-php\" data-lang=\"php\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e$markdownPages \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eservice\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;markdownpages\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003eROOTPATH\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;pages\u0026#39;\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e// Get the first directory\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e$dir \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e $markdownPages\u003cspan style=\"color:#f92672\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003edirs\u003c/span\u003e()\u003cspan style=\"color:#f92672\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003efirst\u003c/span\u003e();\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#66d9ef\"\u003eecho\u003c/span\u003e $dir\u003cspan style=\"color:#f92672\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003egetName\u003c/span\u003e()\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e// prints: Quick Start\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#66d9ef\"\u003eecho\u003c/span\u003e $dir\u003cspan style=\"color:#f92672\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003egetSlug\u003c/span\u003e()\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e// prints: quick-start\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#66d9ef\"\u003eforeach\u003c/span\u003e($dir\u003cspan style=\"color:#f92672\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003egetFiles\u003c/span\u003e()\u003cspan style=\"color:#f92672\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eitems\u003c/span\u003e() \u003cspan style=\"color:#66d9ef\"\u003eas\u003c/span\u003e $file) {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eecho\u003c/span\u003e $file\u003cspan style=\"color:#f92672\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003egetName\u003c/span\u003e();\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#75715e\"\u003e// prints: Installation\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eecho\u003c/span\u003e $file\u003cspan style=\"color:#f92672\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003egetSlug\u003c/span\u003e();\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#75715e\"\u003e// prints: installation\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eecho\u003c/span\u003e $file\u003cspan style=\"color:#f92672\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003egetPath\u003c/span\u003e();\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#75715e\"\u003e// prints: quick-start/installation\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eecho\u003c/span\u003e $content\u003cspan style=\"color:#f92672\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eparse\u003c/span\u003e()\u003cspan style=\"color:#f92672\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003egetContent\u003c/span\u003e();\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#75715e\"\u003e// prints: parsed markdown from file\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eecho\u003c/span\u003e $content\u003cspan style=\"color:#f92672\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eparse\u003c/span\u003e()\u003cspan style=\"color:#f92672\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003egetMeta\u003c/span\u003e();\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#75715e\"\u003e// prints: parsed YAML as key -\u0026gt; value\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e}\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThis project use \u003ca href=\"https://github.com/lonnieezell/myth-collection\"\u003eCollection\u003c/a\u003e class pretty much everywhere so please get familiar with it to use this package comfortably.\u003c/p\u003e","title":"CodeIgniter Markdown Pages"},{"content":"While CodeIgniter 4 itself doesn\u0026rsquo;t have a built-in queue system, I have built one which rely on the database handler.\nBut what is a queue? It\u0026rsquo;s a system that allows you to schedule and manage background tasks or jobs to be executed in the given order. These jobs can include sending emails, processing data, generating reports, and more. Using a queue system helps offload time-consuming or resource-intensive tasks from the main application, ensuring that the application remains responsive.\nHere is the project repo.\nUpdate 15/12/2023: This project has become the official CodeIgniter Queue project. The repository has been moved to the CodeIgniter4 organization.\nFirst things first. Let\u0026rsquo;s install the package:\ncomposer require michalsn/codeigniter-queue And migrate our database:\nphp spark migrate --all Last thing, during installation is to publish our config file:\nphp spark queue:publish Now, we can create our first Job:\nphp spark queue:job Example And implement our example job in the process method:\n// ... class Example extends BaseJob implements JobInterface { public function process() { $email = service(\u0026#39;email\u0026#39;, null, false); $result = $email -\u0026gt;setTo(\u0026#39;sample@email.com\u0026#39;) -\u0026gt;setSubject(\u0026#39;Sample subject\u0026#39;) -\u0026gt;setMessage($this-\u0026gt;data[\u0026#39;message\u0026#39;]) -\u0026gt;send(false); if (! $result) { throw new Exception($email-\u0026gt;printDebugger(\u0026#39;headers\u0026#39;)); } return $result; } } This job will just send an email. The only variable is a message, which is available via the $this-\u0026gt;data class variable. If sending an email will not be successful, the exception will be thrown. This will indicate that the job failed.\nTo make this job available, we have to add it to the $jobHandlers array in the app\\Config\\Queue.php file.\n// ... use App\\Jobs\\Example; // ... public array $jobHandlers = [ \u0026#39;my-example\u0026#39; =\u0026gt; Example::class ]; // ... This is how we will add our job to the queue:\nservice(\u0026#39;queue\u0026#39;)-\u0026gt;push(\u0026#39;queueName\u0026#39;, \u0026#39;my-example\u0026#39;, [\u0026#39;message\u0026#39; =\u0026gt; \u0026#39;Hello there\u0026#39;]); To start executing the jobs, we have to start the worker:\nphp spark queue:work queueName That\u0026rsquo;s pretty much it. There are many additional option and ways to run a queue worker, though.\nTo learn more you can check the docs.\n","permalink":"https://michalsn.dev/posts/codeigniter-queue/","summary":"\u003cp\u003eWhile CodeIgniter 4 itself doesn\u0026rsquo;t have a built-in queue system, I have built one which rely on the database handler.\u003c/p\u003e\n\u003cp\u003eBut what is a queue? It\u0026rsquo;s a system that allows you to schedule and manage background tasks or jobs to be executed in the given order. These jobs can include sending emails, processing data, generating reports, and more. Using a queue system helps offload time-consuming or resource-intensive tasks from the main application, ensuring that the application remains responsive.\u003c/p\u003e","title":"CodeIgniter Queue"},{"content":"Tags provide a way to organize content and improve the user\u0026rsquo;s experience by helping them discover related articles and navigate through a website\u0026rsquo;s content more efficiently. They are particularly useful in content-heavy websites or blogs where there\u0026rsquo;s a wide range of topics and subjects covered. This blog also uses tags system. These tags help categorize and organize content to make it more accessible and searchable.\nSince there was no tags library for CodeIgniter 4, I decided to write one. The codeigniter-tags is designed to work with many content types at once, so we can use it in many models.\nInstallation via composer is very simple:\ncomposer require michalsn/codeigniter-tags After that we just need to migrate our database:\nphp spark migrate --all Now the only thing left is to initialize the library in our model:\nclass ExampleModel extends BaseModel { use HasTags; // ... protected function initialize() { $this-\u0026gt;initTags(); } // ... } We use HasTags trait and $this-\u0026gt;initTags() to initialize tags.\nNow we have a handy way add tags to our entry, just by specifying them as a string or array:\nmodel(ExampleModel::class)-\u0026gt;save([ \u0026#39;id\u0026#39; =\u0026gt; 1, // this is our field with tags // we can also set it as an array: [\u0026#39;tag1\u0026#39;, \u0026#39;tag2\u0026#39;] \u0026#39;tags\u0026#39; =\u0026gt; \u0026#39;tag1,tag2\u0026#39;, ]); We can also get the entries with tags assigned to them:\nmodel(ExampleModel::class)-\u0026gt;withTags()-\u0026gt;findAll(); For more detailed info, you can see the docs.\n","permalink":"https://michalsn.dev/posts/codeigniter-tags/","summary":"\u003cp\u003eTags provide a way to organize content and improve the user\u0026rsquo;s experience by helping them discover related articles and navigate through a website\u0026rsquo;s content more efficiently. They are particularly useful in content-heavy websites or blogs where there\u0026rsquo;s a wide range of topics and subjects covered.\nThis blog also uses tags system. These tags help categorize and organize content to make it more accessible and searchable.\u003c/p\u003e\n\u003cp\u003eSince there was no tags library for CodeIgniter 4, I decided to write one. The \u003ca href=\"https://github.com/michalsn/codeigniter-tags\"\u003ecodeigniter-tags\u003c/a\u003e is designed to work with many content types at once, so we can use it in many models.\u003c/p\u003e","title":"CodeIgniter Tags"},{"content":"Auth0 is a cloud-based service that helps developers add secure user authentication and authorization features to their applications without having to build these components from scratch. Auth0 is designed to simplify the process of implementing user authentication, including features like single sign-on (SSO), multi-factor authentication (MFA), and social login.\nAuth0 allows you to add basic authentication functionality very quickly by delegating it to an external platform, but we should always consider whether such a solution definitely suits us.\nIn the past I have written about the integration of CodeIgniter 4 and the auth0 v7 package, but now I wanted to present the package I created for v8.\nYou can head over to the repo to read the instructions.\nInstallation via composer is always simple:\ncomposer require michalsn/codeigniter-auth0 composer require guzzlehttp/guzzle guzzlehttp/psr7 http-interop/http-factory-guzzle Migrate the database. This library also creates its own users table in the database, so if you already have such a table, consider having the same field names in your version.\nphp spark migrate --all The next step is to publish the Auth0 config file into our app namespace:\nphp spark auth0:publish Now we can set all the credentials to our Auth0 account in app\\Config\\Auth0.php file. See the getting started article for reference.\ncodeigniter-auth0 comes with the predefined routes to login, logout and receiving a callback calls.\nTo check if user is authenticated, we can use auth0Stateful filter or write our own implementation.\nWe can also just check this in every request or controller via simple:\nif (! service(\u0026#39;auth0\u0026#39;)-\u0026gt;isAuthenticated()) { // ... } ","permalink":"https://michalsn.dev/posts/auth0-codeigniter-4-package/","summary":"\u003cp\u003e\u003ca href=\"https://auth0.com\"\u003eAuth0\u003c/a\u003e is a cloud-based service that helps developers add secure user authentication and authorization features to their applications without having to build these components from scratch. Auth0 is designed to simplify the process of implementing user authentication, including features like single sign-on (SSO), multi-factor authentication (MFA), and social login.\u003c/p\u003e\n\u003cp\u003eAuth0 allows you to add basic authentication functionality very quickly by delegating it to an external platform, but we should always consider whether such a solution definitely suits us.\u003c/p\u003e","title":"Auth0 CodeIgniter 4 package"},{"content":"Kinde is an identity and access management platform that provides authentication and authorization services for web applications. It\u0026rsquo;s one of the direct auth0 competitors.\nThe first thing that strikes you from the business side is that we get more options in the free version as well as higher limits for active users. It is also less expensive than auth0 when we finally reach the free limits. For startups that often use a cloud-based authentication model, this is a significant convenience.\nAnyway, back to the library. Installation of codeigniter-kinde is pretty basic:\ncomposer require michalsn/codeigniter-kinde Then we have to migrate our database. This library comes with the ready to use users table, so if you have your own users table, be sure to implement all fields that exists in this package.\nphp spark migrate --all Now we have to copy a config file to our\u0026rsquo;s app namespace:\nphp spark kinde:publish The last thing is to fill the config file with our credentials. You can read more about it in the getting started article.\nThis package comes with predefined routes to: login, register, logout and for the callback URL (which is used to finalize authentication). The best part is that you don\u0026rsquo;t have to do anything but just use this URL\u0026rsquo;s in your app. Since login and registration are done via Kinde site, everything is ready to use just few seconds after we fill the config file.\nWe also have a universal kinde filter that can serve as a guard for your app.\nWe can also check things manually in the controller if we want. If we decide to define the permissions, we can also check for them very easy:\nif (authenticated() \u0026amp;\u0026amp; can(\u0026#39;edit_post\u0026#39;)) { // ... } ","permalink":"https://michalsn.dev/posts/using-kinde-with-codeigniter-4/","summary":"\u003cp\u003e\u003ca href=\"https://kinde.com\"\u003eKinde\u003c/a\u003e is an identity and access management platform that provides authentication and authorization services for web applications. It\u0026rsquo;s one of the direct auth0 competitors.\u003c/p\u003e\n\u003cp\u003eThe first thing that strikes you from the business side is that we get more options in the free version as well as higher limits for active users. It is also less expensive than auth0 when we finally reach the free limits. For startups that often use a cloud-based authentication model, this is a significant convenience.\u003c/p\u003e","title":"Using Kinde with CodeIgniter 4"},{"content":"Signing URLs may be very useful when we want to prevent manual URL manipulation or when the given address should have an expiration date. CodeIgniter Signed URL package makes it very easy.\nI have build this library for one particular reason. Some time ago I started experimenting with HTMX and Controlled Cells. These last one will be introduced in CodeIgniter 4.3.\nAnyway, I created some really basic counter component. You can find it in the HTMX demos repo. And one think bodered me. Setting the starting number for the counter was very easy, but what wasn\u0026rsquo;t so easy was setting a custom number by which the counter would increment. Let\u0026rsquo;s see the example:\n\u0026lt;?php namespace Michalsn\\CodeIgniterDemoHtmx\\Cells\\Counter; use CodeIgniter\\View\\Cells\\Cell; class CounterCell extends Cell { public $count = 0; /** * Increment * * @return void */ public function increment() { $this-\u0026gt;count++; return $this-\u0026gt;render(); } /** * Decrement * * @return void */ public function decrement() { $this-\u0026gt;count--; return $this-\u0026gt;render(); } } The view part:\n... \u0026lt;div class=\u0026#34;card-body\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;input-group\u0026#34;\u0026gt; \u0026lt;input type=\u0026#34;text\u0026#34; class=\u0026#34;form-control\u0026#34; value=\u0026#34;\u0026lt;?= $count; ?\u0026gt;\u0026#34;\u0026gt; \u0026lt;button class=\u0026#34;btn btn-primary\u0026#34; type=\u0026#34;button\u0026#34; hx-get=\u0026#34;\u0026lt;?= site_url(\u0026#39;cells/counter/increment?count=\u0026#39; . $count); ?\u0026gt;\u0026#34; hx-swap=\u0026#34;morph:outerHTML\u0026#34; hx-target=\u0026#34;closest .card\u0026#34;\u0026gt; + \u0026lt;/button\u0026gt; \u0026lt;button class=\u0026#34;btn btn-secondary\u0026#34; type=\u0026#34;button\u0026#34; hx-get=\u0026#34;\u0026lt;?= site_url(\u0026#39;cells/counter/decrement?count=\u0026#39; . $count); ?\u0026gt;\u0026#34; hx-swap=\u0026#34;morph:outerHTML\u0026#34; hx-target=\u0026#34;closest .card\u0026#34;\u0026gt; - \u0026lt;/button\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; ... And the initial component call, with two separate instances:\n... \u0026lt;div class=\u0026#34;row justify-content-md-center mb-3\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;col-sm-6 col-lg-3\u0026#34;\u0026gt; \u0026lt;?= view_cell(\u0026#39;Michalsn\\CodeIgniterDemoHtmx\\Cells\\Counter\\CounterCell\u0026#39;); ?\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;col-sm-6 col-lg-3\u0026#34;\u0026gt; \u0026lt;?= view_cell(\u0026#39;Michalsn\\CodeIgniterDemoHtmx\\Cells\\Counter\\CounterCell\u0026#39;, [\u0026#39;count\u0026#39; =\u0026gt; 5]); ?\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; ... Your first impression would be probably something like - that\u0026rsquo;s quite easy task. Just add another variable, like $incrementNumber and call it a day. Well\u0026hellip; yes and no.\nIf we leave it just like that, anyone will be able to edit the URL and increment counter by any number. The point is that we don\u0026rsquo;t want users to be able to change the number by which we will increment the counter in an instance. And this is the time when Signed URLs come to the rescue.\nLet\u0026rsquo;s edit Controlled Cell first:\n\u0026lt;?php namespace Michalsn\\CodeIgniterDemoHtmx\\Cells\\Counter; use CodeIgniter\\View\\Cells\\Cell; class CounterCell extends Cell { public $count = 0; public $incrementNumber = 1; /** * Increment * * @return void */ public function increment() { $this-\u0026gt;count += $this-\u0026gt;incrementNumber; return $this-\u0026gt;render(); } /** * Decrement * * @return void */ public function decrement() { $this-\u0026gt;count -= $this-\u0026gt;incrementNumber; return $this-\u0026gt;render(); } } Now the view part. We will change the way URLs are generated with call to the signedurl() helper:\n... \u0026lt;div class=\u0026#34;card-body\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;input-group\u0026#34;\u0026gt; \u0026lt;input type=\u0026#34;text\u0026#34; class=\u0026#34;form-control\u0026#34; value=\u0026#34;\u0026lt;?= $count; ?\u0026gt;\u0026#34;\u0026gt; \u0026lt;button class=\u0026#34;btn btn-primary\u0026#34; type=\u0026#34;button\u0026#34; hx-get=\u0026#34;\u0026lt;?= signedurl()-\u0026gt;siteUrl(\u0026#39;cells/counter/increment?count=\u0026#39; . $count . \u0026#39;\u0026amp;incrementNumber=\u0026#39; . $incrementNumber); ?\u0026gt;\u0026#34; hx-swap=\u0026#34;morph:outerHTML\u0026#34; hx-target=\u0026#34;closest .card\u0026#34;\u0026gt; + \u0026lt;/button\u0026gt; \u0026lt;button class=\u0026#34;btn btn-secondary\u0026#34; type=\u0026#34;button\u0026#34; hx-get=\u0026#34;\u0026lt;?= signedurl()-\u0026gt;siteUrl(\u0026#39;cells/counter/decrement?count=\u0026#39; . $count . \u0026#39;\u0026amp;incrementNumber=\u0026#39; . $incrementNumber); ?\u0026gt;\u0026#34; hx-swap=\u0026#34;morph:outerHTML\u0026#34; hx-target=\u0026#34;closest .card\u0026#34;\u0026gt; - \u0026lt;/button\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; ... And our initial component calls:\n... \u0026lt;div class=\u0026#34;row justify-content-md-center mb-3\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;col-sm-6 col-lg-3\u0026#34;\u0026gt; \u0026lt;?= view_cell(\u0026#39;Michalsn\\CodeIgniterDemoHtmx\\Cells\\Counter\\CounterCell\u0026#39;); ?\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;col-sm-6 col-lg-3\u0026#34;\u0026gt; \u0026lt;?= view_cell(\u0026#39;Michalsn\\CodeIgniterDemoHtmx\\Cells\\Counter\\CounterCell\u0026#39;, [\u0026#39;count\u0026#39; =\u0026gt; 5, \u0026#39;incrementNumber\u0026#39; =\u0026gt; 5]); ?\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; ... Now we can be sure that no one will manipulate the URL, and components will work the way we initailized them. Of course, we also need a Filter to validate signed URLs, but you can read in the docs on how to use it.\n","permalink":"https://michalsn.dev/posts/codeigniter-signed-url/","summary":"\u003cp\u003eSigning URLs may be very useful when we want to prevent manual URL manipulation or when the given address should have an expiration date. \u003ca href=\"https://github.com/michalsn/codeigniter-signed-url\"\u003eCodeIgniter Signed URL\u003c/a\u003e package makes it very easy.\u003c/p\u003e","title":"CodeIgniter Signed Url"},{"content":"HTMX is gaining in popularity. No wonder, because in a world overflowing with Javascript-based sites that getting more and more complicated to achieve even tiny result, this solution turns out to be a pleasant return to the past - in quite a good way.\nI think we all remember the old days when we wrote in Prototype or jQuery. Back then the option to return HTML chunks was not completely strange. I remember doing it myself - setting various additional options via the data attribute. You usually ended up with one method that tried to do all sorts of requests and update code snippets on the web page depending on the specified container.\nIt all worked, but was somehow not particularly convenient. Fortunately, someone came up with the idea to make a real library that would handle all (or at least most) of the problems we might encounter. And so HTMX was born.\nBut let\u0026rsquo;s move on to how we can make it easier to work with HTMX in CodeIgniter. The CodeIgniter-HTMX library will help us with this.\nThe first thing we need to do is install it:\ncomposer require michalsn/codeigniter-htmx Now at our disposal are a number of additional methods from the IncomingRequest, Response and RedirectResponse classes. In addition, we can use a new helper view_fragment(), which will allow us to display only fragments of the view. The last thing is to facilitate the display of errors, which will now be displayed in the modal window. By default, HTMX does not display errors.\nDetailed documentation can be found here: https://michalsn.github.io/codeigniter-htmx/installation/\nAs a bonus, I also suggest taking a look at the repository with examples. There you can find several demos that will show you how we can use HTMX when building our application. You will find several examples:\nBooks - an example of data displayed in a table with pagination, search, sorting and inline editing. Tasks - an example of how we can use events to load content in a slightly more sophisticated way. Paraghraphs - an example of sorting content and editing it in a modal window. It\u0026rsquo;s time to give HTMX a try.\n","permalink":"https://michalsn.dev/posts/codeigniter-htmx/","summary":"\u003cp\u003e\u003ca href=\"https://htmx.org\"\u003eHTMX\u003c/a\u003e is gaining in popularity. No wonder, because in a world overflowing with Javascript-based sites that getting more and more complicated to achieve even tiny result, this solution turns out to be a pleasant return to the past - in quite a good way.\u003c/p\u003e","title":"CodeIgniter HTMX"},{"content":"How can we handle generation of a custom domain link in CodeIgniter 4? Although this is not a built-in feature, we can deal with it in a fairly simple way.\nSuppose we have an application where each user account is served from its own domain. We can handle this scenarion quite simply through a simple helper:\nUpdate 20/06/2024: The original code used a function that was marked as internal. And as it happens in such cases, this function was removed, with the next update of the framework.\nTherefore, below is already a new version that works:\n// app/Helpers/app_helper.php use CodeIgniter\\HTTP\\SiteURI; use Config\\App; /** * Returns a site URL as defined by Host. * * @param string|array $path URI string * @param string|null $host Host to use */ function account_url($path = \u0026#39;\u0026#39;, ?string $host = null): string { if (empty($host)) { return site_url($path); } // Convert array of segments to a string if (is_array($path)) { $path = implode(\u0026#39;/\u0026#39;, $path); } return (string) new SiteURI(config(App::class), $path, $host); } For posterity, I also leave the original version, which no longer works (probably since the release of version 4.4 of the framework). But everything else remains the same.\n// app/Helpers/app_helper.php /** * Returns a site URL as defined by Host. * * @param string|array $path URI string * @param string|null $host Host to use */ function account_url($path = \u0026#39;\u0026#39;, ?string $host = null): string { // Convert array of segments to a string if (is_array($path)) { $path = implode(\u0026#39;/\u0026#39;, $path); } if (empty($host)) { return site_url($path); } $uri = _get_uri($path); $uri-\u0026gt;setHost($host); return URI::createURIString($uri-\u0026gt;getScheme(), $uri-\u0026gt;getAuthority(), $uri-\u0026gt;getPath(), $uri-\u0026gt;getQuery(), $uri-\u0026gt;getFragment()); } Now we can use our helper function like this:\nhelper(\u0026#39;app\u0026#39;); account_url(\u0026#39;controller/method\u0026#39;, \u0026#39;host.tld\u0026#39;); So basically this helper will work the same as site_url, but it will handle an additional parameter that will define our custom domain.\n","permalink":"https://michalsn.dev/posts/generating-a-custom-domain-links-in-codeigniter-4/","summary":"\u003cp\u003eHow can we handle generation of a custom domain link in CodeIgniter 4? Although this is not a built-in feature, we can deal with it in a fairly simple way.\u003c/p\u003e","title":"Generating a custom domain link in CodeIgniter 4"},{"content":"Serverless has been very popular for several years now. When we need very high performance it can be a very good alternative to traditional server solutions. Therefore, this time we will try to run CodeIgniter 4 in a serverless environment.\nInstallation The first thing to do is to install the Serverless framework (if you don\u0026rsquo;t already have it). You can read how to do that here: https://bref.sh/docs/installation.html\nFollow all the steps from the \u0026ldquo;Serverless\u0026rdquo; section and come back here.\nIf we already have the Serverless Framework installed and an AWS account configured, we can move on. Let\u0026rsquo;s create a sample project in CodeIgniter 4:\ncomposer create-project codeigniter4/appstarter serverless-ci4 Inside our project, let\u0026rsquo;s install bref, which will allow us to easily run our PHP project on Lambda function.\ncomposer require bref/bref Let\u0026rsquo;s initiate the project.\nvendor/bin/bref init And select the 0 option when asked about the type of apllication.\nConfiguration First things first. We should adjust the serverless.yaml file to our needs:\nservice: serverless-codeigniter4 provider: name: aws region: eu-central-1 runtime: provided.al2 memorySize: 512 plugins: - ./vendor/bref/bref functions: api: handler: public/index.php # point us to the CodeIgniter\u0026#39;s index.php file description: \u0026#39;\u0026#39; timeout: 28 # in seconds (API Gateway has a timeout of 29 seconds) layers: - ${bref:layer.php-81-fpm} events: - httpApi: \u0026#39;*\u0026#39; # Exclude files from deployment package: patterns: - \u0026#39;!node_modules/**\u0026#39; - \u0026#39;!tests/**\u0026#39; Now we can move on. CodeIgniter 4 requires the Intl extension. By default, this extension is disabled, so we need to enable it. To do this, we need to create a php.ini file that will be loaded when the instance is launched.\nIn the root directory of our project, let\u0026rsquo;s create the following path/file: php/conf.d/php.ini with the contents:\nextension=intl Let\u0026rsquo;s move on to CodeIgniter\u0026rsquo;s configuration settings, because there are a few things we need to change. Let\u0026rsquo;s create a copy of the env file under the name .env. Now let\u0026rsquo;s edit the value for CI_ENVIRONMENT and few others.\nCI_ENVIRONMENT = development app.indexPage = \u0026#39;\u0026#39; app.uriProtocol = \u0026#39;PATH_INFO\u0026#39;; We change the CI_ENVIRONMENT just in case something goes wrong, so we can see the errors. Later we will go back to the production value. The change for the uriProtocol is necessary so the Lambda could recognize our routing.\nNext, we need to overwrite the paths for the session (if we will use it) and cache files. In the following example we assume that we use a file handler for both the session and cache files.\n// app/Config/Registrar.php namespace App\\Config; use RuntimeException; class Registrar { public static function App() { $isLambda = isset($_SERVER[\u0026#39;LAMBDA_TASK_ROOT\u0026#39;]); if ($isLambda) { $sessionPathDir = \u0026#39;/tmp/session\u0026#39;; if (! is_dir($sessionPathDir)) { if (! mkdir($sessionPathDir, 0755, true) \u0026amp;\u0026amp; ! is_dir($sessionPathDir)) { throw new RuntimeException(sprintf(\u0026#39;Directory \u0026#34;%s\u0026#34; cannot be created\u0026#39;, $sessionPathDir)); } } return [ \u0026#39;sessionSavePath\u0026#39; =\u0026gt; $sessionPathDir, ]; } return []; } public static function Cache() { $isLambda = isset($_SERVER[\u0026#39;LAMBDA_TASK_ROOT\u0026#39;]); if ($isLambda) { $cachePathDir = \u0026#39;/tmp/cache\u0026#39;; if (! is_dir($cachePathDir)) { if (! mkdir($cachePathDir, 0755, true) \u0026amp;\u0026amp; ! is_dir($cachePathDir)) { throw new RuntimeException(sprintf(\u0026#39;Directory \u0026#34;%s\u0026#34; cannot be created\u0026#39;, $cachePathDir)); } } return [ \u0026#39;file\u0026#39; =\u0026gt; [ \u0026#39;storePath\u0026#39; =\u0026gt; $cachePathDir ], ]; } return []; } } The last point will be to change the logging method so that the logs are available in CloudWatch. To do this, we will install a simple extension that will replace our default logger.\ncomposer require bref/logger Let\u0026rsquo;s edit the Services.php file to start using the new logger.\n// app/Config/Services.php namespace Config; use CodeIgniter\\Config\\BaseService; use Bref\\Logger\\StderrLogger; class Services extends BaseService { /** * The Logger class is a PSR-3 compatible Logging class that supports * multiple handlers that process the actual logging. * * @return StderrLogger */ public static function logger(bool $getShared = true) { if ($getShared) { return static::getSharedInstance(\u0026#39;logger\u0026#39;); } return new StderrLogger(); } } We can now upload our project. The first time deploy may take about 2 minutes.\nserverless deploy After navigating to the address that will be displayed to us in the console, we should see the standard landing page of CodeIgniter 4.\nThe last thing we should do is to update the CI_ENVIRONMENT and baseURL variables in the .env file:\nCI_ENVIRONMENT = production app.baseURL = \u0026#39;https://out-instance-number.execute-api.eu-central-1.amazonaws.com\u0026#39; The value for baseURL should be the value displayed to us after deployment in the console.\nNow we should call serverless deploy one more time and we are all set.\nOf course, usually we won\u0026rsquo;t be serving entire websites, but rather providing an API. But if we come to run a full-fledged website, we should remember not to serve the static files through the Lambda function.\nFortunately, there are built-in solutions for this. I encourage you to study the documentation: https://bref.sh/docs/.\nThat would be it. We have a CodeIgniter 4 application served through the Lambda function - in other words: Serverless CodeIgniter 4.\n","permalink":"https://michalsn.dev/posts/serverless-codeigniter-4/","summary":"\u003cp\u003eServerless has been very popular for several years now. When we need very high performance it can be a very good alternative to traditional server solutions. Therefore, this time we will try to run CodeIgniter 4 in a serverless environment.\u003c/p\u003e","title":"Serverless Codeigniter 4"},{"content":"When we give users option to connect their own domain to our service, we must also check that the DNS record has the correct CNAME settings before we approve such a domain.\nWe can use a simple helper that will do the verification:\n/** * Verify CNAME for domain * * @param string $host * * @return bool */ function verifyCname(string $host): bool { $result = false; $records = dns_get_record($host, DNS_CNAME); foreach ($records as $row) { if ($row[\u0026#39;type\u0026#39;] === \u0026#39;CNAME\u0026#39;) { if ($row[\u0026#39;host\u0026#39;] === $host \u0026amp;\u0026amp; $row[\u0026#39;target\u0026#39;] === \u0026#39;add your valid cname record value here\u0026#39;) { $result = true; } else { return false; } } } return $result; } It would be good to verify beforehand that the hostname given by the user is correct, or at least has a chance to be correct. For this purpose, we can use the list of available domains:\nhttps://github.com/incognico/list-of-top-level-domains With the right choice of verification, we will be able to weed out domains that are clearly not valid or simply cannot exist.\n","permalink":"https://michalsn.dev/posts/verify-cname-for-domain/","summary":"\u003cp\u003eWhen we give users option to connect their own domain to our service, we must also check that the DNS record has the correct \u003ccode\u003eCNAME\u003c/code\u003e settings before we approve such a domain.\u003c/p\u003e","title":"Verification of CNAME record for custom domain"},{"content":"What if we want every user in our application to have his data served through his own subdomain? I will show you how to do it in CodeIgniter 4 framework.\nThe assumptions are as follows - we have 2 domains:\nprimary domain on which users will be managed and subdomains, on which the application for each user will run In short, this is one of the concepts that are often used by SaaS applications.\nThis can be achieved quite easily. However, when working with CodeIgniter 4 you have to remember that variables defined in .env file have priority over all other changes you try to make while the framework is running.\nWith this in mind - the first thing we will do is to drop the app.baseURL variable from the .env file so that we can dynamically change this value. This variable is not active by default but you may be used to use it.\nFirst things first - we have to edit the app/Config/App.php file and add two variables:\n/** * -------------------------------------------------------------------------- * Subdomain URL * -------------------------------------------------------------------------- * * Subdomain address for accounts in the system. * * @var string */ public $subdomainURL = \u0026#39;\u0026#39;; /** * -------------------------------------------------------------------------- * Account ID * -------------------------------------------------------------------------- * * Account ID (or empty string for main domain name). * Value \u0026#39;404\u0026#39; means that domain/subdomain is not registered in the system. * * @var string */ public $accountID = \u0026#39;\u0026#39;; We will now override the subdomainURL variable in the .env file and add our own variable for baseURL:\nbaseURL = \u0026#39;application.test\u0026#39; // yes, this is correct - we don\u0026#39;t want to use app.baseURL app.subdomainURL = \u0026#39;.application.test\u0026#39; If we use separate variables for the primary domain and subdomain address, our system will become more flexible as it will be able to use different domains for subdomains.\nThe next thing will be to create some form of subdomain creation for each user. I will not go into that here, but I will mention just one thing. It is important to validate subdomain names properly, so that they generate valid URLs.\nIf you keep the subdomain names in the database, then after each change you will have to update the cache in which you will keep informations about subdomains. Let\u0026rsquo;s make an example model method:\npublic function updateSubdomainCache() { $results = $this-\u0026gt;builder()-\u0026gt;select(\u0026#39;account_id, subdomain\u0026#39;)-\u0026gt;get()-\u0026gt;getResult(); $subdomain = config(\u0026#39;App\u0026#39;)-\u0026gt;subdomainURL); $data = []; foreach ($results as $row) { $data[$row-\u0026gt;subdomain . $subdomain] = $row-\u0026gt;account_id; } cache()-\u0026gt;save(\u0026#39;subdomains\u0026#39;, $data, 0); } Now that we have almost everything we need, we can move on to overriding baseURL address and make it work for subdomains. We are going to use Config/Registrar class which you can read more about here:\nnamespace App\\Config; class Registrar { public static function App() { if (! is_cli()) { if (! $subdomains = cache(\u0026#39;subdomains\u0026#39;)) { $subdomains = []; } $subdomains[env(\u0026#39;baseURL\u0026#39;)] = \u0026#39;\u0026#39;; if (isset($subdomains[$_SERVER[\u0026#39;SERVER_NAME\u0026#39;]])) { return [ \u0026#39;baseURL\u0026#39; =\u0026gt; sprintf(\u0026#39;https://%s/\u0026#39;, $_SERVER[\u0026#39;SERVER_NAME\u0026#39;]), \u0026#39;accountID\u0026#39; =\u0026gt; $subdomains[$_SERVER[\u0026#39;SERVER_NAME\u0026#39;]] ]; } } return [ \u0026#39;baseURL\u0026#39; =\u0026gt; sprintf(\u0026#39;https://%s/\u0026#39;, env(\u0026#39;baseURL\u0026#39;)), \u0026#39;accountID\u0026#39; =\u0026gt; \u0026#39;404\u0026#39; ]; } } Finally, we need to define routing. The primary domain and subdomains will be distinguished using the hostname resolution trick:\n// subdomains routes $routes-\u0026gt;group(\u0026#39;\u0026#39;, [], function ($routes) { }); // main domain routes $routes-\u0026gt;group(\u0026#39;\u0026#39;, [\u0026#39;hostname\u0026#39; =\u0026gt; env(\u0026#39;baseURL\u0026#39;)], function ($routes) { }); This way we set the correct application address and additionally the account ID, which will allow us to form correct queries to the database right away.\n","permalink":"https://michalsn.dev/posts/setting-dynamic-subdomains-for-every-user-account/","summary":"\u003cp\u003eWhat if we want every user in our application to have his data served through his own subdomain? I will show you how to do it in CodeIgniter 4 framework.\u003c/p\u003e","title":"Setting dynamic subdomains for every user account"},{"content":"I recently had to use a query with INSERT ON DUPLICATE KEY UPDATE, but CodeIgniter 4 does not have built-in support for this type of query because it is not available in all database drivers.\nSince version 4.3.0 there is a upsert() method that adds support for the described function to the core of the framework. You can read more about it in the user guide.\nTo start with a basic question - why not use a query with REPLACE? There are several reasons:\nIf we are dealing with a table that has a field with AUTO INCREMENT, it is then incremented every time. If we have some foreign key relations with ON DELETE CASCADE option, then this it gonna be a mess, because we will automatically delete data from other tables The last reason is the slowness of queries with REPLACE. Each time we try to perform INSERT, if the data is already there, we perform DELETE operation and then another INSERT. The INSERT ON DUPLICATE KEY UPDATE query comes to the rescue. It is a remedy for all the above problems.\nOkay, let\u0026rsquo;s see how we can add support for this type of query to CodeIgniter 4. We will create a Trait class:\n// app/Traits/ExtraModelMethods.php namespace App\\Traits; use CodeIgniter\\Database\\Exceptions\\DataException; use InvalidArgumentException; use ReflectionException; use stdClass; trait ExtraModelMethods { /** * Insert on duplicate key update * * @param array|object $data Data * @param bool $escape Escape * @throws ReflectionException */ public function insertOnDuplicateUpdate($data, ?bool $escape = null): bool { if (! empty($data)) { $data = $this-\u0026gt;transformAllDataToArray($data, \u0026#39;update\u0026#39;); } // Validate data before saving. if (! $this-\u0026gt;skipValidation \u0026amp;\u0026amp; ! $this-\u0026gt;cleanRules(true)-\u0026gt;validate($data)) { return false; } // Must be called first so we don\u0026#39;t // strip out updated_at values. $data = $this-\u0026gt;doProtectFields($data); // doProtectFields() can further remove elements from // $data so we need to check for empty dataset again if (empty($data)) { throw DataException::forEmptyDataset(\u0026#39;update\u0026#39;); } // Set created_at and updated_at with same time $date = $this-\u0026gt;setDate(); if ($this-\u0026gt;useTimestamps \u0026amp;\u0026amp; $this-\u0026gt;createdField \u0026amp;\u0026amp; ! array_key_exists($this-\u0026gt;createdField, $data)) { $data[$this-\u0026gt;createdField] = $date; } if ($this-\u0026gt;useTimestamps \u0026amp;\u0026amp; $this-\u0026gt;updatedField) { $data[$this-\u0026gt;updatedField] = $date; } $builder = $this-\u0026gt;builder(); $insert = $builder-\u0026gt;set($data, \u0026#39;\u0026#39;, $escape)-\u0026gt;getCompiledInsert(); // Remove created_at field in case of update query if ($data[$this-\u0026gt;createdField]) { unset($data[$this-\u0026gt;createdField]); } $update = $builder-\u0026gt;set($data, \u0026#39;\u0026#39;, $escape)-\u0026gt;getCompiledUpdate(); $update = preg_replace(\u0026#39;/UPDATE[\\s\\S]+? SET /\u0026#39;, \u0026#39;\u0026#39;, $update); // Prepare event $eventData = [ \u0026#39;id\u0026#39; =\u0026gt; $this-\u0026gt;getIdValue($data), \u0026#39;data\u0026#39; =\u0026gt; $data, \u0026#39;result\u0026#39; =\u0026gt; $builder-\u0026gt;db()-\u0026gt;query(sprintf(\u0026#39;%s ON DUPLICATE KEY UPDATE %s\u0026#39;, $insert, $update)), ]; if ($this-\u0026gt;tempAllowCallbacks) { $this-\u0026gt;trigger(\u0026#39;afterUpdate\u0026#39;, $eventData); } $this-\u0026gt;tempAllowCallbacks = $this-\u0026gt;allowCallbacks; return $eventData[\u0026#39;result\u0026#39;]; } /** * Transform data to array * * @param array|object|null $data Data * @param string $type Type of data (insert|update) * * @throws DataException * @throws InvalidArgumentException * @throws ReflectionException */ protected function transformAllDataToArray($data, string $type): array { if (! in_array($type, [\u0026#39;insert\u0026#39;, \u0026#39;update\u0026#39;], true)) { throw new InvalidArgumentException(sprintf(\u0026#39;Invalid type \u0026#34;%s\u0026#34; used upon transforming data to array.\u0026#39;, $type)); } if (empty($data)) { throw DataException::forEmptyDataset($type); } // If $data is using a custom class with public or protected // properties representing the collection elements, we need to grab // them as an array. if (is_object($data) \u0026amp;\u0026amp; ! $data instanceof stdClass) { $data = $this-\u0026gt;objectToArray($data, false, true); } // If it\u0026#39;s still a stdClass, go ahead and convert to // an array so doProtectFields and other model methods // don\u0026#39;t have to do special checks. if (is_object($data)) { $data = (array) $data; } // If it\u0026#39;s still empty here, means $data is no change or is empty object if (empty($data)) { throw DataException::forEmptyDataset($type); } return $data; } } To use the new method in our model we just need to import our Trait class:\n// app/Models/ProfileModel.php namespace App\\Models; use App\\Traits\\ExtraModelMethods; use CodeIgniter\\Model; class ProfileModel extends Model { use ExtraModelMethods; protected $table = \u0026#39;profile_table\u0026#39;; ... } Let\u0026rsquo;s create an example migration file to test this. In console we type:\nphp spark make:migration AddProfileTable And then inside our migration file we will create table with the unique identifier.\n// app/Database/Migrations/2021-10-15-101102_AddProfileTable.php namespace App\\Database\\Migrations; use CodeIgniter\\Database\\Migration; class AddProfileTable extends Migration { public function up() { $this-\u0026gt;forge-\u0026gt;addField([ \u0026#39;id\u0026#39; =\u0026gt; [ \u0026#39;type\u0026#39; =\u0026gt; \u0026#39;INT\u0026#39;, \u0026#39;constraint\u0026#39; =\u0026gt; \u0026#39;11\u0026#39;, \u0026#39;unsigned\u0026#39; =\u0026gt; true, \u0026#39;null\u0026#39; =\u0026gt; false, \u0026#39;auto_increment\u0026#39; =\u0026gt; true, ], \u0026#39;user_id\u0026#39; =\u0026gt; [ \u0026#39;type\u0026#39; =\u0026gt; \u0026#39;INT\u0026#39;, \u0026#39;constraint\u0026#39; =\u0026gt; \u0026#39;11\u0026#39;, \u0026#39;unsigned\u0026#39; =\u0026gt; true, \u0026#39;null\u0026#39; =\u0026gt; false, ], \u0026#39;name\u0026#39; =\u0026gt; [ \u0026#39;type\u0026#39; =\u0026gt; \u0026#39;VARCHAR\u0026#39;, \u0026#39;constraint\u0026#39; =\u0026gt; \u0026#39;128\u0026#39;, \u0026#39;null\u0026#39; =\u0026gt; true, ], \u0026#39;created_at\u0026#39; =\u0026gt; [ \u0026#39;type\u0026#39; =\u0026gt; \u0026#39;DATETIME\u0026#39;, \u0026#39;null\u0026#39; =\u0026gt; false, ], \u0026#39;updated_at\u0026#39; =\u0026gt; [ \u0026#39;type\u0026#39; =\u0026gt; \u0026#39;DATETIME\u0026#39;, \u0026#39;null\u0026#39; =\u0026gt; false, ], ]); $this-\u0026gt;forge-\u0026gt;addKey(\u0026#39;id\u0026#39;, true); $this-\u0026gt;forge-\u0026gt;addUniqueKey(\u0026#39;user_id\u0026#39;); $this-\u0026gt;forge-\u0026gt;createTable(\u0026#39;profile_table\u0026#39;); } public function down() { $this-\u0026gt;forge-\u0026gt;dropTable(\u0026#39;profile_table\u0026#39;); } } Now, we can test it out in our controller. Let\u0026rsquo;s edit Home controller by adding new methods:\n// app/Controllers/Home.php namespace App\\Controllers; use App\\Models\\ProfileModel; class Home extends BaseController { public function index() { return view(\u0026#39;welcome_message\u0026#39;); } public function add() { $profileModel = model(ProfileModel::class); $profileModel-\u0026gt;insertOnDuplicateUpdate([ \u0026#39;user_id\u0026#39; =\u0026gt; 1, \u0026#39;name\u0026#39; =\u0026gt; \u0026#39;James\u0026#39;, ]); } public function edit() { $profileModel = model(ProfileModel::class); $profileModel-\u0026gt;insertOnDuplicateUpdate([ \u0026#39;user_id\u0026#39; =\u0026gt; 1, \u0026#39;name\u0026#39; =\u0026gt; \u0026#39;Frank\u0026#39;, ]); } } After calling the add() method, we should have one entry in the table with the name \u0026ldquo;James\u0026rdquo;. After calling the edit() method, we should still have one entry in the table, but this time with the name \u0026ldquo;Frank\u0026rdquo;.\nBecause the user_id column is unique, new data is added only if the value for this column is unique. Otherwise, the data is updated.\n","permalink":"https://michalsn.dev/posts/insert-on-duplicate-key-update-with-codeigniter-4/","summary":"\u003cp\u003eI recently had to use a query with \u003cstrong\u003eINSERT ON DUPLICATE KEY UPDATE\u003c/strong\u003e, but CodeIgniter 4 does not have built-in support for this type of query because it is not available in all database drivers.\u003c/p\u003e","title":"INSERT ON DUPLICATE KEY UPDATE with CodeIgniter 4"},{"content":"Last time I showed you how to easily integrate Mix with CodeIgniter 4. This time we\u0026rsquo;ll complete the integration process by implementing a helper which will make using versioned assets very convenient and easy.\nWhy do we even need this helper? Mix can generate versioned versions of files. In short, it does this by adding a special string to the file name, as a query string. This string is the checksum for the file. If it changes, it tells the browser that it needs to download the resource again, not use the cache.\nWe need to create a file mix_helper.php in app/helpers/ directory:\nif (! function_exists(\u0026#39;mix\u0026#39;)) { /** * Get the path to a versioned Mix file. * * @param string $path * @param string $manifestDirectory * * @return string * * @throws Exception */ function mix(string $path, string $manifestDirectory = \u0026#39;\u0026#39;): string { static $manifests = []; $publicPath = ROOTPATH . \u0026#39;public\u0026#39;; if ($path[0] !== \u0026#39;/\u0026#39;) { $path = \u0026#34;/{$path}\u0026#34;; } if ($manifestDirectory \u0026amp;\u0026amp; $manifestDirectory[0] !== \u0026#39;/\u0026#39;) { $manifestDirectory = \u0026#34;/{$manifestDirectory}\u0026#34;; } if (is_file($publicPath . $manifestDirectory . \u0026#39;/hot\u0026#39;)) { $url = rtrim(file_get_contents($publicPath . $manifestDirectory . \u0026#39;/hot\u0026#39;)); $customUrl = config(\u0026#39;Mix\u0026#39;)-\u0026gt;hotProxyUrl; if (! empty($customUrl)) { return $customUrl . $path; } if (strpos($url , \u0026#39;http://\u0026#39;) === 0 || strpos($url , \u0026#39;https://\u0026#39;) === 0) { return explode(\u0026#39;:\u0026#39;, $url, 2)[1] . $path; } return \u0026#34;//localhost:8080{$path}\u0026#34;; } $manifestPath = $publicPath . $manifestDirectory . \u0026#39;/mix-manifest.json\u0026#39;; if (! isset($manifests[$manifestPath])) { if (! is_file($manifestPath)) { throw new Exception(\u0026#39;The Mix manifest does not exist.\u0026#39;); } $manifests[$manifestPath] = json_decode(file_get_contents($manifestPath), true); } $manifest = $manifests[$manifestPath]; if (! isset($manifest[$path])) { $exception = new Exception(\u0026#34;Unable to locate Mix file: {$path}.\u0026#34;); if (! CI_DEBUG) { return $path; } else { throw $exception; } } return config(\u0026#39;Mix\u0026#39;)-\u0026gt;url . $manifestDirectory . $manifest[$path]; } } Next, we create the Mix.php configuration file in the app/config/ directory:\nnamespace Config; use CodeIgniter\\Config\\BaseConfig; class Mix extends BaseConfig { /** * Url for CDN. * Leave empty if using local files. * * @var string */ public $url = \u0026#39;\u0026#39;; /** * Hot reload Url. * Leave empty for default localhost:8080. * * @var string */ public $hotProxyUrl = \u0026#39;\u0026#39;; } There is a good chance that you won\u0026rsquo;t need to change anything in the configuration file, because you will only be using local resources, but you can change a few settings if you need to.\nHow to use this helper? It\u0026rsquo;s very simple - just enter an ordinary file name and helper will add appropriate query string, based on mix-manifest.json file generated during asset compilation.\nThis is what our asset configuration file will look like (webpack.mix.js):\nlet mix = require(\u0026#39;laravel-mix\u0026#39;); mix.js(\u0026#39;resources/js/app.js\u0026#39;, \u0026#39;js\u0026#39;) .postCss(\u0026#39;resources/css/app.css\u0026#39;, \u0026#39;css\u0026#39;) .version() .setPublicPath(\u0026#39;public\u0026#39;); And in our view we will apply a helper:\n\u0026lt;link href=\u0026#34;\u0026lt;?= mix(\u0026#39;/css/app.css\u0026#39;); ?\u0026gt;\u0026#34; rel=\u0026#34;stylesheet\u0026#34;\u0026gt; This will get a link similar to this one:\n\u0026lt;link href=\u0026#34;/css/app.css?id=a8b3deb4b7d26dcf51d2\u0026#34; rel=\u0026#34;stylesheet\u0026#34;\u0026gt; The same for JS files. Without the helper we would have to manually rename the versioned files every time.\n","permalink":"https://michalsn.dev/posts/codeigniter-4-mix-versioning/","summary":"\u003cp\u003eLast time I showed you how to easily integrate Mix with CodeIgniter 4. This time we\u0026rsquo;ll complete the integration process by implementing a helper which will make using versioned assets very convenient and easy.\u003c/p\u003e","title":"CodeIgniter 4 + Mix with versioning"},{"content":"Today we are going to look at configuring CodeIgniter 4 in conjunction with Mix. Mix is one of the components that comes with the Laravel framework.\nThe first thing we do is install CodeIgniter 4 using the command:\ncomposer create-project codeigniter4/appstarter codeigniter-mix --no-dev Next, we need to add Mix, which is basically an overlay of webpack. Basically, it would be enough to initialize Mix this way:\nnpm init -y npm install laravel-mix --save-dev But instead, I will provide the contents of the entire package.json file:\n{ \u0026#34;private\u0026#34;: true, \u0026#34;scripts\u0026#34;: { \u0026#34;dev\u0026#34;: \u0026#34;npm run development\u0026#34;, \u0026#34;development\u0026#34;: \u0026#34;mix\u0026#34;, \u0026#34;watch\u0026#34;: \u0026#34;mix watch\u0026#34;, \u0026#34;watch-poll\u0026#34;: \u0026#34;mix watch -- --watch-options-poll=1000\u0026#34;, \u0026#34;hot\u0026#34;: \u0026#34;mix watch --hot\u0026#34;, \u0026#34;prod\u0026#34;: \u0026#34;npm run production\u0026#34;, \u0026#34;production\u0026#34;: \u0026#34;mix --production\u0026#34; }, \u0026#34;devDependencies\u0026#34;: { \u0026#34;axios\u0026#34;: \u0026#34;^0.21\u0026#34;, \u0026#34;laravel-mix\u0026#34;: \u0026#34;^6.0.6\u0026#34;, \u0026#34;lodash\u0026#34;: \u0026#34;^4.17.19\u0026#34;, \u0026#34;postcss\u0026#34;: \u0026#34;^8.1.14\u0026#34; } } This file must be initialized via the command:\nnpm install All the necessary components will be installed. All that remains is to create the webpack.mix.js file, which will allow us to define the various steps when compiling the JS and CSS files.\nlet mix = require(\u0026#39;laravel-mix\u0026#39;); mix.js(\u0026#39;resources/js/app.js\u0026#39;, \u0026#39;js\u0026#39;) .postCss(\u0026#39;resources/css/app.css\u0026#39;, \u0026#39;css\u0026#39;, [ // ]) .setPublicPath(\u0026#39;public\u0026#39;); Now we need to take care of the proper folder structure. In the main directory, where CodeIgniter is located, we create resources directory. Our JS and CSS files will be located there - in js and css directories respectively.\nIn the js directory, we create the bootstrap.js file with the following content:\nwindow._ = require(\u0026#39;lodash\u0026#39;); window.axios = require(\u0026#39;axios\u0026#39;); window.axios.defaults.headers.common[\u0026#39;X-Requested-With\u0026#39;] = \u0026#39;XMLHttpRequest\u0026#39;; And then the app.js file, with the contents:\nrequire(\u0026#39;./bootstrap\u0026#39;); The whole thing should look more or less like this:\n/public /js - app.js /css - app.css /resources /js - app.js - bootstrap.js /css - app.css Now we can compile everything using the command:\nnpx mix or for the production version:\nnpx mix -p ","permalink":"https://michalsn.dev/posts/codeigniter-4-mix/","summary":"\u003cp\u003eToday we are going to look at configuring CodeIgniter 4 in conjunction with \u003ca href=\"https://laravel.com/docs/8.x/mix\"\u003eMix\u003c/a\u003e. Mix is one of the components that comes with the Laravel framework.\u003c/p\u003e","title":"CodeIgniter 4 + Mix"},{"content":"Integration with Auth0 is quite simple and comes down to a few steps. I assume you already have your Auth0 account so you just need to install the library via Composer:\ncomposer require auth0/auth0-php \u0026#34;^7.9\u0026#34; To get started, we need to create a configuration file app/Config/Auth0.php. It is a good idea to leave the configuration values in the file empty and add them via the .env file. This will ensure that your sensitive data doesn\u0026rsquo;t end up in the repository.\nnamespace Config; use CodeIgniter\\Config\\BaseConfig; class Auth0 extends BaseConfig { public $domain = \u0026#39;your domain\u0026#39;; public $clientId = \u0026#39;your client id\u0026#39;; public $clientSecret = \u0026#39;your client secret\u0026#39;; public $redirectUri = \u0026#39;redirect url\u0026#39;; public $scope = \u0026#39;scope\u0026#39;; } Next, we\u0026rsquo;ll create the main class that will allow Auth0 to write data to the session. To do this, we will implement the interface provided by Auth0. We need to create a file: app/Libraries/Auth0SessionStorage:\nnamespace App\\Libraries; use Auth0\\SDK\\Store\\StoreInterface; class Auth0SessionStore implements StoreInterface { /** * Session object * * @var \\CodeIgniter\\Session\\Session; */ protected $session; /** * Session variable prefix * * @var string */ protected $prefix = \u0026#39;auth0_\u0026#39;; /** * CodeIgniterSessionStore constructor. */ public function __construct() { $this-\u0026gt;session = service(\u0026#39;session\u0026#39;); } /** * Persists $value on $_SESSION, identified by $key. * * @param string $key Session key to set. * @param mixed $value Value to use. * * @return void */ public function set(string $key, $value): void { $this-\u0026gt;session-\u0026gt;set($this-\u0026gt;prefix . $key, $value); } /** * Gets persisted values identified by $key. * If the value is not set, returns $default. * * @param string $key Session key to set. * @param mixed $default Default to return if nothing was found. * * @return mixed */ public function get(string $key, $default = null) { return $this-\u0026gt;session-\u0026gt;get($this-\u0026gt;prefix . $key) ?? $default; } /** * Removes a persisted value identified by $key. * * @param string $key Session key to delete. * * @return void */ public function delete(string $key): void { $this-\u0026gt;session-\u0026gt;remove($this-\u0026gt;prefix . $key); } } The last step is to create a service to handle everything conveniently. Let\u0026rsquo;s edit app/Config/Services.php file:\nnamespace Config; use Auth0\\SDK\\Auth0; use Auth0\\SDK\\Exception\\CoreException; use App\\Libraries\\Auth0SessionStore; use Config\\Services as BaseService; class Services extends BaseService { /** * The Auth0 service. * * @param boolean $getShared * * @return Auth0 * @throws CoreException */ public static function auth0(bool $getShared = true) { if ($getShared) { return static::getSharedInstance(\u0026#39;auth0\u0026#39;); } $config = config(\u0026#39;Auth0\u0026#39;); $config = [ \u0026#39;domain\u0026#39; =\u0026gt; $config-\u0026gt;domain, \u0026#39;client_id\u0026#39; =\u0026gt; $config-\u0026gt;clientId, \u0026#39;client_secret\u0026#39; =\u0026gt; $config-\u0026gt;clientSecret, \u0026#39;redirect_uri\u0026#39; =\u0026gt; $config-\u0026gt;redirectUri, \u0026#39;scope\u0026#39; =\u0026gt; $config-\u0026gt;scope, \u0026#39;store\u0026#39; =\u0026gt; new Auth0SessionStore(), ]; return new Auth0($config); } } All that\u0026rsquo;s left is to test the whole thing and create a controller app/Controllers/Auth.php.\nnamespace App\\Controllers; class Auth extends BaseController { public function callback() { return view(\u0026#39;auth\u0026#39;, [\u0026#39;user\u0026#39; =\u0026gt; service(\u0026#39;auth0\u0026#39;)-\u0026gt;getUser()]); } public function login() { service(\u0026#39;auth0\u0026#39;)-\u0026gt;login(); } public function logout() { $config = config(\u0026#39;auth0\u0026#39;); service(\u0026#39;auth0\u0026#39;)-\u0026gt;logout(); $logoutUrl = sprintf(\u0026#39;https://%s/v2/logout?client_id=%s\u0026amp;returnTo=%s\u0026#39;, $config-\u0026gt;domain, $config-\u0026gt;clientId, site_url()); $this-\u0026gt;response-\u0026gt;setHeader(\u0026#39;Location\u0026#39;, $logoutUrl); } } And then there\u0026rsquo;s the app/Views/auth.php view:\n\u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;title\u0026gt;Auth0 Sample\u0026lt;/title\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;?php if ($user): ?\u0026gt; \u0026lt;h1\u0026gt;\u0026lt;?= $user[\u0026#39;name\u0026#39;]; ?\u0026gt;\u0026lt;/h1\u0026gt; \u0026lt;p\u0026gt;\u0026lt;a href=\u0026#34;\u0026lt;?= site_url(\u0026#39;auth/logout\u0026#39;); ?\u0026gt;\u0026#34;\u0026gt;Logout\u0026lt;/a\u0026gt;\u0026lt;/p\u0026gt; \u0026lt;?php else: ?\u0026gt; \u0026lt;p\u0026gt;\u0026lt;a href=\u0026#34;\u0026lt;?= site_url(\u0026#39;auth/login\u0026#39;); ?\u0026gt;\u0026#34;\u0026gt;Login\u0026lt;/a\u0026gt;\u0026lt;/p\u0026gt; \u0026lt;?php endif; ?\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; ","permalink":"https://michalsn.dev/posts/integrating-codeigniter-4-with-auth0/","summary":"\u003cp\u003eIntegration with \u003ca href=\"https://auth0.com/\"\u003eAuth0\u003c/a\u003e is quite simple and comes down to a few steps. I assume you already have your Auth0 account so you just need to install the library via \u003ca href=\"https://getcomposer.org/\"\u003eComposer\u003c/a\u003e:\u003c/p\u003e","title":"Integrating CodeIgniter 4 with Auth0"},{"content":"Uploading files directly to S3 requires a few changes to the way Dropzone handles uploads, but it\u0026rsquo;s nothing particularly difficult.\nWhat we will need?\nDropzone.js SparkMD5 CodeIgniter 4 AWS SDK for PHP Let\u0026rsquo;s start by initializing Dropzone - the key method here is transformFile, which will make us get a presigned URL.\nconst baseUrl = \u0026#39;\u0026lt;?= base_url(); ?\u0026gt;\u0026#39;; myDropzone = new Dropzone(\u0026#39;#myDropzone\u0026#39;, { acceptedFiles: \u0026#34;image/jpeg,image/jpg\u0026#34;, clickable: \u0026#34;.select-photos-btn\u0026#34;, maxFilesize: 100, url: \u0026#39;#\u0026#39;, method: \u0026#39;post\u0026#39;, timeout: 0, thumbnailMethod: \u0026#39;crop\u0026#39;, resizeQuality: 0.9, transformFile: async function (file, done) { file.md5 = await calculateMD5(file); let initData = await initUpload(file.name, file.type, file.md5); file.presign = initData.presign; file.fileName = initData.name; done(file); } }); Let\u0026rsquo;s take a look at the calculateMD5 function. We need it to be sure that the uploaded file was uploaded correctly - it\u0026rsquo;s our checksum.\nfunction calculateMD5(blob) { return new Promise(function (resolve, reject) { let reader = new FileReader(); reader.readAsBinaryString(blob); reader.onloadend = function () { let hash = btoa(SparkMD5.hashBinary(reader.result, true)); resolve(hash); }; }); } Once we have calculated the checksum, we can initiate the file upload:\nfunction initUpload(name, contentType, md5) { return new Promise(function (resolve, reject) { $.ajax({ url: baseUrl + \u0026#39;home/init_upload\u0026#39;, data: {\u0026#39;file\u0026#39;: name, \u0026#39;content_type\u0026#39;: contentType, \u0026#39;md5\u0026#39;: md5}, headers: {\u0026#39;X-Requested-With\u0026#39;: \u0026#39;XMLHttpRequest\u0026#39;}, type: \u0026#39;POST\u0026#39; }) .done(function (respond) { if (respond.status) { resolve(respond.data); } else { reject() } }) .fail(function () { reject() }); }); } It\u0026rsquo;s time for the server part. For this, we need to install CodeIgniter 4 and the AWS library:\ncomposer create-project codeigniter4/appstarter codeigniter-dropzonejs --no-dev composer require aws/aws-sdk-php In the Home controller, we need to create a init_upload method. This method will be quite large. We could avoid it, for example, by creating a special Service to handle tasks related to S3, but because the example is to be as basic as possible, we will put everything in one place:\nuse App\\Controllers\\BaseController; use Aws\\S3\\PostObjectV4; use Aws\\S3\\S3Client; use CodeIgniter\\Exceptions\\PageNotFoundException; class Home extends BaseController { ... public function init_upload() { if (! $this-\u0026gt;request-\u0026gt;isAjax()) { throw new PageNotFoundException(); } if ($this-\u0026gt;request-\u0026gt;getMethod() !== \u0026#39;post\u0026#39;) { throw new PageNotFoundException(); } if (! $file = $this-\u0026gt;request-\u0026gt;getPost(\u0026#39;file\u0026#39;)) { throw new PageNotFoundException(); } if (! $contentType = $this-\u0026gt;request-\u0026gt;getPost(\u0026#39;content_type\u0026#39;)) { throw new PageNotFoundException(); } if (! $md5 = $this-\u0026gt;request-\u0026gt;getPost(\u0026#39;md5\u0026#39;)) { throw new PageNotFoundException(); } if (! in_array($contentType, [\u0026#39;image/jpeg\u0026#39;, \u0026#39;image/jpg\u0026#39;])) { throw new PageNotFoundException(); } $file = service(\u0026#39;security\u0026#39;)-\u0026gt;sanitizeFilename($file); $client = new S3Client([ \u0026#39;version\u0026#39; =\u0026gt; \u0026#39;latest\u0026#39;, \u0026#39;region\u0026#39; =\u0026gt; \u0026#39;type your S3 region here\u0026#39;, \u0026#39;signature\u0026#39; =\u0026gt; \u0026#39;v4\u0026#39;, \u0026#39;credentials\u0026#39; =\u0026gt; [ \u0026#39;key\u0026#39; =\u0026gt; \u0026#39;type your aws key here\u0026#39;, \u0026#39;secret\u0026#39; =\u0026gt; \u0026#39;type your aws secret here\u0026#39;, ], ]); $bucket = \u0026#39;type your bucket name here\u0026#39;; $formInputs = [ \u0026#39;acl\u0026#39; =\u0026gt; \u0026#39;private\u0026#39;, \u0026#39;key\u0026#39; =\u0026gt; $file, \u0026#39;success_action_status\u0026#39; =\u0026gt; \u0026#39;201\u0026#39;, \u0026#39;content-md5\u0026#39; =\u0026gt; $md5, \u0026#39;content-type\u0026#39; =\u0026gt; $contentType, ]; $options = [ [\u0026#39;acl\u0026#39; =\u0026gt; \u0026#39;private\u0026#39;], [\u0026#39;bucket\u0026#39; =\u0026gt; $bucket], [\u0026#39;success_action_status\u0026#39; =\u0026gt; \u0026#39;201\u0026#39;], [\u0026#39;content-md5\u0026#39; =\u0026gt; $md5], [\u0026#39;content-type\u0026#39; =\u0026gt; $contentType], [\u0026#39;content-length-range\u0026#39;, 0, 1024 * 1024 * 100], [\u0026#39;starts-with\u0026#39;, \u0026#39;$key\u0026#39;, $file], ]; $postObject = new PostObjectV4( $client, $bucket, $formInputs, $options, \u0026#39;+15 minutes\u0026#39; ); $formAttributes = $postObject-\u0026gt;getFormAttributes(); $formInputs = $postObject-\u0026gt;getFormInputs(); return $this-\u0026gt;response-\u0026gt;setJSON([ \u0026#39;status\u0026#39; =\u0026gt; 1, \u0026#39;data\u0026#39; =\u0026gt; [ \u0026#39;name\u0026#39; =\u0026gt; $file, \u0026#39;presign\u0026#39; =\u0026gt; [ \u0026#39;attributes\u0026#39; =\u0026gt; $attributes, \u0026#39;inputs\u0026#39; =\u0026gt; $inputs ] ] ]); } } Once we have the presigned URL generated, we need to force Dropzone to use it when uploading the file. We also need to include additional fields and attributes that will describe the exact file we are uploading. We do it this way:\nmyDropzone.on(\u0026#34;sending\u0026#34;, function (file, xhr, formData) { xhr.open(this.options.method, file.presign.attributes.action, true); Object.keys(file.presign.inputs).forEach(function (key) { formData.append(key, file.presign.inputs[key]); }); let _send = xhr.send xhr.send = function () { _send.call(xhr, formData) } }); All that remains now is to handle the success or failure of the upload. In the case of success, we need to change the final name of the file, which may have changed if the name contained forbidden characters:\nmyDropzone.on(\u0026#34;success\u0026#34;, function (file) { let elem = $(file.previewElement); elem.find(\u0026#39;div[data-dz-name]\u0026#39;).text(file.fileName); }); If an error is returned, we should also display an appropriate message. For this purpose, we need to parse the XML response:\nmyDropzone.on(\u0026#34;error\u0026#34;, function (file, message) { if (file \u0026amp;\u0026amp; message) { if (message.startsWith(\u0026#39;\u0026lt;?xml version\u0026#39;)) { const search = /\u0026lt;Message\u0026gt;(.*?)\u0026lt;\\/Message\u0026gt;/g.exec(message); message = search[1]; this.emit(\u0026#34;error\u0026#34;, file, message); } } }); This way we can prepare a special upload link and upload the file to S3 using Dropzone.js. Then, S3 will verify the integrity of the file and check that it has the correct parameters that were specified when the special signed URL was generated.\n","permalink":"https://michalsn.dev/posts/upload-files-directly-to-s3-with-dropzonejs-and-codeigniter-4/","summary":"\u003cp\u003eUploading files directly to S3 requires a few changes to the way Dropzone handles uploads, but it\u0026rsquo;s nothing particularly difficult.\u003c/p\u003e","title":"Upload files directly to S3 with Dropzone.js"},{"content":"Up until now, working with UUIDs and CodeIgniter 4 hasn\u0026rsquo;t been much fun, but that has now changed with the codeigniter4-uuid library.\nAdmittedly, working with UUID was not a big challenge when we were working with the Model class, but in order to do it \u0026ldquo;nicely\u0026rdquo;, we had to use Model Events. Everything would be fine until our application itself would not need to use Model Events. Then it would be a mess, because we would have to add UUID support to our existing Events code.\nThat is why a special library was created, which extends Model class and gives possibility to work with UUID. No matter if we want to store identifiers as text or bytes - everything is handled automatically.\nInstallation via composer:\ncomposer require michalsn/codeigniter4-uuid Then the only change we need to make is in the Model:\nnamespace App\\Models; use Michalsn\\Uuid\\UuidModel; class MyModel extends UuidModel { ... } This is enough to use UUIDs automatically for the primary key.\n","permalink":"https://michalsn.dev/posts/uuid-with-codeigniter-4/","summary":"\u003cp\u003eUp until now, working with UUIDs and CodeIgniter 4 hasn\u0026rsquo;t been much fun, but that has now changed with the \u003ca href=\"https://github.com/michalsn/codeigniter4-uuid\"\u003ecodeigniter4-uuid\u003c/a\u003e library.\u003c/p\u003e","title":"UUID with CodeIgniter 4"},{"content":"Here are some of my personal open source projects that I’m currently working on or have worked on in the past.\nCodeIgniter HTMX An integration of HTMX with CodeIgniter 4, this library simplifies building dynamic and interactive front-end features without the need for complex JavaScript frameworks. It enables developers to use HTMX’s powerful AJAX capabilities directly in CodeIgniter, providing a smoother and more efficient user experience.\nCodeIgniter Signed URL This package adds secure, signed URL support to CodeIgniter 4. It allows developers to generate and verify URL signatures, ensuring data integrity and secure access to routes and resources, which is essential for sensitive or time-bound links.\nCodeIgniter Tags CodeIgniter Tags is a versatile tagging library that adds robust tagging functionality to CodeIgniter 4 applications. It’s ideal for categorizing content dynamically, making it simple to organize and filter data by tags, providing a richer user and admin experience.\nCodeIgniter Markdown Pages This project enables Markdown support for content management within CodeIgniter 4, based on files rather than a database. With MarkdownPages, you can create and manage Markdown-based pages easily, making it a practical solution for blogs, documentation, and content-heavy applications.\nCodeIgniter Queue The CodeIgniter Queue library introduces queueing functionality to CodeIgniter 4 applications. This is ideal for handling resource-intensive processes, enhancing the performance and responsiveness of your application. I am thrilled that this project has finally come under the wings of the CodeIgniter Foundation.\nCodeIgniter Nested Model A powerful extension for CodeIgniter 4 model system that allows working with nested or related models more conveniently. It streamlines the loading, saving, and updating of related data structures, making it easier to manage complex entities and their relationships with minimal boilerplate code.\nCodeIgniter Translatable This library provides a flexible way to handle translations in CodeIgniter 4 models. It enables multilingual support by linking translated fields to related tables, making it easy to build multilingual applications with clean separation between core data and localized content.\n","permalink":"https://michalsn.dev/projects/","summary":"\u003cp\u003eHere are some of my personal open source projects that I’m currently working on or have worked on in the past.\u003c/p\u003e\n\u003ch3 id=\"codeigniter-htmx\"\u003e\u003ca href=\"https://github.com/michalsn/codeigniter-htmx\"\u003eCodeIgniter HTMX\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003eAn integration of HTMX with CodeIgniter 4, this library simplifies building dynamic and interactive front-end features without the need for complex JavaScript frameworks. It enables developers to use HTMX’s powerful AJAX capabilities directly in CodeIgniter, providing a smoother and more efficient user experience.\u003c/p\u003e\n\u003ch3 id=\"codeigniter-signed-url\"\u003e\u003ca href=\"https://github.com/michalsn/codeigniter-signed-url\"\u003eCodeIgniter Signed URL\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003eThis package adds secure, signed URL support to CodeIgniter 4. It allows developers to generate and verify URL signatures, ensuring data integrity and secure access to routes and resources, which is essential for sensitive or time-bound links.\u003c/p\u003e","title":"Open Source"}]