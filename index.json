[{"content":"When we give users option to connect their own domain to our service, we must also check that the DNS record has the correct CNAME settings before we approve such a domain.\nWe can use a simple helper that will do the verification:\n/** * Verify CNAME for domain * * @param string $host * * @return bool */ function verifyCname(string $host): bool { $result = false; $records = dns_get_record($host, DNS_CNAME); foreach ($records as $row) { if ($row[\u0026#39;type\u0026#39;] === \u0026#39;CNAME\u0026#39;) { if ($row[\u0026#39;host\u0026#39;] === $host \u0026amp;\u0026amp; $row[\u0026#39;target\u0026#39;] === \u0026#39;add your valid cname record value here\u0026#39;) { $result = true; } else { return false; } } } return $result; } It would be good to verify beforehand that the hostname given by the user is correct, or at least has a chance to be correct. For this purpose, we can use the list of available domains:\nhttps://github.com/incognico/list-of-top-level-domains With the right choice of verification, we will be able to weed out domains that are clearly not valid or simply cannot exist.\n","permalink":"https://michalsn.dev/posts/verify-cname-for-domain/","summary":"\u003cp\u003eWhen we give users option to connect their own domain to our service, we must also check that the DNS record has the correct \u003ccode\u003eCNAME\u003c/code\u003e settings before we approve such a domain.\u003c/p\u003e","title":"Verification of CNAME record for custom domain"},{"content":"What if we want every user in our application to have his data served through his own subdomain? I will show you how to do it in CodeIgniter 4 framework.\nThe assumptions are as follows - we have 2 domains:\nprimary domain on which users will be managed and subdomains, on which the application for each user will run In short, this is one of the concepts that are often used by SaaS applications.\nThis can be achieved quite easily. However, when working with CodeIgniter 4 you have to remember that variables defined in .env file have priority over all other changes you try to make while the framework is running.\nWith this in mind - the first thing we will do is to drop the app.baseURL variable from the .env file so that we can dynamically change this value. This variable is not active by default but you may be used to use it.\nFirst things first - we have to edit the app/Config/App.php file and add two variables:\n/** * -------------------------------------------------------------------------- * Subdomain URL * -------------------------------------------------------------------------- * * Subdomain address for accounts in the system. * * @var string */ public $subdomainURL = \u0026#39;\u0026#39;; /** * -------------------------------------------------------------------------- * Account ID * -------------------------------------------------------------------------- * * Account ID (or empty string for main domain name). * Value \u0026#39;404\u0026#39; means that domain/subdomain is not registered in the system. * * @var string */ public $accountID = \u0026#39;\u0026#39;; We will now override the subdomainURL variable in the .env file and add our own variable for baseURL:\nbaseURL = \u0026#39;application.test\u0026#39; // yes, this is correct - we don\u0026#39;t want to use app.baseURL app.subdomainURL = \u0026#39;.application.test\u0026#39; If we use separate variables for the primary domain and subdomain address, our system will become more flexible as it will be able to use different domains for subdomains.\nThe next thing will be to create some form of subdomain creation for each user. I will not go into that here, but I will mention just one thing. It is important to validate subdomain names properly, so that they generate valid URLs.\nIf you keep the subdomain names in the database, then after each change you will have to update the cache in which you will keep informations about subdomains. Let\u0026rsquo;s make an example model method:\npublic function updateSubdomainCache() { $results = $this-\u0026gt;builder()-\u0026gt;select(\u0026#39;account_id, subdomain\u0026#39;)-\u0026gt;get()-\u0026gt;getResult(); $subdomain = config(\u0026#39;App\u0026#39;)-\u0026gt;subdomainURL); $data = []; foreach ($results as $row) { $data[$row-\u0026gt;subdomain . $subdomain] = $row-\u0026gt;account_id; } cache()-\u0026gt;save(\u0026#39;subdomains\u0026#39;, $data, 0); } Now that we have almost everything we need, we can move on to overriding baseURL address and make it work for subdomains. We are going to use Config/Registrar class which you can read more about here:\nnamespace App\\Config; class Registrar { public static function App() { if (! is_cli()) { if (! $subdomains = cache(\u0026#39;subdomains\u0026#39;)) { $subdomains = []; } $subdomains[env(\u0026#39;baseURL\u0026#39;)] = \u0026#39;\u0026#39;; if (isset($subdomains[$_SERVER[\u0026#39;SERVER_NAME\u0026#39;]])) { return [ \u0026#39;baseURL\u0026#39; =\u0026gt; sprintf(\u0026#39;https://%s/\u0026#39;, $_SERVER[\u0026#39;SERVER_NAME\u0026#39;]), \u0026#39;accountID\u0026#39; =\u0026gt; $subdomains[$_SERVER[\u0026#39;SERVER_NAME\u0026#39;]] ]; } } return [ \u0026#39;baseURL\u0026#39; =\u0026gt; sprintf(\u0026#39;https://%s/\u0026#39;, env(\u0026#39;baseURL\u0026#39;)), \u0026#39;accountID\u0026#39; =\u0026gt; \u0026#39;404\u0026#39; ]; } } Finally, we need to define routing. The primary domain and subdomains will be distinguished using the hostname resolution trick:\n// subdomains routes $routes-\u0026gt;group(\u0026#39;\u0026#39;, [], function ($routes) { }); // main domain routes $routes-\u0026gt;group(\u0026#39;\u0026#39;, [\u0026#39;hostname\u0026#39; =\u0026gt; env(\u0026#39;baseURL\u0026#39;)], function ($routes) { }); This way we set the correct application address and additionally the account ID, which will allow us to form correct queries to the database right away.\n","permalink":"https://michalsn.dev/posts/setting-dynamic-subdomains-for-every-user-account/","summary":"\u003cp\u003eWhat if we want every user in our application to have his data served through his own subdomain? I will show you how to do it in CodeIgniter 4 framework.\u003c/p\u003e","title":"Setting dynamic subdomains for every user account"},{"content":"I recently had to use a query with INSERT ON DUPLICATE KEY UPDATE, but CodeIgniter 4 does not have built-in support for this type of query because it is not available in all database drivers.\nTo start with a basic question - why not use a query with REPLACE? There are several reasons:\nIf we are dealing with a table that has a field with AUTO INCREMENT, it is then incremented every time. If we have some foreign key relations with ON DELETE CASCADE option, then this it gonna be a mess, because we will automatically delete data from other tables The last reason is the slowness of queries with REPLACE. Each time we try to perform INSERT, if the data is already there, we perform DELETE operation and then another INSERT. The INSERT ON DUPLICATE KEY UPDATE query comes to the rescue. It is a remedy for all the above problems.\nOkay, let\u0026rsquo;s see how we can add support for this type of query to CodeIgniter 4. We will create a Trait class:\n// app/Traits/ExtraModelMethods.php namespace App\\Traits; use CodeIgniter\\Database\\Exceptions\\DataException; use InvalidArgumentException; use ReflectionException; use stdClass; trait ExtraModelMethods { /** * Insert on duplicate key update * * @param array|object $data Data * @param bool $escape Escape * @throws ReflectionException */ public function insertOnDuplicateUpdate($data, ?bool $escape = null): bool { if (! empty($data)) { $data = $this-\u0026gt;transformAllDataToArray($data, \u0026#39;update\u0026#39;); } // Validate data before saving. if (! $this-\u0026gt;skipValidation \u0026amp;\u0026amp; ! $this-\u0026gt;cleanRules(true)-\u0026gt;validate($data)) { return false; } // Must be called first so we don\u0026#39;t // strip out updated_at values. $data = $this-\u0026gt;doProtectFields($data); // doProtectFields() can further remove elements from // $data so we need to check for empty dataset again if (empty($data)) { throw DataException::forEmptyDataset(\u0026#39;update\u0026#39;); } // Set created_at and updated_at with same time $date = $this-\u0026gt;setDate(); if ($this-\u0026gt;useTimestamps \u0026amp;\u0026amp; $this-\u0026gt;createdField \u0026amp;\u0026amp; ! array_key_exists($this-\u0026gt;createdField, $data)) { $data[$this-\u0026gt;createdField] = $date; } if ($this-\u0026gt;useTimestamps \u0026amp;\u0026amp; $this-\u0026gt;updatedField) { $data[$this-\u0026gt;updatedField] = $date; } $builder = $this-\u0026gt;builder(); $insert = $builder-\u0026gt;set($data, \u0026#39;\u0026#39;, $escape)-\u0026gt;getCompiledInsert(); // Remove created_at field in case of update query if ($data[$this-\u0026gt;createdField]) { unset($data[$this-\u0026gt;createdField]); } $update = $builder-\u0026gt;set($data, \u0026#39;\u0026#39;, $escape)-\u0026gt;getCompiledUpdate(); $update = preg_replace(\u0026#39;/UPDATE[\\s\\S]+? SET /\u0026#39;, \u0026#39;\u0026#39;, $update); // Prepare event $eventData = [ \u0026#39;id\u0026#39; =\u0026gt; $this-\u0026gt;getIdValue($data), \u0026#39;data\u0026#39; =\u0026gt; $data, \u0026#39;result\u0026#39; =\u0026gt; $builder-\u0026gt;db()-\u0026gt;query(sprintf(\u0026#39;%s ON DUPLICATE KEY UPDATE %s\u0026#39;, $insert, $update)), ]; if ($this-\u0026gt;tempAllowCallbacks) { $this-\u0026gt;trigger(\u0026#39;afterUpdate\u0026#39;, $eventData); } $this-\u0026gt;tempAllowCallbacks = $this-\u0026gt;allowCallbacks; return $eventData[\u0026#39;result\u0026#39;]; } /** * Transform data to array * * @param array|object|null $data Data * @param string $type Type of data (insert|update) * * @throws DataException * @throws InvalidArgumentException * @throws ReflectionException */ protected function transformAllDataToArray($data, string $type): array { if (! in_array($type, [\u0026#39;insert\u0026#39;, \u0026#39;update\u0026#39;], true)) { throw new InvalidArgumentException(sprintf(\u0026#39;Invalid type \u0026#34;%s\u0026#34; used upon transforming data to array.\u0026#39;, $type)); } if (empty($data)) { throw DataException::forEmptyDataset($type); } // If $data is using a custom class with public or protected // properties representing the collection elements, we need to grab // them as an array. if (is_object($data) \u0026amp;\u0026amp; ! $data instanceof stdClass) { $data = $this-\u0026gt;objectToArray($data, false, true); } // If it\u0026#39;s still a stdClass, go ahead and convert to // an array so doProtectFields and other model methods // don\u0026#39;t have to do special checks. if (is_object($data)) { $data = (array) $data; } // If it\u0026#39;s still empty here, means $data is no change or is empty object if (empty($data)) { throw DataException::forEmptyDataset($type); } return $data; } } To use the new method in our model we just need to import our Trait class:\n// app/Models/ProfileModel.php namespace App\\Models; use App\\Traits\\ExtraModelMethods; use CodeIgniter\\Model; class ProfileModel extends Model { use ExtraModelMethods; protected $table = \u0026#39;profile_table\u0026#39;; ... } Let\u0026rsquo;s create an example migration file to test this. In console we type:\nphp spark make:migration AddProfileTable And then inside our migration file we will create table with the unique identifier.\n// app/Database/Migrations/2021-10-15-101102_AddProfileTable.php namespace App\\Database\\Migrations; use CodeIgniter\\Database\\Migration; class AddProfileTable extends Migration { public function up() { $this-\u0026gt;forge-\u0026gt;addField([ \u0026#39;id\u0026#39; =\u0026gt; [ \u0026#39;type\u0026#39; =\u0026gt; \u0026#39;INT\u0026#39;, \u0026#39;constraint\u0026#39; =\u0026gt; \u0026#39;11\u0026#39;, \u0026#39;unsigned\u0026#39; =\u0026gt; true, \u0026#39;null\u0026#39; =\u0026gt; false, \u0026#39;auto_increment\u0026#39; =\u0026gt; true, ], \u0026#39;user_id\u0026#39; =\u0026gt; [ \u0026#39;type\u0026#39; =\u0026gt; \u0026#39;INT\u0026#39;, \u0026#39;constraint\u0026#39; =\u0026gt; \u0026#39;11\u0026#39;, \u0026#39;unsigned\u0026#39; =\u0026gt; true, \u0026#39;null\u0026#39; =\u0026gt; false, ], \u0026#39;name\u0026#39; =\u0026gt; [ \u0026#39;type\u0026#39; =\u0026gt; \u0026#39;VARCHAR\u0026#39;, \u0026#39;constraint\u0026#39; =\u0026gt; \u0026#39;128\u0026#39;, \u0026#39;null\u0026#39; =\u0026gt; true, ], \u0026#39;created_at\u0026#39; =\u0026gt; [ \u0026#39;type\u0026#39; =\u0026gt; \u0026#39;DATETIME\u0026#39;, \u0026#39;null\u0026#39; =\u0026gt; false, ], \u0026#39;updated_at\u0026#39; =\u0026gt; [ \u0026#39;type\u0026#39; =\u0026gt; \u0026#39;DATETIME\u0026#39;, \u0026#39;null\u0026#39; =\u0026gt; false, ], ]); $this-\u0026gt;forge-\u0026gt;addKey(\u0026#39;id\u0026#39;, true); $this-\u0026gt;forge-\u0026gt;addUniqueKey(\u0026#39;user_id\u0026#39;); $this-\u0026gt;forge-\u0026gt;createTable(\u0026#39;profile_table\u0026#39;); } public function down() { $this-\u0026gt;forge-\u0026gt;dropTable(\u0026#39;profile_table\u0026#39;); } } Now, we can test it out in our controller. Let\u0026rsquo;s edit Home controller by adding new methods:\n// app/Controllers/Home.php namespace App\\Controllers; use App\\Models\\ProfileModel; class Home extends BaseController { public function index() { return view(\u0026#39;welcome_message\u0026#39;); } public function add() { $profileModel = model(ProfileModel::class); $profileModel-\u0026gt;insertOnDuplicateUpdate([ \u0026#39;user_id\u0026#39; =\u0026gt; 1, \u0026#39;name\u0026#39; =\u0026gt; \u0026#39;James\u0026#39;, ]); } public function edit() { $profileModel = model(ProfileModel::class); $profileModel-\u0026gt;insertOnDuplicateUpdate([ \u0026#39;user_id\u0026#39; =\u0026gt; 1, \u0026#39;name\u0026#39; =\u0026gt; \u0026#39;Frank\u0026#39;, ]); } } After calling the add() method, we should have an entry in the table with one entry and name \u0026ldquo;James\u0026rdquo;. After calling the edit() method, we should still have one entry in the table, but this time with the name \u0026ldquo;Frank\u0026rdquo;.\nBecause the user_id column is unique, new data is added only if the value for this column is unique, otherwise the data is updated.\n","permalink":"https://michalsn.dev/posts/insert-on-duplicate-key-update-with-codeigniter-4/","summary":"\u003cp\u003eI recently had to use a query with \u003cstrong\u003eINSERT ON DUPLICATE KEY UPDATE\u003c/strong\u003e, but CodeIgniter 4 does not have built-in support for this type of query because it is not available in all database drivers.\u003c/p\u003e","title":"INSERT ON DUPLICATE KEY UPDATE with CodeIgniter 4"},{"content":"Last time I showed you how to easily integrate Mix with CodeIgniter 4. This time we\u0026rsquo;ll complete the integration process by implementing a helper which will make using versioned assets very convenient and easy.\nWhy do we even need this helper? Mix can generate versioned versions of files. In short, it does this by adding a special string to the file name, as a query string. This string is the checksum for the file. If it changes, it tells the browser that it needs to download the resource again, not use the cache.\nWe need to create a file mix_helper.php in app/helpers/ directory:\nif (! function_exists(\u0026#39;mix\u0026#39;)) { /** * Get the path to a versioned Mix file. * * @param string $path * @param string $manifestDirectory * * @return string * * @throws Exception */ function mix(string $path, string $manifestDirectory = \u0026#39;\u0026#39;): string { static $manifests = []; $publicPath = ROOTPATH . \u0026#39;public\u0026#39;; if ($path[0] !== \u0026#39;/\u0026#39;) { $path = \u0026#34;/{$path}\u0026#34;; } if ($manifestDirectory \u0026amp;\u0026amp; $manifestDirectory[0] !== \u0026#39;/\u0026#39;) { $manifestDirectory = \u0026#34;/{$manifestDirectory}\u0026#34;; } if (is_file($publicPath . $manifestDirectory . \u0026#39;/hot\u0026#39;)) { $url = rtrim(file_get_contents($publicPath . $manifestDirectory . \u0026#39;/hot\u0026#39;)); $customUrl = config(\u0026#39;Mix\u0026#39;)-\u0026gt;hotProxyUrl; if (! empty($customUrl)) { return $customUrl . $path; } if (strpos($url , \u0026#39;http://\u0026#39;) === 0 || strpos($url , \u0026#39;https://\u0026#39;) === 0) { return explode(\u0026#39;:\u0026#39;, $url, 2)[1] . $path; } return \u0026#34;//localhost:8080{$path}\u0026#34;; } $manifestPath = $publicPath . $manifestDirectory . \u0026#39;/mix-manifest.json\u0026#39;; if (! isset($manifests[$manifestPath])) { if (! is_file($manifestPath)) { throw new Exception(\u0026#39;The Mix manifest does not exist.\u0026#39;); } $manifests[$manifestPath] = json_decode(file_get_contents($manifestPath), true); } $manifest = $manifests[$manifestPath]; if (! isset($manifest[$path])) { $exception = new Exception(\u0026#34;Unable to locate Mix file: {$path}.\u0026#34;); if (! CI_DEBUG) { return $path; } else { throw $exception; } } return config(\u0026#39;Mix\u0026#39;)-\u0026gt;url . $manifestDirectory . $manifest[$path]; } } Next, we create the Mix.php configuration file in the app/config/ directory:\nnamespace Config; use CodeIgniter\\Config\\BaseConfig; class Mix extends BaseConfig { /** * Url for CDN. * Leave empty if using local files. * * @var string */ public $url = \u0026#39;\u0026#39;; /** * Hot reload Url. * Leave empty for default localhost:8080. * * @var string */ public $hotProxyUrl = \u0026#39;\u0026#39;; } There is a good chance that you won\u0026rsquo;t need to change anything in the configuration file, because you will only be using local resources, but you can change a few settings if you need to.\nHow to use this helper? It\u0026rsquo;s very simple - just enter an ordinary file name and helper will add appropriate query string, based on mix-manifest.json file generated during asset compilation.\nThis is what our asset configuration file will look like (webpack.mix.js):\nlet mix = require(\u0026#39;laravel-mix\u0026#39;); mix.js(\u0026#39;resources/js/app.js\u0026#39;, \u0026#39;js\u0026#39;) .postCss(\u0026#39;resources/css/app.css\u0026#39;, \u0026#39;css\u0026#39;) .version() .setPublicPath(\u0026#39;public\u0026#39;); And in our view we will apply a helper:\n\u0026lt;link href=\u0026#34;\u0026lt;?= mix(\u0026#39;/css/app.css\u0026#39;); ?\u0026gt;\u0026#34; rel=\u0026#34;stylesheet\u0026#34;\u0026gt; This will get a link similar to this one:\n\u0026lt;link href=\u0026#34;/css/app.css?id=a8b3deb4b7d26dcf51d2\u0026#34; rel=\u0026#34;stylesheet\u0026#34;\u0026gt; The same for JS files. Without the helper we would have to manually rename the versioned files every time.\n","permalink":"https://michalsn.dev/posts/codeigniter-4-mix-versioning/","summary":"\u003cp\u003eLast time I showed you how to easily integrate Mix with CodeIgniter 4. This time we\u0026rsquo;ll complete the integration process by implementing a helper which will make using versioned assets very convenient and easy.\u003c/p\u003e","title":"CodeIgniter 4 + Mix with versioning"},{"content":"Today we are going to look at configuring CodeIgniter 4 in conjunction with Mix. Mix is one of the components that comes with the Laravel framework.\nThe first thing we do is install CodeIgniter 4 using the command:\ncomposer create-project codeigniter4/appstarter codeigniter-mix --no-dev Next, we need to add Mix, which is basically an overlay of webpack. Basically, it would be enough to initialize Mix this way:\nnpm init -y npm install laravel-mix --save-dev But instead, I will provide the contents of the entire package.json file:\n{ \u0026#34;private\u0026#34;: true, \u0026#34;scripts\u0026#34;: { \u0026#34;dev\u0026#34;: \u0026#34;npm run development\u0026#34;, \u0026#34;development\u0026#34;: \u0026#34;mix\u0026#34;, \u0026#34;watch\u0026#34;: \u0026#34;mix watch\u0026#34;, \u0026#34;watch-poll\u0026#34;: \u0026#34;mix watch -- --watch-options-poll=1000\u0026#34;, \u0026#34;hot\u0026#34;: \u0026#34;mix watch --hot\u0026#34;, \u0026#34;prod\u0026#34;: \u0026#34;npm run production\u0026#34;, \u0026#34;production\u0026#34;: \u0026#34;mix --production\u0026#34; }, \u0026#34;devDependencies\u0026#34;: { \u0026#34;axios\u0026#34;: \u0026#34;^0.21\u0026#34;, \u0026#34;laravel-mix\u0026#34;: \u0026#34;^6.0.6\u0026#34;, \u0026#34;lodash\u0026#34;: \u0026#34;^4.17.19\u0026#34;, \u0026#34;postcss\u0026#34;: \u0026#34;^8.1.14\u0026#34; } } This file must be initialized via the command:\nnpm install All the necessary components will be installed. All that remains is to create the webpack.mix.js file, which will allow us to define the various steps when compiling the JS and CSS files.\nlet mix = require(\u0026#39;laravel-mix\u0026#39;); mix.js(\u0026#39;resources/js/app.js\u0026#39;, \u0026#39;js\u0026#39;) .postCss(\u0026#39;resources/css/app.css\u0026#39;, \u0026#39;css\u0026#39;, [ // ]) .setPublicPath(\u0026#39;public\u0026#39;); Now we need to take care of the proper folder structure. In the main directory, where CodeIgniter is located, we create resources directory. Our JS and CSS files will be located there - in js and css directories respectively.\nIn the js directory, we create the bootstrap.js file with the following content:\nwindow._ = require(\u0026#39;lodash\u0026#39;); window.axios = require(\u0026#39;axios\u0026#39;); window.axios.defaults.headers.common[\u0026#39;X-Requested-With\u0026#39;] = \u0026#39;XMLHttpRequest\u0026#39;; And then the app.js file, with the contents:\nrequire(\u0026#39;./bootstrap\u0026#39;); The whole thing should look more or less like this:\n/public /js - app.js /css - app.css /resources /js - app.js - bootstrap.js /css - app.css Now we can compile everything using the command:\nnpx mix or for the production version:\nnpx mix -p ","permalink":"https://michalsn.dev/posts/codeigniter-4-mix/","summary":"\u003cp\u003eToday we are going to look at configuring CodeIgniter 4 in conjunction with \u003ca href=\"https://laravel.com/docs/8.x/mix\"\u003eMix\u003c/a\u003e. Mix is one of the components that comes with the Laravel framework.\u003c/p\u003e","title":"CodeIgniter 4 + Mix"},{"content":"Integration with Auth0 is quite simple and comes down to a few steps. I assume you already have your Auth0 account so you just need to install the library via Composer:\ncomposer require auth0/auth0-php \u0026#34;^7.9\u0026#34; To get started, we need to create a configuration file app/Config/Auth0.php. It is a good idea to leave the configuration values in the file empty and add them via the .env file. This will ensure that your sensitive data doesn\u0026rsquo;t end up in the repository.\nnamespace Config; use CodeIgniter\\Config\\BaseConfig; class Auth0 extends BaseConfig { public $domain = \u0026#39;your domain\u0026#39;; public $clientId = \u0026#39;your client id\u0026#39;; public $clientSecret = \u0026#39;your client secret\u0026#39;; public $redirectUri = \u0026#39;redirect url\u0026#39;; public $scope = \u0026#39;scope\u0026#39;; } Next, we\u0026rsquo;ll create the main class that will allow Auth0 to write data to the session. To do this, we will implement the interface provided by Auth0. We need to create a file: app/Libraries/Auth0SessionStorage:\nnamespace App\\Libraries; use Auth0\\SDK\\Store\\StoreInterface; class Auth0SessionStore implements StoreInterface { /** * Session object * * @var \\CodeIgniter\\Session\\Session; */ protected $session; /** * Session variable prefix * * @var string */ protected $prefix = \u0026#39;auth0_\u0026#39;; /** * CodeIgniterSessionStore constructor. */ public function __construct() { $this-\u0026gt;session = service(\u0026#39;session\u0026#39;); } /** * Persists $value on $_SESSION, identified by $key. * * @param string $key Session key to set. * @param mixed $value Value to use. * * @return void */ public function set(string $key, $value): void { $this-\u0026gt;session-\u0026gt;set($this-\u0026gt;prefix . $key, $value); } /** * Gets persisted values identified by $key. * If the value is not set, returns $default. * * @param string $key Session key to set. * @param mixed $default Default to return if nothing was found. * * @return mixed */ public function get(string $key, $default = null) { return $this-\u0026gt;session-\u0026gt;get($this-\u0026gt;prefix . $key) ?? $default; } /** * Removes a persisted value identified by $key. * * @param string $key Session key to delete. * * @return void */ public function delete(string $key): void { $this-\u0026gt;session-\u0026gt;remove($this-\u0026gt;prefix . $key); } } The last step is to create a service to handle everything conveniently. Let\u0026rsquo;s edit app/Config/Services.php file:\nnamespace Config; use Auth0\\SDK\\Auth0; use Auth0\\SDK\\Exception\\CoreException; use App\\Libraries\\Auth0SessionStore; use Config\\Services as BaseService; class Services extends BaseService { /** * The Auth0 service. * * @param boolean $getShared * * @return Auth0 * @throws CoreException */ public static function auth0(bool $getShared = true) { if ($getShared) { return static::getSharedInstance(\u0026#39;auth0\u0026#39;); } $config = config(\u0026#39;Auth0\u0026#39;); $config = [ \u0026#39;domain\u0026#39; =\u0026gt; $config-\u0026gt;domain, \u0026#39;client_id\u0026#39; =\u0026gt; $config-\u0026gt;clientId, \u0026#39;client_secret\u0026#39; =\u0026gt; $config-\u0026gt;clientSecret, \u0026#39;redirect_uri\u0026#39; =\u0026gt; $config-\u0026gt;redirectUri, \u0026#39;scope\u0026#39; =\u0026gt; $config-\u0026gt;scope, \u0026#39;store\u0026#39; =\u0026gt; new Auth0SessionStore(), ]; return new Auth0($config); } } All that\u0026rsquo;s left is to test the whole thing and create a controller app/Controllers/Auth.php.\nnamespace App\\Controllers; class Auth extends BaseController { public function callback() { return view(\u0026#39;auth\u0026#39;, [\u0026#39;user\u0026#39; =\u0026gt; service(\u0026#39;auth0\u0026#39;)-\u0026gt;getUser()]); } public function login() { service(\u0026#39;auth0\u0026#39;)-\u0026gt;login(); } public function logout() { $config = config(\u0026#39;auth0\u0026#39;); service(\u0026#39;auth0\u0026#39;)-\u0026gt;logout(); $logoutUrl = sprintf(\u0026#39;https://%s/v2/logout?client_id=%s\u0026amp;returnTo=%s\u0026#39;, $config-\u0026gt;domain, $config-\u0026gt;clientId, site_url()); $this-\u0026gt;response-\u0026gt;setHeader(\u0026#39;Location\u0026#39;, $logoutUrl); } } And then there\u0026rsquo;s the app/Views/auth.php view:\n\u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;title\u0026gt;Auth0 Sample\u0026lt;/title\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;?php if ($user): ?\u0026gt; \u0026lt;h1\u0026gt;\u0026lt;?= $user[\u0026#39;name\u0026#39;]; ?\u0026gt;\u0026lt;/h1\u0026gt; \u0026lt;p\u0026gt;\u0026lt;a href=\u0026#34;\u0026lt;?= site_url(\u0026#39;auth/logout\u0026#39;); ?\u0026gt;\u0026#34;\u0026gt;Logout\u0026lt;/a\u0026gt;\u0026lt;/p\u0026gt; \u0026lt;?php else: ?\u0026gt; \u0026lt;p\u0026gt;\u0026lt;a href=\u0026#34;\u0026lt;?= site_url(\u0026#39;auth/login\u0026#39;); ?\u0026gt;\u0026#34;\u0026gt;Login\u0026lt;/a\u0026gt;\u0026lt;/p\u0026gt; \u0026lt;?php endif; ?\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; ","permalink":"https://michalsn.dev/posts/integrating-codeigniter-4-with-auth0/","summary":"\u003cp\u003eIntegration with \u003ca href=\"https://auth0.com/\"\u003eAuth0\u003c/a\u003e is quite simple and comes down to a few steps. I assume you already have your Auth0 account so you just need to install the library via \u003ca href=\"https://getcomposer.org/\"\u003eComposer\u003c/a\u003e:\u003c/p\u003e","title":"Integrating CodeIgniter 4 with Auth0"},{"content":"Uploading files directly to S3 requires a few changes to the way Dropzone handles uploads, but it\u0026rsquo;s nothing particularly difficult.\nWhat we will need?\nDropzone.js SparkMD5 CodeIgniter 4 AWS SDK for PHP Let\u0026rsquo;s start by initializing Dropzone - the key method here is transformFile, which will make us get a presigned URL.\nconst baseUrl = \u0026#39;\u0026lt;?= base_url(); ?\u0026gt;\u0026#39;; myDropzone = new Dropzone(\u0026#39;#myDropzone\u0026#39;, { acceptedFiles: \u0026#34;image/jpeg,image/jpg\u0026#34;, clickable: \u0026#34;.select-photos-btn\u0026#34;, maxFilesize: 100, url: \u0026#39;#\u0026#39;, method: \u0026#39;post\u0026#39;, timeout: 0, thumbnailMethod: \u0026#39;crop\u0026#39;, resizeQuality: 0.9, transformFile: async function (file, done) { file.md5 = await calculateMD5(file); let initData = await initUpload(file.name, file.type, file.md5); file.presign = initData.presign; file.fileName = initData.name; done(file); } }); Let\u0026rsquo;s take a look at the calculateMD5 function. We need it to be sure that the uploaded file was uploaded correctly - it\u0026rsquo;s our checksum.\nfunction calculateMD5(blob) { return new Promise(function (resolve, reject) { let reader = new FileReader(); reader.readAsBinaryString(blob); reader.onloadend = function () { let hash = btoa(SparkMD5.hashBinary(reader.result, true)); resolve(hash); }; }); } Once we have calculated the checksum, we can initiate the file upload:\nfunction initUpload(name, contentType, md5) { return new Promise(function (resolve, reject) { $.ajax({ url: baseUrl + \u0026#39;home/init_upload\u0026#39;, data: {\u0026#39;file\u0026#39;: name, \u0026#39;content_type\u0026#39;: contentType, \u0026#39;md5\u0026#39;: md5}, headers: {\u0026#39;X-Requested-With\u0026#39;: \u0026#39;XMLHttpRequest\u0026#39;}, type: \u0026#39;POST\u0026#39; }) .done(function (respond) { if (respond.status) { resolve(respond.data); } else { reject() } }) .fail(function () { reject() }); }); } It\u0026rsquo;s time for the server part. For this, we need to install CodeIgniter 4 and the AWS library:\ncomposer create-project codeigniter4/appstarter codeigniter-dropzonejs --no-dev composer require aws/aws-sdk-php In the Home controller, we need to create a init_upload method. This method will be quite large. We could avoid it, for example, by creating a special Service to handle tasks related to S3, but because the example is to be as basic as possible, we will put everything in one place:\nuse App\\Controllers\\BaseController; use Aws\\S3\\PostObjectV4; use Aws\\S3\\S3Client; use CodeIgniter\\Exceptions\\PageNotFoundException; class Home extends BaseController { ... public function init_upload() { if (! $this-\u0026gt;request-\u0026gt;isAjax()) { throw new PageNotFoundException(); } if ($this-\u0026gt;request-\u0026gt;getMethod() !== \u0026#39;post\u0026#39;) { throw new PageNotFoundException(); } if (! $file = $this-\u0026gt;request-\u0026gt;getPost(\u0026#39;file\u0026#39;)) { throw new PageNotFoundException(); } if (! $contentType = $this-\u0026gt;request-\u0026gt;getPost(\u0026#39;content_type\u0026#39;)) { throw new PageNotFoundException(); } if (! $md5 = $this-\u0026gt;request-\u0026gt;getPost(\u0026#39;md5\u0026#39;)) { throw new PageNotFoundException(); } if (! in_array($contentType, [\u0026#39;image/jpeg\u0026#39;, \u0026#39;image/jpg\u0026#39;])) { throw new PageNotFoundException(); } $file = service(\u0026#39;security\u0026#39;)-\u0026gt;sanitizeFilename($file); $client = new S3Client([ \u0026#39;version\u0026#39; =\u0026gt; \u0026#39;latest\u0026#39;, \u0026#39;region\u0026#39; =\u0026gt; \u0026#39;type your S3 region here\u0026#39;, \u0026#39;signature\u0026#39; =\u0026gt; \u0026#39;v4\u0026#39;, \u0026#39;credentials\u0026#39; =\u0026gt; [ \u0026#39;key\u0026#39; =\u0026gt; \u0026#39;type your aws key here\u0026#39;, \u0026#39;secret\u0026#39; =\u0026gt; \u0026#39;type your aws secret here\u0026#39;, ], ]); $bucket = \u0026#39;type your bucket name here\u0026#39;; $formInputs = [ \u0026#39;acl\u0026#39; =\u0026gt; \u0026#39;private\u0026#39;, \u0026#39;key\u0026#39; =\u0026gt; $file, \u0026#39;success_action_status\u0026#39; =\u0026gt; \u0026#39;201\u0026#39;, \u0026#39;content-md5\u0026#39; =\u0026gt; $md5, \u0026#39;content-type\u0026#39; =\u0026gt; $contentType, ]; $options = [ [\u0026#39;acl\u0026#39; =\u0026gt; \u0026#39;private\u0026#39;], [\u0026#39;bucket\u0026#39; =\u0026gt; $bucket], [\u0026#39;success_action_status\u0026#39; =\u0026gt; \u0026#39;201\u0026#39;], [\u0026#39;content-md5\u0026#39; =\u0026gt; $md5], [\u0026#39;content-type\u0026#39; =\u0026gt; $contentType], [\u0026#39;content-length-range\u0026#39;, 0, 1024 * 1024 * 100], [\u0026#39;starts-with\u0026#39;, \u0026#39;$key\u0026#39;, $file], ]; $postObject = new PostObjectV4( $client, $bucket, $formInputs, $options, \u0026#39;+15 minutes\u0026#39; ); $formAttributes = $postObject-\u0026gt;getFormAttributes(); $formInputs = $postObject-\u0026gt;getFormInputs(); return $this-\u0026gt;response-\u0026gt;setJSON([ \u0026#39;status\u0026#39; =\u0026gt; 1, \u0026#39;data\u0026#39; =\u0026gt; [ \u0026#39;name\u0026#39; =\u0026gt; $file, \u0026#39;presign\u0026#39; =\u0026gt; [ \u0026#39;attributes\u0026#39; =\u0026gt; $attributes, \u0026#39;inputs\u0026#39; =\u0026gt; $inputs ] ] ]); } } Once we have the presigned URL generated, we need to force Dropzone to use it when uploading the file. We also need to include additional fields and attributes that will describe the exact file we are uploading. We do it this way:\nmyDropzone.on(\u0026#34;sending\u0026#34;, function (file, xhr, formData) { xhr.open(this.options.method, file.presign.attributes.action, true); Object.keys(file.presign.inputs).forEach(function (key) { formData.append(key, file.presign.inputs[key]); }); let _send = xhr.send xhr.send = function () { _send.call(xhr, formData) } }); All that remains now is to handle the success or failure of the upload. In the case of success, we need to change the final name of the file, which may have changed if the name contained forbidden characters:\nmyDropzone.on(\u0026#34;success\u0026#34;, function (file) { let elem = $(file.previewElement); elem.find(\u0026#39;div[data-dz-name]\u0026#39;).text(file.fileName); }); If an error is returned, we should also display an appropriate message. For this purpose, we need to parse the XML response:\nmyDropzone.on(\u0026#34;error\u0026#34;, function (file, message) { if (file \u0026amp;\u0026amp; message) { if (message.startsWith(\u0026#39;\u0026lt;?xml version\u0026#39;)) { const search = /\u0026lt;Message\u0026gt;(.*?)\u0026lt;\\/Message\u0026gt;/g.exec(message); message = search[1]; this.emit(\u0026#34;error\u0026#34;, file, message); } } }); This way we can prepare a special upload link and upload the file to S3 using Dropzone.js. Then, S3 will verify the integrity of the file and check that it has the correct parameters that were specified when the special signed URL was generated.\n","permalink":"https://michalsn.dev/posts/upload-files-directly-to-s3-with-dropzonejs-and-codeigniter-4/","summary":"\u003cp\u003eUploading files directly to S3 requires a few changes to the way Dropzone handles uploads, but it\u0026rsquo;s nothing particularly difficult.\u003c/p\u003e","title":"Upload files directly to S3 with Dropzone.js"},{"content":"Up until now, working with UUIDs and CodeIgniter 4 hasn\u0026rsquo;t been much fun, but that has now changed with the codeigniter4-uuid library.\nAdmittedly, working with UUID was not a big challenge when we were working with the Model class, but in order to do it \u0026ldquo;nicely\u0026rdquo;, we had to use Model Events. Everything would be fine until our application itself would not need to use Model Events. Then it would be a mess, because we would have to add UUID support to our existing Events code.\nThat is why a special library was created, which extends Model class and gives possibility to work with UUID. No matter if we want to store identifiers as text or bytes - everything is handled automatically.\nInstallation via composer:\ncomposer require michalsn/codeigniter4-uuid Then the only change we need to make is in the Model:\nnamespace App\\Models; use Michalsn\\Uuid\\UuidModel; class MyModel extends UuidModel { ... } This is enough to use UUIDs automatically for the primary key.\n","permalink":"https://michalsn.dev/posts/uuid-with-codeigniter-4/","summary":"\u003cp\u003eUp until now, working with UUIDs and CodeIgniter 4 hasn\u0026rsquo;t been much fun, but that has now changed with the \u003ca href=\"https://github.com/michalsn/codeigniter4-uuid\"\u003ecodeigniter4-uuid\u003c/a\u003e library.\u003c/p\u003e","title":"UUID with CodeIgniter 4"}]